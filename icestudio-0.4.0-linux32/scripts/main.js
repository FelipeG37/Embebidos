"use strict";function getCSSRule(ruleName){if(document.styleSheets)for(var i=0;i<document.styleSheets.length;i++){var styleSheet=document.styleSheets[i],ii=0,cssRule=!1;do{if((cssRule=styleSheet.cssRules?styleSheet.cssRules[ii]:styleSheet.rules[ii])&&cssRule.selectorText===ruleName)return cssRule;ii++}while(cssRule)}return!1}angular.module("icestudio",["ngRoute","ui.bootstrap","gettext"]).config(["$routeProvider",function($routeProvider){$routeProvider.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).otherwise({redirectTo:"/"})}]).run(function(profile,project,common,tools,utils,boards,collections,gettextCatalog,$timeout){$timeout(function(){$("body").addClass("waiting")},0),boards.loadBoards(),utils.loadProfile(profile,function(){collections.loadAllCollections(),utils.loadLanguage(profile,function(){""===profile.get("board")?utils.selectBoardPrompt(function(selectedBoard){var newBoard=boards.selectBoard(selectedBoard);profile.set("board",newBoard.name),alertify.success(gettextCatalog.getString("Board {{name}} selected",{name:utils.bold(newBoard.info.label)})),tools.checkToolchain()}):(profile.set("board",boards.selectBoard(profile.get("board")).name),tools.checkToolchain()),$("html").attr("lang",profile.get("language")),collections.sort(),profile.set("collection",collections.selectCollection(profile.get("collection"))),project.updateTitle(gettextCatalog.getString("Untitled")),$("body").removeClass("waiting")})})}),angular.module("icestudio").controller("DesignCtrl",function($rootScope,$scope,project,profile,graph,utils,common){function loadSelectedGraph(){var n=graph.breadcrumbs.length,opt={disabled:!0};if(1===n){var design=project.get("design");opt.disabled=!1,graph.loadDesign(design,opt,function(){$scope.isNavigating=!1}),$scope.topModule=!0}else{var type=graph.breadcrumbs[n-1].type,dependency=common.allDependencies[type];graph.loadDesign(dependency.design,opt,function(){graph.fitContent(),$scope.isNavigating=!1}),$scope.information=dependency.package}}$scope.graph=graph,$scope.common=common,$scope.profile=profile,$scope.information={},$scope.topModule=!0,$scope.isNavigating=!1,graph.createPaper($(".paper")),$scope.breadcrumbsNavitate=function(selectedItem){var item;if(!$scope.isNavigating){$scope.isNavigating=!0;do{graph.breadcrumbs.pop(),item=graph.breadcrumbs.slice(-1)[0]}while(selectedItem!==item);loadSelectedGraph()}},$scope.breadcrumbsBack=function(){$scope.isNavigating||($scope.isNavigating=!0,graph.breadcrumbs.pop(),loadSelectedGraph())},$rootScope.$on("navigateProject",function(event,args){var opt={disabled:!0};args.update?project.update({deps:!1},function(){graph.loadDesign(args.project.design,opt,function(){graph.fitContent()})}):graph.loadDesign(args.project.design,opt,function(){graph.fitContent()}),$scope.topModule=!1,$scope.information=args.project.package,utils.rootScopeSafeApply()}),$rootScope.$on("breadcrumbsBack",function(){$scope.breadcrumbsBack(),utils.rootScopeSafeApply()})}),angular.module("icestudio").controller("MainCtrl",function($scope,gettextCatalog){alertify.defaults.movable=!1,alertify.defaults.closable=!1,alertify.defaults.transition="fade",alertify.defaults.notifier.delay=3,setTimeout(function(){var labels={ok:gettextCatalog.getString("OK"),cancel:gettextCatalog.getString("Cancel")};alertify.set("alert","labels",labels),alertify.set("prompt","labels",labels),alertify.set("confirm","labels",labels)},100)}),angular.module("icestudio").controller("MenuCtrl",function($rootScope,$scope,$timeout,boards,profile,project,collections,graph,tools,utils,common,shortcuts,gettextCatalog,gui,_package,nodeFs,nodePath){function processArg(arg){if(nodeFs.existsSync(arg)){var filepath=arg;project.open(filepath)}else{var data=arg.split("x"),offset={x:parseInt(data[0]),y:parseInt(data[1])};win.moveTo(offset.x,offset.y)}}function reloadCollectionsIfRequired(filepath){var selected=common.selectedCollection.name;filepath.startsWith(common.INTERNAL_COLLECTIONS_DIR)&&collections.loadInternalCollections(),filepath.startsWith(profile.get("externalCollections"))&&collections.loadExternalCollections(),(selected&&filepath.startsWith(nodePath.join(common.INTERNAL_COLLECTIONS_DIR,selected))||filepath.startsWith(nodePath.join(profile.get("externalCollections"),selected)))&&collections.selectCollection(common.selectedCollection.path)}function exportFromCompiler(id,name,ext){checkGraph().then(function(){utils.saveDialog("#input-export-"+id,ext,function(filepath){var data=project.compile(id)[0].content;utils.saveFile(filepath,data).then(function(){alertify.success(gettextCatalog.getString("{{name}} exported",{name:name}))}).catch(function(error){alertify.error(error,30)}),updateWorkingdir(filepath)})}).catch(function(){})}function exportFromBuilder(id,name,ext){checkGraph().then(function(){return tools.buildCode()}).then(function(){resetBuildStack()}).then(function(){utils.saveDialog("#input-export-"+id,ext,function(filepath){utils.copySync(nodePath.join(common.BUILD_DIR,"hardware"+ext),filepath)&&alertify.success(gettextCatalog.getString("{{name}} exported",{name:name})),updateWorkingdir(filepath)})}).catch(function(){})}function updateWorkingdir(filepath){$scope.workingdir=utils.dirname(filepath)+utils.sep}function equalWorkingFilepath(filepath){return $scope.workingdir+project.name+".ice"===filepath}function exit(){function _exit(){win.close(!0)}project.changed?(alertify.set("confirm","labels",{ok:gettextCatalog.getString("Close")}),alertify.set("confirm","defaultFocus","cancel"),alertify.confirm(utils.bold(gettextCatalog.getString("Do you want to close the application?"))+"<br>"+gettextCatalog.getString("Your changes will be lost if you don’t save them"),function(){_exit()},function(){setTimeout(function(){alertify.set("confirm","labels",{ok:gettextCatalog.getString("OK")}),alertify.set("confirm","defaultFocus","ok")},200)})):_exit()}function removeSelected(){project.removeSelected()}function getProjectInformation(){var p=project.get("package");return[p.name,p.version,p.description,p.author,p.image]}function updateSelectedCollection(){profile.set("collection",collections.selectCollection(profile.get("collection")))}function checkGraph(){return new Promise(function(resolve,reject){graph.isEmpty()?(resultAlert&&resultAlert.dismiss(!0),resultAlert=alertify.warning(gettextCatalog.getString("Add a block to start"),5),reject()):resolve()})}function resetChangedStack(){changedUndoStack=currentUndoStack,project.changed=!1,project.updateTitle()}function resetBuildStack(){buildUndoStack=currentUndoStack,common.hasChangesSinceBuild=!1,utils.rootScopeSafeApply()}function takeSnapshot(){win.capturePage(function(img){saveSnapshot(img.replace(/^data:image\/(png|jpg|jpeg);base64,/,""))},"png")}function saveSnapshot(base64Data){utils.saveDialog("#input-save-snapshot",".png",function(filepath){nodeFs.writeFile(filepath,base64Data,"base64",function(err){if($scope.snapshotdir=utils.dirname(filepath)+utils.sep,$scope.$apply(),err)throw err;alertify.success(gettextCatalog.getString("Image {{name}} saved",{name:utils.bold(utils.basename(filepath))}))})})}function cancelTimeouts(){$timeout.cancel(timerOpen),$timeout.cancel(timerClose)}$scope.profile=profile,$scope.project=project,$scope.tools=tools,$scope.common=common,$scope.version=_package.version,$scope.toolchain=tools.toolchain,$scope.workingdir="",$scope.snapshotdir="";var zeroProject=!0,resultAlert=null,winCommandOutput=null,buildUndoStack=[],changedUndoStack=[],currentUndoStack=[],win=gui.Window.get();if(win.on("close",function(){exit()}),win.on("resize",function(){graph.fitContent()}),"darwin"===process.platform){var mb=new gui.Menu({type:"menubar"});mb.createMacBuiltin("Icestudio"),win.menu=mb}win.focus(),setTimeout(function(){var queryStr=decodeURI(window.location.search)+"&",regex=new RegExp(".*?[&\\?]icestudio_argv=(.*?)&.*"),val=queryStr.replace(regex,"$1"),params=val!==queryStr&&val;if(!1!==params){params=JSON.parse(decodeURI(params)),void 0===gui.App.argv&&(gui.App.argv=[]);for(var prop in params)gui.App.argv.push(params[prop])}var local=!1;for(var i in gui.App.argv){var arg=gui.App.argv[i];processArg(arg),local="local"===arg||local}!project.path.startsWith(common.DEFAULT_COLLECTION_DIR)&&!project.path.startsWith(common.INTERNAL_COLLECTIONS_DIR)&&project.path.startsWith(common.selectedCollection.path)||!local?updateWorkingdir(project.path):project.path=""},0),$scope.newProject=function(){utils.newWindow()},$scope.openProjectDialog=function(){utils.openDialog("#input-open-project",".ice",function(filepath){zeroProject?(updateWorkingdir(filepath),project.open(filepath)):!project.changed&&equalWorkingFilepath(filepath)||utils.newWindow(filepath)})},$scope.openProject=function(filepath){if(zeroProject){updateWorkingdir(!filepath.startsWith(common.DEFAULT_COLLECTION_DIR)&&!filepath.startsWith(common.INTERNAL_COLLECTIONS_DIR)&&filepath.startsWith(common.selectedCollection.path)?filepath:""),project.open(filepath,!0)}else utils.newWindow(filepath,!0)},$scope.saveProject=function(){var filepath=project.path;filepath?(project.save(filepath,function(){reloadCollectionsIfRequired(filepath)}),resetChangedStack()):$scope.saveProjectAs()},$scope.saveProjectAs=function(localCallback){utils.saveDialog("#input-save-project",".ice",function(filepath){updateWorkingdir(filepath),project.save(filepath,function(){reloadCollectionsIfRequired(filepath)}),resetChangedStack(),localCallback&&localCallback()})},$rootScope.$on("saveProjectAs",function(event,callback){$scope.saveProjectAs(callback)}),$scope.addAsBlock=function(){utils.openDialog("#input-add-as-block",".ice",function(filepaths){filepaths=filepaths.split(";");for(var i in filepaths)project.addBlockFile(filepaths[i],!0)})},$scope.exportVerilog=function(){exportFromCompiler("verilog","Verilog",".v")},$scope.exportPCF=function(){exportFromCompiler("pcf","PCF",".pcf")},$scope.exportTestbench=function(){exportFromCompiler("testbench","Testbench",".v")},$scope.exportGTKwave=function(){exportFromCompiler("gtkwave","GTKWave",".gtkw")},$scope.exportBLIF=function(){exportFromBuilder("blif","BLIF",".blif")},$scope.exportASC=function(){exportFromBuilder("asc","ASC",".asc")},$scope.exportBitstream=function(){exportFromBuilder("bin","Bitstream",".bin")},$scope.quit=function(){exit()},$scope.undoGraph=function(){graph.undo()},$scope.redoGraph=function(){graph.redo()},$scope.cutSelected=function(){graph.cutSelected()},$scope.copySelected=function(){graph.copySelected()};var paste=!0;$scope.pasteSelected=function(){paste&&(paste=!1,graph.pasteSelected(),setTimeout(function(){paste=!0},250))},$scope.selectAll=function(){checkGraph().then(function(){graph.selectAll()}).catch(function(){})},$scope.fitContent=function(){graph.fitContent()},$scope.setExternalCollections=function(){var externalCollections=profile.get("externalCollections"),formSpecs=[{type:"text",title:gettextCatalog.getString("Enter the external collections path"),value:externalCollections||""}];utils.renderForm(formSpecs,function(evt,values){var newExternalCollections=values[0];resultAlert&&resultAlert.dismiss(!1),newExternalCollections!==externalCollections&&(""===newExternalCollections||nodeFs.existsSync(newExternalCollections)?(profile.set("externalCollections",newExternalCollections),collections.loadExternalCollections(),collections.selectCollection(),utils.rootScopeSafeApply(),common.selectedCollection.path.startsWith(newExternalCollections),alertify.success(gettextCatalog.getString("External collections updated"))):(evt.cancel=!0,resultAlert=alertify.error(gettextCatalog.getString("Path {{path}} does not exist",{path:newExternalCollections},5))))})},$(document).on("infoChanged",function(evt,newValues){var values=getProjectInformation();_.isEqual(values,newValues)||(graph.setInfo(values,newValues,project),alertify.message(gettextCatalog.getString("Project information updated")+".<br>"+gettextCatalog.getString("Click here to view"),5).callback=function(isClicked){isClicked&&$scope.setProjectInformation()})}),$scope.setProjectInformation=function(){var values=getProjectInformation();utils.projectinfoprompt(values,function(evt,newValues){_.isEqual(values,newValues)||(graph.setInfo(values,newValues,project),alertify.success(gettextCatalog.getString("Project information updated")))})},$scope.setRemoteHostname=function(){var current=profile.get("remoteHostname");alertify.prompt(gettextCatalog.getString("Enter the remote hostname user@host"),current||"",function(evt,remoteHostname){profile.set("remoteHostname",remoteHostname)})},$scope.toggleBoardRules=function(){graph.setBoardRules(!profile.get("boardRules")),profile.get("boardRules")?alertify.success(gettextCatalog.getString("Board rules enabled")):alertify.success(gettextCatalog.getString("Board rules disabled"))},$(document).on("langChanged",function(evt,lang){$scope.selectLanguage(lang)}),$scope.selectLanguage=function(language){profile.get("language")!==language&&(profile.set("language",graph.selectLanguage(language)),project.update({deps:!1},function(){graph.loadDesign(project.get("design"),{disabled:!1})}),collections.sort())},$scope.showPCF=function(){gui.Window.open("resources/viewers/plain/pcf.html?board="+common.selectedBoard.name,{title:common.selectedBoard.info.label+" - PCF",focus:!0,toolbar:!1,resizable:!0,width:700,height:700,min_width:300,min_height:300,icon:"resources/images/icestudio-logo.png"})},$scope.showPinout=function(){var board=common.selectedBoard;nodeFs.existsSync(nodePath.join("resources","boards",board.name,"pinout.svg"))?gui.Window.open("resources/viewers/svg/pinout.html?board="+board.name,{title:common.selectedBoard.info.label+" - Pinout",focus:!0,toolbar:!1,resizable:!0,width:500,height:700,min_width:300,min_height:300,icon:"resources/images/icestudio-logo.png"}):alertify.warning(gettextCatalog.getString("{{board}} pinout not defined",{board:utils.bold(board.info.label)}),5)},$scope.showDatasheet=function(){var board=common.selectedBoard;board.info.datasheet?gui.Shell.openExternal(board.info.datasheet):alertify.error(gettextCatalog.getString("{{board}} datasheet not defined",{board:utils.bold(board.info.label)}),5)},$scope.showBoardRules=function(){var board=common.selectedBoard,rules=JSON.stringify(board.rules);"{}"!==rules?gui.Window.open("resources/viewers/table/rules.html?rules="+rules,{title:common.selectedBoard.info.label+" - Rules",focus:!0,toolbar:!1,resizable:!1,width:500,height:500,min_width:300,min_height:300,icon:"resources/images/icestudio-logo.png"}):alertify.error(gettextCatalog.getString("{{board}} rules not defined",{board:utils.bold(board.info.label)}),5)},$scope.toggleFPGAResources=function(){profile.set("showFPGAResources",!profile.get("showFPGAResources"))},$scope.showCollectionData=function(){var collection=common.selectedCollection,readme=collection.content.readme;readme?gui.Window.open("resources/viewers/markdown/readme.html?readme="+readme,{title:(collection.name?collection.name:"Default")+" Collection - Data",focus:!0,toolbar:!1,resizable:!0,width:700,height:700,min_width:300,min_height:300,icon:"resources/images/icestudio-logo.png"}):alertify.error(gettextCatalog.getString("Collection {{collection}} info not defined",{collection:utils.bold(collection.name)}),5)},$scope.showCommandOutput=function(){winCommandOutput=gui.Window.open("resources/viewers/plain/output.html?content="+encodeURIComponent(common.commandOutput),{title:gettextCatalog.getString("Command output"),focus:!0,toolbar:!1,resizable:!0,width:700,height:400,min_width:300,min_height:300,icon:"resources/images/icestudio-logo.png"})},$(document).on("commandOutputChanged",function(evt,commandOutput){if(winCommandOutput)try{winCommandOutput.window.location.href="resources/viewers/plain/output.html?content="+encodeURIComponent(commandOutput)}catch(e){winCommandOutput=null}}),$scope.selectCollection=function(collection){if(common.selectedCollection.path!==collection.path){var name=collection.name;profile.set("collection",collections.selectCollection(collection.path)),alertify.success(gettextCatalog.getString("Collection {{name}} selected",{name:utils.bold(name||"Default")}))}},$(document).on("boardChanged",function(evt,board){if(common.selectedBoard.name!==board.name){var newBoard=graph.selectBoard(board);profile.set("board",newBoard.name)}}),$scope.selectBoard=function(board){function _boardSelected(){var newBoard=graph.selectBoard(board,!0);profile.set("board",newBoard.name),alertify.success(gettextCatalog.getString("Board {{name}} selected",{name:utils.bold(newBoard.info.label)}))}common.selectedBoard.name!==board.name&&(graph.isEmpty()?_boardSelected():alertify.confirm(gettextCatalog.getString("The current FPGA I/O configuration will be lost. Do you want to change to {{name}} board?",{name:utils.bold(board.info.label)}),function(){_boardSelected()}))},$scope.verifyCode=function(){var startMessage=gettextCatalog.getString("Start verification"),endMessage=gettextCatalog.getString("Verification done");checkGraph().then(function(){return tools.verifyCode(startMessage,endMessage)}).catch(function(){})},$scope.buildCode=function(){var startMessage=gettextCatalog.getString("Start build"),endMessage=gettextCatalog.getString("Build done");checkGraph().then(function(){return tools.buildCode(startMessage,endMessage)}).then(function(){resetBuildStack()}).catch(function(){})},$scope.uploadCode=function(){var startMessage=gettextCatalog.getString("Start upload"),endMessage=gettextCatalog.getString("Upload done");checkGraph().then(function(){return tools.uploadCode(startMessage,endMessage)}).then(function(){resetBuildStack()}).catch(function(){})},$scope.addCollections=function(){utils.openDialog("#input-add-collection",".zip",function(filepaths){filepaths=filepaths.split(";"),tools.addCollections(filepaths)})},$scope.reloadCollections=function(){collections.loadAllCollections(),collections.selectCollection(common.selectedCollection.path)},$scope.removeCollection=function(collection){alertify.confirm(gettextCatalog.getString("Do you want to remove the {{name}} collection?",{name:utils.bold(collection.name)}),function(){tools.removeCollection(collection),updateSelectedCollection(),utils.rootScopeSafeApply()})},$scope.removeAllCollections=function(){common.internalCollections.length>0?alertify.confirm(gettextCatalog.getString("All stored collections will be lost. Do you want to continue?"),function(){tools.removeAllCollections(),updateSelectedCollection(),utils.rootScopeSafeApply()}):alertify.warning(gettextCatalog.getString("No collections stored"),5)},$scope.openUrl=function(url){event.preventDefault(),gui.Shell.openExternal(url)},$scope.about=function(){var content=['<div class="row">','  <div class="col-sm-4">','   <img src="resources/images/fpgawars-logo.png">',"  </div>",'  <div class="col-sm-7" style="margin-left: 20px;">',"    <h4>Icestudio</h4>","    <p><i>Visual editor for open FPGA boards</i></p>","    <p>Version: "+$scope.version+"</p>","    <p>License: GPL-2.0</p>","    <p>Created by Jesús Arroyo Torrens</p>",'    <p><span class="copyleft">&copy;</span> FPGAwars 2016-2019</p>',"  </div>","</div>"].join("\n");alertify.alert(content)},$(document).on("stackChanged",function(evt,undoStack){currentUndoStack=undoStack;var undoStackString=JSON.stringify(undoStack);project.changed=JSON.stringify(changedUndoStack)!==undoStackString,project.updateTitle(),zeroProject=!1,common.hasChangesSinceBuild=JSON.stringify(buildUndoStack)!==undoStackString,utils.rootScopeSafeApply()});var promptShown=!1;alertify.prompt().set({onshow:function(){promptShown=!0},onclose:function(){promptShown=!1}}),alertify.confirm().set({onshow:function(){promptShown=!0},onclose:function(){promptShown=!1}}),shortcuts.method("newProject",$scope.newProject),shortcuts.method("openProject",$scope.openProjectDialog),shortcuts.method("saveProject",$scope.saveProject),shortcuts.method("saveProjectAs",$scope.saveProjectAs),shortcuts.method("quit",$scope.quit),shortcuts.method("undoGraph",$scope.undoGraph),shortcuts.method("redoGraph",$scope.redoGraph),shortcuts.method("redoGraph2",$scope.redoGraph),shortcuts.method("cutSelected",$scope.cutSelected),shortcuts.method("copySelected",$scope.copySelected),shortcuts.method("pasteSelected",$scope.pasteSelected),shortcuts.method("selectAll",$scope.selectAll),shortcuts.method("fitContent",$scope.fitContent),shortcuts.method("verifyCode",$scope.verifyCode),shortcuts.method("buildCode",$scope.buildCode),shortcuts.method("uploadCode",$scope.uploadCode),shortcuts.method("stepUp",graph.stepUp),shortcuts.method("stepDown",graph.stepDown),shortcuts.method("stepLeft",graph.stepLeft),shortcuts.method("stepRight",graph.stepRight),shortcuts.method("removeSelected",removeSelected),shortcuts.method("back",function(){graph.isEnabled()?removeSelected():$rootScope.$broadcast("breadcrumbsBack")}),shortcuts.method("takeSnapshot",takeSnapshot),$(document).on("keydown",function(event){var opt={prompt:promptShown,disabled:!graph.isEnabled()};shortcuts.execute(event,opt).preventDefault&&event.preventDefault()});var menu,timerOpen,timerClose,mousedown=!1;$(document).on("mouseup",function(){mousedown=!1}),$(document).on("mousedown",".paper",function(){mousedown=!0,$scope.status[menu]=!1,utils.rootScopeSafeApply()}),$scope.showMenu=function(newMenu){cancelTimeouts(),mousedown||graph.addingDraggableBlock||$scope.status[newMenu]||(timerOpen=$timeout(function(){$scope.fixMenu(newMenu)},300))},$scope.hideMenu=function(){cancelTimeouts(),timerClose=$timeout(function(){$scope.status[menu]=!1},900)},$scope.fixMenu=function(newMenu){menu=newMenu,$scope.status[menu]=!0},$(document).click(".dropdown-submenu",function(event){$(event.target).hasClass("dropdown-toggle")&&(event.stopImmediatePropagation(),event.preventDefault())})}),angular.module("icestudio").directive("menuboard",function(){return{restrict:"E",replace:!0,scope:{type:"=",board:"="},template:'<a href ng-click="selectBoard(board)" ng-if="board.type == type">                   {{ board.info.label }}&ensp;                   <span ng-show="common.selectedBoard.name == board.name" class="glyphicon glyphicon-ok-circle"></span>                 </a>'}}),angular.module("icestudio").directive("menutree",function(){return{restrict:"E",replace:!0,scope:{data:"=",right:"=",callback:"&"},template:'<ul uib-dropdown-menu ng-show="data.length > 0"><child ng-repeat="child in data" child="child" callback="click(path)" right="right"></child></ul>',link:function(scope){scope.click=function(path){scope.callback({path:path})}}}}).directive("child",function($compile){return{restrict:"E",replace:!0,scope:{child:"=",right:"=",callback:"&"},template:"<li ng-class=\"child.children ? (right ? 'dropdown-submenu-right' : 'dropdown-submenu') : ''\" uib-dropdown>"+'<a href ng-click="click(child.path)" ng-if="!child.children">{{ child.name | translate }}</a><a href uib-dropdown-toggle ng-if="child.children">{{ child.name | translate }}</a></li>',link:function(scope,element){scope.click=function(path){scope.callback({path:path})},angular.isArray(scope.child.children)&&(element.append('<menutree data="child.children" callback="click(path)" right="right"></menutree>'),$compile(element.contents())(scope))}}}),angular.module("icestudio").factory("joint",function($window){return $window.joint}),angular.module("icestudio").factory("nodeFs",function(){return require("fs")}).factory("nodeFse",function(){return require("fs-extra")}).factory("nodeRmdir",function(){return require("rmdir")}).factory("nodeSha1",function(){return require("sha1")}).factory("nodePath",function(){return require("path")}).factory("nodeChildProcess",function(){return require("child_process")}).factory("nodeZlib",function(){return require("zlib")}).factory("nodeSSHexec",function(){return require("ssh-exec")}).factory("nodeRSync",function(){return require("rsyncwrapper")}).factory("nodeSudo",function(){return require("sudo-prompt")}).factory("nodeOnline",function(){return require("is-online")}).factory("nodeGlob",function(){return require("glob")}).factory("nodeLangInfo",function(){return require("node-lang-info")}).factory("nodeAdmZip",function(){return require("adm-zip")}).factory("nodeExtract",function(){return require("extract-zip")}).factory("nodeGettext",function(){return require("angular-gettext-tools")}).factory("nodeCP",function(){return require("copy-paste")}).factory("nodeGetOS",function(){return require("getos")}).factory("nodeTmp",function(){return require("tmp")}).factory("nodeDebounce",function(){return require("lodash.debounce")}).factory("SVGO",function(){var config={full:!0,plugins:["removeDoctype","removeXMLProcInst","removeComments","removeMetadata","removeXMLNS","removeEditorsNSData","cleanupAttrs","minifyStyles","convertStyleToAttrs","cleanupIDs","removeRasterImages","removeUselessDefs","cleanupNumericValues","cleanupListOfValues","convertColors","removeUnknownsAndDefaults","removeNonInheritableGroupAttrs","removeUselessStrokeAndFill","removeViewBox","cleanupEnableBackground","removeHiddenElems","removeEmptyText","convertShapeToPath","moveElemsAttrsToGroup","moveGroupAttrsToElems","collapseGroups","convertPathData","convertTransform","removeEmptyAttrs","removeEmptyContainers","mergePaths","removeUnusedNS","transformsWithOnePath","sortAttrs","removeTitle","removeDesc","removeDimensions","removeAttrs","removeElementsByAttr","addClassesToSVGElement","removeStyleElement","removeStyleElement"]};return new(require("svgo"))(config)}),angular.module("icestudio").factory("gui",function(){return require("nw.gui")}).factory("window",function(){return require("nw.gui").Window}).factory("_package",function(){return require("./package.json")}),joint.dia.CommandManager=Backbone.Model.extend({defaults:{cmdBeforeAdd:null,cmdNameRegex:/^(?:add|remove|board|info|lang|change:\w+)$/},PREFIX_LENGTH:7,initialize:function(options){_.bindAll(this,"initBatchCommand","storeBatchCommand"),this.paper=options.paper,this.graph=options.graph,this.reset(),this.listen()},listen:function(){this.listenTo(this.graph,"state",this.updateState,this),this.listenTo(this.graph,"all",this.addCommand,this),this.listenTo(this.graph,"batch:start",this.initBatchCommand,this),this.listenTo(this.graph,"batch:stop",this.storeBatchCommand,this)},createCommand:function(options){return{action:void 0,data:{id:void 0,type:void 0,previous:{},next:{}},batch:options&&options.batch}},updateState:function(state){this.state=state},addCommand:function(cmdName,cell,graph,options){if("change:labels"!==cmdName&&"change:z"!==cmdName&&this.get("cmdNameRegex").test(cmdName)&&("function"!=typeof this.get("cmdBeforeAdd")||this.get("cmdBeforeAdd").apply(this,arguments))){var command,push=_.bind(function(cmd){this.redoStack=[],cmd.batch?(this.lastCmdIndex=Math.max(this.lastCmdIndex,0),this.trigger("batch",cmd)):(this.undoStack.push(cmd),this.changesStack.push(cmd),this.triggerChange(),this.trigger("add",cmd))},this);if(this.batchCommand?(command=this.batchCommand[Math.max(this.lastCmdIndex,0)],this.lastCmdIndex>=0&&(command.data.id!==cell.id||command.action!==cmdName)&&((command=_.find(this.batchCommand,function(cmd,index){return this.lastCmdIndex=index,cmd.data.id===cell.id&&cmd.action===cmdName},this))||(this.lastCmdIndex=this.batchCommand.push(this.createCommand({batch:!0}))-1,command=_.last(this.batchCommand)))):(command=this.createCommand(),command.batch=!1),"remove"===cmdName&&this.batchCommand&&this.lastCmdIndex>0)for(var i=0;i<this.lastCmdIndex;i++){var prevCommand=this.batchCommand[i];if("add"===prevCommand.action&&prevCommand.data.id===cell.id)return delete this.batchCommand,delete this.lastCmdIndex,void delete this.batchLevel}if("add"===cmdName||"remove"===cmdName)return command.action=cmdName,command.data.id=cell.id,command.data.type=cell.attributes.type,command.data.attributes=_.merge({},cell.toJSON()),command.options=options||{},push(command);if("board"===cmdName||"info"===cmdName||"lang"===cmdName)return command.action=cmdName,command.data=cell.data,push(command);var changedAttribute=cmdName.substr(this.PREFIX_LENGTH);return command.batch&&command.action||(command.action=cmdName,command.data.id=cell.id,command.data.type=cell.attributes.type,command.data.previous[changedAttribute]=_.clone(cell.previous(changedAttribute)),command.options=options||{}),command.data.next[changedAttribute]=_.clone(cell.get(changedAttribute)),push(command)}},initBatchCommand:function(){this.batchCommand?this.batchLevel++:(this.batchCommand=[this.createCommand({batch:!0})],this.lastCmdIndex=-1,this.batchLevel=0)},storeBatchCommand:function(){this.batchCommand&&this.batchLevel<=0?(this.lastCmdIndex>=0&&(this.redoStack=[],this.undoStack.push(this.batchCommand),this.batchCommand&&this.batchCommand[0]&&"lang"!==this.batchCommand[0].action&&(this.changesStack.push(this.batchCommand),this.triggerChange()),this.trigger("add",this.batchCommand)),delete this.batchCommand,delete this.lastCmdIndex,delete this.batchLevel):this.batchCommand&&this.batchLevel>0&&this.batchLevel--},revertCommand:function(command){this.stopListening();var batchCommand;batchCommand=_.isArray(command)?command:[command];for(var i=batchCommand.length-1;i>=0;i--){var cmd=batchCommand[i],cell=this.graph.getCell(cmd.data.id);switch(cmd.action){case"add":cell&&cell.remove();break;case"remove":cmd.data.attributes.state=this.state,this.graph.addCell(cmd.data.attributes);break;case"board":this.triggerBoard(cmd.data.previous);break;case"info":this.triggerInfo(cmd.data.previous);break;case"lang":this.triggerLanguage(cmd.data.previous);break;default:var data=null,options=null,attribute=cmd.action.substr(this.PREFIX_LENGTH);if("data"===attribute&&cmd.options.translateBy&&(cmd.options.ty*=-1,options=cmd.options),data="deltas"===attribute?cmd.data.next[attribute]:cmd.data.previous[attribute],cell){cell.set(attribute,data,options);var cellView=this.paper.findViewByModel(cell);cellView&&cellView.apply({undo:!0,attribute:attribute})}}}this.listen()},applyCommand:function(command){this.stopListening();var batchCommand;batchCommand=_.isArray(command)?command:[command];for(var i=0;i<batchCommand.length;i++){var cmd=batchCommand[i],cell=this.graph.getCell(cmd.data.id);switch(cmd.action){case"add":cmd.data.attributes.state=this.state,this.graph.addCell(cmd.data.attributes);break;case"remove":cell.remove();break;case"board":this.triggerBoard(cmd.data.next);break;case"info":this.triggerInfo(cmd.data.next);break;case"lang":this.triggerLanguage(cmd.data.next);break;default:var data=null,options=null,attribute=cmd.action.substr(this.PREFIX_LENGTH);if("data"===attribute&&cmd.options.translateBy&&(cmd.options.ty*=-1,options=cmd.options),data=cmd.data.next[attribute],cell){cell.set(attribute,data,options);var cellView=this.paper.findViewByModel(cell);cellView&&cellView.apply({undo:!1,attribute:attribute})}}}this.listen()},undo:function(){var command=this.undoStack.pop();command&&(this.revertCommand(command),this.redoStack.push(command),this.changesStack.pop(),this.triggerChange())},redo:function(){var command=this.redoStack.pop();command&&(this.applyCommand(command),this.undoStack.push(command),command[0]&&"lang"===command[0].action||this.changesStack.push(command),this.triggerChange())},cancel:function(){this.hasUndo()&&(this.revertCommand(this.undoStack.pop()),this.redoStack=[])},reset:function(){this.undoStack=[],this.redoStack=[],this.changesStack=[]},hasUndo:function(){return this.undoStack.length>0},hasRedo:function(){return this.redoStack.length>0},triggerChange:function(){var currentUndoStack=_.clone(this.changesStack);$(document).trigger("stackChanged",[currentUndoStack])},triggerBoard:function(board){$(document).trigger("boardChanged",[board])},triggerInfo:function(info){$(document).trigger("infoChanged",[info])},triggerLanguage:function(lang){$(document).trigger("langChanged",[lang])}}),joint.connectors.ice=function(sourcePoint,targetPoint,vertices){var points=[];points.push({x:sourcePoint.x,y:sourcePoint.y}),_.each(vertices,function(vertex){points.push({x:vertex.x,y:vertex.y})}),points.push({x:targetPoint.x,y:targetPoint.y})
;var n=points.length,sq={x:points[0].x-points[1].x,y:points[0].y-points[1].y},tq={x:points[n-1].x-points[n-2].x,y:points[n-1].y-points[n-2].y},sx=8*Math.sign(sq.x),sy=8*Math.sign(sq.y),tx=0===tq.y?8*Math.sign(tq.x):0,ty=0===tq.x?8*Math.sign(tq.y):0,full=["M"],wrap=["M"],dVertices=[];return _.each(vertices,function(vertex){dVertices.push(vertex.x,vertex.y)}),full.push(sourcePoint.x,sourcePoint.y),wrap.push(sourcePoint.x-sx,sourcePoint.y-sy),full=full.concat(dVertices),wrap=wrap.concat(dVertices),full.push(targetPoint.x,targetPoint.y),wrap.push(targetPoint.x-tx,targetPoint.y-ty),{full:full.join(" "),wrap:wrap.join(" ")}},joint.routers.ice=function(g,_,joint){function ObstacleMap(opt,paper){this.map={},this.options=opt,this.paper=paper,this.mapGridSize=100}function SortedSet(){this.items=[],this.hash={},this.values={},this.OPEN=1,this.CLOSE=2}function normalizePoint(point){return g.point(0===point.x?0:Math.abs(point.x)/point.x,0===point.y?0:Math.abs(point.y)/point.y)}function reconstructRoute(parents,point,startCenter,endCenter){for(var parent,route=[],prevDiff=normalizePoint(endCenter.difference(point)),current=point;parent=parents[current];){var diff=normalizePoint(current.difference(parent));diff.equals(prevDiff)||(route.unshift(current),prevDiff=diff),current=parent}return normalizePoint(g.point(current).difference(startCenter)).equals(prevDiff)||route.unshift(current),route}function getRectPoints(bbox,directionList,opt){var step=opt.step,center=bbox.center();return _.chain(opt.directionMap).pick(directionList).map(function(direction){var x=direction.x*bbox.width/2,y=direction.y*bbox.height/2,point=center.clone().offset(x,y);return bbox.containsPoint(point)&&point.offset(direction.x*step,direction.y*step),point.snapToGrid(step)}).value()}function getDirectionAngle(start,end,dirLen){var q=360/dirLen;return Math.floor(g.normalizeAngle(start.theta(end)+q/2)/q)*q}function getDirectionChange(angle1,angle2){var dirChange=Math.abs(angle1-angle2);return dirChange>180?360-dirChange:dirChange}function estimateCost(from,endPoints){for(var min=1/0,i=0,len=endPoints.length;i<len;i++){var cost=from.manhattanDistance(endPoints[i]);cost<min&&(min=cost)}return min}function findRoute(start,end,map,opt){var startPoints,endPoints,startCenter,endCenter,step=opt.step;if(start instanceof g.rect?(startPoints=getRectPoints(start,opt.startDirections,opt),startCenter=start.center().snapToGrid(step)):(startCenter=start.clone().snapToGrid(step),startPoints=[startCenter]),end instanceof g.rect?(endPoints=getRectPoints(end,opt.endDirections,opt),endCenter=end.center().snapToGrid(step)):(endCenter=end.clone().snapToGrid(step),endPoints=[endCenter]),startPoints=_.filter(startPoints,map.isPointAccessible,map),endPoints=_.filter(endPoints,map.isPointAccessible,map),startPoints.length>0&&endPoints.length>0){var openSet=new SortedSet,parents={},costs={};_.each(startPoints,function(point){var key=point.toString();openSet.add(key,estimateCost(point,endPoints)),costs[key]=0});for(var dir,dirChange,currentDirAngle,previousDirAngle,dirs=opt.directions,dirLen=dirs.length,loopsRemain=opt.maximumLoops,endPointsKeys=_.invoke(endPoints,"toString");!openSet.isEmpty()&&loopsRemain>0;){var currentKey=openSet.pop(),currentPoint=g.point(currentKey),currentDist=costs[currentKey];if(previousDirAngle=currentDirAngle,currentDirAngle=parents[currentKey]?getDirectionAngle(parents[currentKey],currentPoint,dirLen):null!=opt.previousDirAngle?opt.previousDirAngle:getDirectionAngle(startCenter,currentPoint,dirLen),endPointsKeys.indexOf(currentKey)>=0&&(dirChange=getDirectionChange(currentDirAngle,getDirectionAngle(currentPoint,endCenter,dirLen)),currentPoint.equals(endCenter)||dirChange<180))return opt.previousDirAngle=currentDirAngle,reconstructRoute(parents,currentPoint,startCenter,endCenter);for(var i=0;i<dirLen;i++)if(dir=dirs[i],dirChange=getDirectionChange(currentDirAngle,dir.angle),!(previousDirAngle&&dirChange>opt.maxAllowedDirectionChange)){var neighborPoint=currentPoint.clone().offset(dir.offsetX,dir.offsetY),neighborKey=neighborPoint.toString();if(!openSet.isClose(neighborKey)&&map.isPointAccessible(neighborPoint)){var costFromStart=currentDist+dir.cost+opt.penalties[dirChange];(!openSet.isOpen(neighborKey)||costFromStart<costs[neighborKey])&&(parents[neighborKey]=currentPoint,costs[neighborKey]=costFromStart,openSet.add(neighborKey,costFromStart+estimateCost(neighborPoint,endPoints)))}}loopsRemain--}}return opt.fallbackRoute(startCenter,endCenter,opt)}function resolveOptions(opt){opt.directions=_.result(opt,"directions"),opt.penalties=_.result(opt,"penalties"),opt.paddingBox=_.result(opt,"paddingBox"),_.each(opt.directions,function(direction){var point1=g.point(0,0),point2=g.point(direction.offsetX,direction.offsetY);direction.angle=g.normalizeAngle(point1.theta(point2))})}function router(vertices,opt){resolveOptions(opt),this.options.perpendicular=!!opt.perpendicular,this.sourceBBox.x+=this.sourceBBox.width/2,this.sourceBBox.y+=this.sourceBBox.height/2,this.sourceBBox.width=0,this.sourceBBox.height=0,this.targetBBox.x+=this.targetBBox.width/2,this.targetBBox.y+=this.targetBBox.height/2,this.targetBBox.width=0,this.targetBBox.height=0;for(var from,to,sourceBBox=g.rect(this.sourceBBox),targetBBox=g.rect(this.targetBBox),map=new ObstacleMap(opt,this.paper).build(this.paper.model,this.model),oldVertices=_.map(vertices,g.point),newVertices=[],tailPoint=sourceBBox.center().snapToGrid(opt.step),i=0,len=oldVertices.length;i<=len;i++){var partialRoute=null;if(from=to||sourceBBox,!(to=oldVertices[i])){to=targetBBox;if((!this.model.get("source").id||!this.model.get("target").id)&&_.isFunction(opt.draggingRoute)){var dragFrom=from instanceof g.rect?from.center():from;partialRoute=opt.draggingRoute(dragFrom,to.origin(),opt)}}if(null===(partialRoute=partialRoute||findRoute(from,to,map,opt))){if(!_.isFunction(joint.routers.orthogonal))throw new Error("Manhattan requires the orthogonal router.");return joint.routers.orthogonal(vertices,opt,this)}var leadPoint=_.first(partialRoute);leadPoint&&leadPoint.equals(tailPoint)&&partialRoute.shift(),tailPoint=_.last(partialRoute)||tailPoint,Array.prototype.push.apply(newVertices,partialRoute)}return newVertices}var config={step:8,perpendicular:!0,excludeEnds:[],excludeTypes:["ice.Info"],maximumLoops:2e3,startDirections:["right","bottom"],endDirections:["left","top"],directionMap:{right:{x:1,y:0},bottom:{x:0,y:1},left:{x:-1,y:0},top:{x:0,y:-1}},maxAllowedDirectionChange:90,paddingBox:function(){return{x:-2,y:-2,width:4,height:4}},directions:function(){var step=this.step;return[{offsetX:step,offsetY:0,cost:step},{offsetX:0,offsetY:step,cost:step},{offsetX:-step,offsetY:0,cost:step},{offsetX:0,offsetY:-step,cost:step}]},penalties:function(){return{0:0,45:this.step/2,90:this.step/2}},fallbackRoute:_.constant(null),draggingRoute:null};return ObstacleMap.prototype.build=function(graph,link){var opt=this.options,excludedEnds=_.chain(opt.excludeEnds).map(link.get,link).pluck("id").map(graph.getCell,graph).value(),excludedAncestors=[],source=graph.getCell(link.get("source").id);source&&(excludedAncestors=_.union(excludedAncestors,_.map(source.getAncestors(),"id")));var target=graph.getCell(link.get("target").id);target&&(excludedAncestors=_.union(excludedAncestors,_.map(target.getAncestors(),"id")));var mapGridSize=this.mapGridSize,blockRectangles=_.chain(graph.getElements()).difference(excludedEnds).reject(function(element){return _.contains(opt.excludeTypes,element.get("type"))||_.contains(excludedAncestors,element.id)}).invoke("getBBox").value(),state=this.paper.options.getState(),labelRectangles=$(".port-label").map(function(index,node){var rect=V(node).bbox();return g.rect({x:(rect.x-state.pan.x)/state.zoom,y:(rect.y-state.pan.y)/state.zoom,width:rect.width/state.zoom,height:rect.height/state.zoom})}).toArray();return _.chain(blockRectangles.concat(labelRectangles)).invoke("moveAndExpand",opt.paddingBox).foldl(function(map,bbox){for(var origin=bbox.origin().snapToGrid(mapGridSize),corner=bbox.corner().snapToGrid(mapGridSize),x=origin.x;x<=corner.x;x+=mapGridSize)for(var y=origin.y;y<=corner.y;y+=mapGridSize){var gridKey=x+"@"+y;map[gridKey]=map[gridKey]||[],map[gridKey].push(bbox)}return map},this.map).value(),this},ObstacleMap.prototype.isPointAccessible=function(point){var mapKey=point.clone().snapToGrid(this.mapGridSize).toString();return _.every(this.map[mapKey],function(obstacle){return!obstacle.containsPoint(point)})},SortedSet.prototype.add=function(item,value){this.hash[item]?this.items.splice(this.items.indexOf(item),1):this.hash[item]=this.OPEN,this.values[item]=value;var index=_.sortedIndex(this.items,item,function(i){return this.values[i]},this);this.items.splice(index,0,item)},SortedSet.prototype.remove=function(item){this.hash[item]=this.CLOSE},SortedSet.prototype.isOpen=function(item){return this.hash[item]===this.OPEN},SortedSet.prototype.isClose=function(item){return this.hash[item]===this.CLOSE},SortedSet.prototype.isEmpty=function(){return 0===this.items.length},SortedSet.prototype.pop=function(){var item=this.items.shift();return this.remove(item),item},function(vertices,opt,linkView){return linkView.sourceMagnet&&(opt.startDirections=[linkView.sourceMagnet.attributes.pos.value]),linkView.targetMagnet&&(opt.endDirections=[linkView.targetMagnet.attributes.pos.value]),router.call(linkView,vertices,_.extend({},config,opt))}}(g,_,joint),joint.ui.SelectionView=Backbone.View.extend({className:"selection",events:{"click .selection-box":"click",dblclick:"dblclick","mousedown .selection-box":"startTranslatingSelection",mouseover:"mouseover",mouseout:"mouseout",mouseup:"mouseup",mousedown:"mousedown"},showtooltip:!0,$selectionArea:null,initialize:function(options){_.bindAll(this,"click","startSelecting","stopSelecting","adjustSelection"),$(document.body).on("mouseup touchend",function(evt){1===evt.which&&this.stopSelecting(evt)}.bind(this)),$(document.body).on("mousemove touchmove",this.adjustSelection),this.options=options,this.options.paper.$el.append(this.$el),this.$el.addClass("selected").show()},click:function(evt){1===evt.which&&this.trigger("selection-box:pointerclick",evt)},dblclick:function(evt){var id=evt.target.getAttribute("data-model");if(id){var view=this.options.paper.findViewByModel(id);view&&view.notify("cell:pointerdblclick",evt)}},mouseover:function(evt){this.mouseManager(evt,"mouseovercard")},mouseout:function(evt){this.mouseManager(evt,"mouseoutcard")},mouseup:function(evt){this.mouseManager(evt,"mouseupcard")},mousedown:function(evt){this.showtooltip||1!==evt.which||(this.showtooltip=!0),this.mouseManager(evt,"mousedowncard")},mouseManager:function(evt,fnc){if(evt.preventDefault(),this.showtooltip){var id=evt.target.getAttribute("data-model");if(id){var view=this.options.paper.findViewByModel(id);view&&view[fnc]&&view[fnc].apply(view,[evt])}}},startTranslatingSelection:function(evt){if("adding"!==this._action&&1===evt.which&&!evt.shiftKey){this._action="translating",this.options.graph.trigger("batch:stop"),this.options.graph.trigger("batch:start");var snappedClientCoords=this.options.paper.snapToGrid(g.point(evt.clientX,evt.clientY));this._snappedClientX=snappedClientCoords.x,this._snappedClientY=snappedClientCoords.y,this.trigger("selection-box:pointerdown",evt)}},startAddingSelection:function(evt){this._action="adding";var snappedClientCoords=this.options.paper.snapToGrid(g.point(evt.clientX,evt.clientY));this._snappedClientX=snappedClientCoords.x,this._snappedClientY=snappedClientCoords.y,this.trigger("selection-box:pointerdown",evt)},startSelecting:function(evt){this.createSelectionArea(),this._action="selecting",this._clientX=evt.clientX,this._clientY=evt.clientY;var paperElement=evt.target.parentElement||evt.target.parentNode,paperOffset=$(paperElement).offset(),paperScrollLeft=paperElement.scrollLeft,paperScrollTop=paperElement.scrollTop;this._offsetX=void 0===evt.offsetX?evt.clientX-paperOffset.left+window.pageXOffset+paperScrollLeft:evt.offsetX,this._offsetY=void 0===evt.offsetY?evt.clientY-paperOffset.top+window.pageYOffset+paperScrollTop:evt.offsetY,this.$selectionArea.css({width:1,height:1,left:this._offsetX,top:this._offsetY})},adjustSelection:function(evt){var dx,dy;switch(this._action){case"selecting":dx=evt.clientX-this._clientX,dy=evt.clientY-this._clientY;var left=parseInt(this.$selectionArea.css("left"),10),top=parseInt(this.$selectionArea.css("top"),10);this.$selectionArea.css({left:dx<0?this._offsetX+dx:left,top:dy<0?this._offsetY+dy:top,width:Math.abs(dx),height:Math.abs(dy)});break;case"adding":case"translating":var snappedClientCoords=this.options.paper.snapToGrid(g.point(evt.clientX,evt.clientY)),snappedClientX=snappedClientCoords.x,snappedClientY=snappedClientCoords.y;dx=snappedClientX-this._snappedClientX,dy=snappedClientY-this._snappedClientY;var processedLinks={};this.model.each(function(element){element.translate(dx,dy),this.updateBox(element);var connectedLinks=this.options.graph.getConnectedLinks(element);_.each(connectedLinks,function(link){if(!processedLinks[link.id]){var vertices=link.get("vertices");if(vertices&&vertices.length){var newVertices=[];_.each(vertices,function(vertex){newVertices.push({x:vertex.x+dx,y:vertex.y+dy})}),link.set("vertices",newVertices)}processedLinks[link.id]=!0}})},this),(dx||dy)&&(this._snappedClientX=snappedClientX,this._snappedClientY=snappedClientY),this.trigger("selection-box:pointermove",evt)}},stopSelecting:function(evt){switch(this._action){case"selecting":evt.shiftKey||this.cancelSelection();var offset=this.$selectionArea.offset(),width=this.$selectionArea.width(),height=this.$selectionArea.height(),localPoint=V(this.options.paper.svg).toLocalPoint(offset.left,offset.top);localPoint.x-=window.pageXOffset,localPoint.y-=window.pageYOffset;var elementViews=this.findBlocksInArea(g.rect(localPoint.x,localPoint.y,width,height),{strict:!1});this.model.add(_.pluck(elementViews,"model")),_.each(this.model.models,this.createSelectionBox,this),this.destroySelectionArea();break;case"translating":this.options.graph.trigger("batch:stop")}delete this._action},findBlocksInArea:function(rect,opt){opt=_.defaults(opt||{},{strict:!1}),rect=g.rect(rect);var paper=this.options.paper,views=_.map(paper.model.getElements(),paper.findViewByModel,paper),method=opt.strict?"containsRect":"intersect";return _.filter(views,function(view){var $box=$(view.$box[0]),position=$box.position(),rbox=g.rect(position.left,position.top,$box.width(),$box.height());return view&&rect[method](rbox)},this)},cancelSelection:function(){this.$(".selection-box").remove(),this.model.reset([])},destroySelectionArea:function(){this.$selectionArea.remove(),this.$selectionArea=this.$(".selection-area"),this.$el.addClass("selected")},createSelectionArea:function(){var $selectionArea=$("<div/>",{class:"selection-area"});this.$el.append($selectionArea),this.$selectionArea=this.$(".selection-area"),this.$el.removeClass("selected")},destroySelectionBox:function(element){this.$('[data-model="'+element.get("id")+'"]').remove()},createSelectionBox:function(element,opt){if(opt=opt||{},!element.isLink()){var $selectionBox=$("<div/>",{class:"selection-box","data-model":element.get("id")});0===this.$('[data-model="'+element.get("id")+'"]').length&&this.$el.append($selectionBox),this.showtooltip=void 0===opt.initooltip||opt.initooltip,$selectionBox.css({opacity:opt.transparent?0:1}),this.updateBox(element),this._action="cherry-picking"}},updateBox:function(element){var bbox=element.getBBox(),state=this.options.state,view=this.options.paper.findViewByModel(element),el=view.$box.children().not(".hidden").first(),position=el.position(),width=el.outerWidth(),height=el.outerHeight();$("div[data-model='"+element.get("id")+"']").css({left:(bbox.x+position.left)*state.zoom+state.pan.x+(width/2-position.left)*(state.zoom-1)-8,top:(bbox.y+position.top)*state.zoom+state.pan.y+(height/2-position.top)*(state.zoom-1)-8,width:width+16,height:height+16,transform:"scale("+state.zoom+")"})}});var os=require("os"),sha1=require("sha1"),marked=require("marked"),openurl=require("openurl"),emoji=require("node-emoji");const WIRE_WIDTH=1.5,DARWIN=Boolean(os.platform().indexOf("darwin")>-1);if(DARWIN)var aceFontSize="12";else var aceFontSize="14";joint.shapes.ice={},joint.shapes.ice.Model=joint.shapes.basic.Generic.extend({markup:'<g class="rotatable">             <g class="scalable">               <rect class="body"/>             </g>             <g class="leftPorts disable-port"/>             <g class="rightPorts"/>             <g class="topPorts disable-port"/>             <g class="bottomPorts"/>           </g>',portMarkup:'<g class="port port<%= index %>">                 <g class="port-default" id="port-default-<%= id %>-<%= port.id %>">                    <path/><rect/>                 </g>                 <path class="port-wire" id="port-wire-<%= id %>-<%= port.id %>"/>                 <text class="port-label"/>                 <circle class="port-body"/>               </g>',defaults:joint.util.deepSupplement({type:"ice.Model",size:{width:1,height:1},leftPorts:[],rightPorts:[],topPorts:[],bottomPorts:[],attrs:{".":{magnet:!1},".body":{width:1,height:1,stroke:"none"},".port-body":{r:16,opacity:0},".leftPorts .port-body":{pos:"left",type:"input",magnet:!1},".rightPorts .port-body":{pos:"right",type:"output",magnet:!0},".topPorts .port-body":{pos:"top",type:"input",magnet:!1},".bottomPorts .port-body":{pos:"bottom",type:"output",magnet:!0},".port-label":{fill:"#777"},".port-wire":{stroke:"#777","stroke-width":1.5},".port-default":{display:"none"},".port-default rect":{x:"-32",y:"-8",width:"16",height:"16",rx:"3",ry:"3",stroke:"#777","stroke-width":1,fill:"#FBFBC9"},".port-default path":{d:"M 0 0 L -20 0",stroke:"#777","stroke-width":1.5}}},joint.shapes.basic.Generic.prototype.defaults),initialize:function(){this.updatePortsAttrs(),this.processPorts(),this.trigger("process:ports"),this.on("change:size change:leftPorts change:rightPorts change:topPorts change:bottomPorts",this.updatePortsAttrs,this),this.constructor.__super__.constructor.__super__.initialize.apply(this,arguments)},updatePortsAttrs:function(){if(this._portSelectors){var newAttrs=_.omit(this.get("attrs"),this._portSelectors);this.set("attrs",newAttrs,{silent:!0})}var attrs={};this._portSelectors=[],_.each(["left","right"],function(type){var port=type+"Ports";_.each(this.get(port),function(portName,index,ports){var portAttributes=this.getPortAttrs(portName,index,ports.length,"."+port,type,this.get("size").height);this._portSelectors=this._portSelectors.concat(_.keys(portAttributes)),_.extend(attrs,portAttributes)},this)},this),_.each(["top","bottom"],function(type){var port=type+"Ports";_.each(this.get(port),function(portName,index,ports){var portAttributes=this.getPortAttrs(portName,index,ports.length,"."+port,type,this.get("size").width);this._portSelectors=this._portSelectors.concat(_.keys(portAttributes)),_.extend(attrs,portAttributes)},this)},this),this.attr(attrs,{silent:!0})},getPortAttrs:function(port,index,total,selector,type,length){var attrs={},gridunits=length/8,portClass="port"+index,portSelector=selector+">."+portClass,portLabelSelector=portSelector+">.port-label",portWireSelector=portSelector+">.port-wire",portBodySelector=portSelector+">.port-body",portDefaultSelector=portSelector+">.port-default";attrs[portSelector]={ref:".body"},attrs[portLabelSelector]={text:port.label},attrs[portWireSelector]={},attrs[portBodySelector]={port:{id:port.id,type:type}},attrs[portDefaultSelector]={display:port.default&&port.default.apply?"inline":"none"},"leftPorts"!==type&&"topPorts"!==type||(attrs[portSelector]["pointer-events"]="none",attrs[portWireSelector]["pointer-events"]="none");var offset=port.size&&port.size>1?4:1,position=Math.round((index+.5)/total*gridunits)/gridunits;switch(type){case"left":attrs[portSelector]["ref-x"]=-8,attrs[portSelector]["ref-y"]=position,attrs[portLabelSelector].dx=4,attrs[portLabelSelector].y=-5-offset,attrs[portLabelSelector]["text-anchor"]="end",attrs[portWireSelector].y=position,attrs[portWireSelector].d="M 0 0 L 8 0";break;case"right":attrs[portSelector]["ref-dx"]=8,attrs[portSelector]["ref-y"]=position,attrs[portLabelSelector].dx=-4,attrs[portLabelSelector].y=-5-offset,attrs[portLabelSelector]["text-anchor"]="start",attrs[portWireSelector].y=position,attrs[portWireSelector].d="M 0 0 L -8 0";break;case"top":attrs[portSelector]["ref-y"]=-8,attrs[portSelector]["ref-x"]=position,attrs[portLabelSelector].dx=-4,attrs[portLabelSelector].y=-5-offset,attrs[portLabelSelector]["text-anchor"]="start",attrs[portLabelSelector].transform="rotate(-90)",attrs[portWireSelector].x=position,attrs[portWireSelector].d="M 0 0 L 0 8";break;case"bottom":attrs[portSelector]["ref-dy"]=8,attrs[portSelector]["ref-x"]=position,attrs[portLabelSelector].dx=4,attrs[portLabelSelector].y=-5-offset,attrs[portLabelSelector]["text-anchor"]="end",attrs[portLabelSelector].transform="rotate(-90)",attrs[portWireSelector].x=position,attrs[portWireSelector].d="M 0 0 L 0 -8"}return attrs}}),joint.shapes.ice.ModelView=joint.dia.ElementView.extend({template:"",initialize:function(){_.bindAll(this,"updateBox"),joint.dia.ElementView.prototype.initialize.apply(this,arguments),this.$box=$(joint.util.template(this.template)()),this.model.on("change",this.updateBox,this),this.model.on("remove",this.removeBox,this),this.updateBox(),this.listenTo(this.model,"process:ports",this.update)},setupResizer:function(){this.model.get("disabled")||(this.resizing=!1,this.resizer=this.$box.find(".resizer"),this.resizer.css("cursor","se-resize"),this.resizer.on("mousedown",{self:this},this.startResizing),$(document).on("mousemove",{self:this},this.performResizing),$(document).on("mouseup",{self:this},this.stopResizing))},enableResizer:function(){this.model.get("disabled")||(this.resizerDisabled=!1,this.resizer.css("cursor","se-resize"))},disableResizer:function(){this.model.get("disabled")||(this.resizerDisabled=!0,this.resizer.css("cursor","move"))},apply:function(){},startResizing:function(event){var self=event.data.self;self.resizerDisabled||(self.model.graph.trigger("batch:start"),self.resizing=!0,self._clientX=event.clientX,self._clientY=event.clientY)},performResizing:function(event){function snapToGrid(coords){return{x:Math.round(coords.x/state.zoom/gridstep)*gridstep,y:Math.round(coords.y/state.zoom/gridstep)*gridstep}}var self=event.data.self;if(self.resizing&&!self.resizerDisabled){var type=self.model.get("type"),size=self.model.get("size"),state=self.model.get("state"),gridstep=8,minSize={width:64,height:32};"ice.Code"!==type&&"ice.Memory"!==type||(minSize={width:96,height:64});var clientCoords=snapToGrid({x:event.clientX,y:event.clientY}),oldClientCoords=snapToGrid({x:self._clientX,y:self._clientY}),dx=clientCoords.x-oldClientCoords.x,dy=clientCoords.y-oldClientCoords.y,width=Math.max(size.width+dx,minSize.width),height=Math.max(size.height+dy,minSize.height);width>minSize.width&&(self._clientX=event.clientX),height>minSize.height&&(self._clientY=event.clientY),self.model.resize(width,height)}},stopResizing:function(event){var self=event.data.self;self.resizing&&!self.resizerDisabled&&(self.resizing=!1,self.model.graph.trigger("batch:stop"))},render:function(){return joint.dia.ElementView.prototype.render.apply(this,arguments),this.paper.$el.append(this.$box),this.updateBox(),this},renderPorts:function(){var $leftPorts=this.$(".leftPorts").empty(),$rightPorts=this.$(".rightPorts").empty(),$topPorts=this.$(".topPorts").empty(),$bottomPorts=this.$(".bottomPorts").empty(),portTemplate=_.template(this.model.portMarkup),modelId=this.model.id;_.each(_.filter(this.model.ports,function(p){return"left"===p.type}),function(port,index){$leftPorts.append(V(portTemplate({id:modelId,index:index,port:port})).node)}),_.each(_.filter(this.model.ports,function(p){return"right"===p.type}),function(port,index){$rightPorts.append(V(portTemplate({id:modelId,index:index,port:port})).node)}),_.each(_.filter(this.model.ports,function(p){return"top"===p.type}),function(port,index){$topPorts.append(V(portTemplate({id:modelId,index:index,port:port})).node)}),_.each(_.filter(this.model.ports,function(p){return"bottom"===p.type}),function(port,index){$bottomPorts.append(V(portTemplate({id:modelId,index:index,port:port})).node)})},update:function(){this.renderPorts(),joint.dia.ElementView.prototype.update.apply(this,arguments)},updateBox:function(){},removeBox:function(){this.$box.remove()},updateScrollStatus:function(status){this.editor&&(this.editor.renderer.scrollBarV.element.style.visibility=status?"":"hidden",this.editor.renderer.scrollBarH.element.style.visibility=status?"":"hidden",this.editor.renderer.scroller.style.right=0,this.editor.renderer.scroller.style.bottom=0)}}),joint.shapes.ice.Generic=joint.shapes.ice.Model.extend({defaults:joint.util.deepSupplement({type:"ice.Generic"},joint.shapes.ice.Model.prototype.defaults)}),joint.shapes.ice.GenericView=joint.shapes.ice.ModelView.extend({template:'  <div class="generic-block">    <div class="generic-content">      <div class="img-container"><img></div>      <label></label>      <span class="tooltiptext"></span>    </div>  </div>  ',events:{mouseover:"mouseovercard",mouseout:"mouseoutcard",mouseup:"mouseupcard",mousedown:"mousedowncard"},enter:!1,mouseovercard:function(event){event&&0===event.which&&this.showTooltip()},mouseoutcard:function(){this.hideTooltip()},mouseupcard:function(){},mousedowncard:function(){this.hideTooltip()},showTooltip:function(){this.tooltip&&(this.openTimeout||(this.openTimeout=setTimeout(function(){this.tooltiptext.css("visibility","visible")}.bind(this),2e3)))},hideTooltip:function(){this.tooltip&&(this.openTimeout&&(clearTimeout(this.openTimeout),this.openTimeout=null),this.tooltiptext.css("visibility","hidden"))},initialize:function(){joint.shapes.ice.ModelView.prototype.initialize.apply(this,arguments),this.tooltip=this.model.get("tooltip"),this.tooltiptext=this.$box.find(".tooltiptext"),this.tooltiptext.text(this.tooltip),this.tooltip.length>13?(this.tooltiptext.addClass("tooltip-medium"),this.tooltiptext.removeClass("tooltip-large")):this.tooltip.length>20?(this.tooltiptext.addClass("tooltip-large"),this.tooltiptext.removeClass("tooltip-medium")):(this.tooltiptext.removeClass("tooltip-medium"),this.tooltiptext.removeClass("tooltip-large")),this.model.get("config")&&this.$box.find(".generic-content").addClass("config-block"),this.initializeContent()},initializeContent:function(){var image=this.model.get("image"),label=this.model.get("label"),ports=this.model.get("leftPorts"),imageSelector=this.$box.find("img"),labelSelector=this.$box.find("label");image?(imageSelector.attr("src","data:image/svg+xml,"+image),imageSelector.removeClass("hidden"),labelSelector.addClass("hidden")):(labelSelector.html(label),labelSelector.removeClass("hidden"),imageSelector.addClass("hidden")),this.$box.find(".clock").remove();var n=ports.length,height=this.model.get("size").height,contentSelector=this.$box.find(".generic-content");for(var i in ports){if(ports[i].clock){var top=8*Math.round((parseInt(i)+.5)*height/n/8)-9;contentSelector.append('          <div class="clock" style="top: '+top+'px;">            <svg width="12" height="18"><path d="M-1 0 l10 8-10 8" fill="none" stroke="#555" stroke-width="1.2" stroke-linejoin="round"/>          </div>')}}},updateBox:function(){var i,port,bbox=this.model.getBBox(),data=this.model.get("data"),state=this.model.get("state"),rules=this.model.get("rules"),leftPorts=this.model.get("leftPorts"),rightPorts=this.model.get("rightPorts"),modelId=this.model.id,width=1.5*state.zoom;this.$(".port-wire").css("stroke-width",width);for(i in leftPorts)port=leftPorts[i],port.size>1&&this.$("#port-wire-"+modelId+"-"+port.id).css("stroke-width",3*width);for(i in rightPorts)port=rightPorts[i],port.size>1&&this.$("#port-wire-"+modelId+"-"+port.id).css("stroke-width",3*width);if(data&&data.ports&&data.ports.in)for(i in data.ports.in){port=data.ports.in[i];var portDefault=this.$("#port-default-"+modelId+"-"+port.name);rules&&port.default&&port.default.apply?(portDefault.css("display","inline"),portDefault.find("path").css("stroke-width",width),portDefault.find("rect").css("stroke-width",state.zoom)):portDefault.css("display","none")}this.$box.find(".generic-content").css({left:Math.round(bbox.width/2*(state.zoom-1)),top:Math.round(bbox.height/2*(state.zoom-1)),width:Math.round(bbox.width),height:Math.round(bbox.height),transform:"scale("+state.zoom+")"}),this.$box.css({left:bbox.x*state.zoom+state.pan.x,top:bbox.y*state.zoom+state.pan.y,width:bbox.width*state.zoom,height:bbox.height*state.zoom})}}),joint.shapes.ice.Input=joint.shapes.ice.Model.extend({defaults:joint.util.deepSupplement({type:"ice.Input",size:{width:96,height:64}},joint.shapes.ice.Model.prototype.defaults)}),joint.shapes.ice.Output=joint.shapes.ice.Model.extend({defaults:joint.util.deepSupplement({type:"ice.Output",size:{width:96,height:64}},joint.shapes.ice.Model.prototype.defaults)}),joint.shapes.ice.IOView=joint.shapes.ice.ModelView.extend({initialize:function(){_.bindAll(this,"updateBox"),joint.dia.ElementView.prototype.initialize.apply(this,arguments),this.id=sha1(this.model.get("id")).toString().substring(0,6);var comboId="combo"+this.id,virtual=this.model.get("data").virtual||this.model.get("disabled"),selectCode="",selectScript="",data=this.model.get("data"),name=data.name+(data.range||"");if(data.pins)for(var i in data.pins)selectCode+='<select id="'+comboId+data.pins[i].index+'"',selectCode+='class="select2" i="'+i+'">',selectCode+="</select>",selectScript+='$("#'+comboId+data.pins[i].index+'").select2(',selectScript+='{placeholder: "", allowClear: true, dropdownCssClass: "bigdrop",',selectScript+="matcher: function(params, data) {",selectScript+='  params.term = params.term || "";',selectScript+="  if (data.text.toUpperCase().indexOf(params.term.toUpperCase()) == 0) { return data; }",selectScript+="  return false; } });";this.$box=$(joint.util.template('      <div class="io-block">        <div class="io-virtual-content'+(virtual?"":" hidden")+'">          <div class="header">            <label>'+name+'</label>            <svg viewBox="0 0 12 18"><path d="M-1 0 l10 8-10 8" fill="none" stroke-width="2" stroke-linejoin="round"/>          </div>        </div>        <div class="io-fpga-content'+(virtual?" hidden":"")+'">          <div class="header">            <label>'+name+'</label>            <svg viewBox="0 0 12 18"><path d="M-1 0 l10 8-10 8" fill="none" stroke-width="2" stroke-linejoin="round"/>          </div>          <div>'+selectCode+"</div>          <script>"+selectScript+"<\/script>        </div>      </div>      ")()),this.virtualContentSelector=this.$box.find(".io-virtual-content"),this.fpgaContentSelector=this.$box.find(".io-fpga-content"),this.headerSelector=this.$box.find(".header"),this.model.on("change",this.updateBox,this),this.model.on("remove",this.removeBox,this),this.listenTo(this.model,"process:ports",this.update),joint.dia.ElementView.prototype.initialize.apply(this,arguments);var self=this,selector=this.$box.find(".select2");selector.on("mousedown click",function(event){event.stopPropagation()}),selector.on("change",function(event){if(!self.updating){var target=$(event.target),i=target.attr("i"),name=target.find("option:selected").text(),value=target.val(),data=JSON.parse(JSON.stringify(self.model.get("data")));null!==name&&null!==value&&(data.pins[i].name=name,data.pins[i].value=value,self.model.set("data",data))}}),this.updateBox(),this.updating=!1,this.model.get("disabled")||(this.applyChoices(),this.applyValues(),this.applyShape()),this.applyClock()},applyChoices:function(){var data=this.model.get("data");if(data.pins)for(var i in data.pins)this.$box.find("#combo"+this.id+data.pins[i].index).empty().append(this.model.get("choices"))},applyValues:function(){this.updating=!0;var data=this.model.get("data");for(var i in data.pins){
var index=data.pins[i].index,value=data.pins[i].value,name=data.pins[i].name,comboId="#combo"+this.id+index,comboSelector=this.$box.find(comboId+" option:contains("+name+")");comboSelector?comboSelector.attr("selected",!0):(comboSelector=this.$box.find(comboId),comboSelector.val(value).change())}this.updating=!1},applyShape:function(){var data=this.model.get("data"),name=data.name+(data.range||""),virtual=data.virtual||this.model.get("disabled");this.$box.find("label").text(name||""),virtual?(this.fpgaContentSelector.addClass("hidden"),this.virtualContentSelector.removeClass("hidden"),this.model.attributes.size.height=64):(this.virtualContentSelector.addClass("hidden"),this.fpgaContentSelector.removeClass("hidden"),data.pins&&(this.model.attributes.size.height=32+32*data.pins.length))},applyClock:function(){this.model.get("data").clock?this.$box.find("svg").removeClass("hidden"):this.$box.find("svg").addClass("hidden")},clearValues:function(){this.updating=!0;var data=JSON.parse(JSON.stringify(this.model.get("data")));for(var i in data.pins){var index=data.pins[i].index,comboId="#combo"+this.id+index;this.$box.find(comboId).val("0").change(),data.pins[i].name="",data.pins[i].value="0"}this.model.set("data",data),this.updating=!1},apply:function(){this.applyChoices(),this.applyValues(),this.applyShape(),this.applyClock(),this.render()},update:function(){this.renderPorts(),joint.dia.ElementView.prototype.update.apply(this,arguments)},updateBox:function(){var i,port,bbox=this.model.getBBox(),data=this.model.get("data"),state=this.model.get("state"),rules=this.model.get("rules"),leftPorts=this.model.get("leftPorts"),rightPorts=this.model.get("rightPorts"),modelId=this.model.id,width=1.5*state.zoom;this.$(".port-wire").css("stroke-width",width);for(i in leftPorts)port=leftPorts[i],port.size>1&&this.$("#port-wire-"+modelId+"-"+port.id).css("stroke-width",3*width);for(i in rightPorts)port=rightPorts[i],port.size>1&&this.$("#port-wire-"+modelId+"-"+port.id).css("stroke-width",3*width);if(data&&data.ports&&data.ports.in)for(i in data.ports.in){port=data.ports.in[i];var portDefault=this.$("#port-default-"+modelId+"-"+port.name);rules&&port.default&&port.default.apply?(portDefault.css("display","inline"),portDefault.find("path").css("stroke-width",width),portDefault.find("rect").css("stroke-width",state.zoom)):portDefault.css("display","none")}this.virtualContentSelector.css({left:Math.round(bbox.width/2*(state.zoom-1)),top:Math.round((bbox.height-24)/2*(state.zoom-1)+12*state.zoom),width:Math.round(bbox.width),height:Math.round(bbox.height-24),transform:"scale("+state.zoom+")"});var fpgaTopOffset=data.name||data.range||data.clock?0:24;this.fpgaContentSelector.css({left:Math.round(bbox.width/2*(state.zoom-1)),top:Math.round((bbox.height-fpgaTopOffset)/2*(state.zoom-1)+fpgaTopOffset/2*state.zoom),width:Math.round(bbox.width),height:Math.round(bbox.height-fpgaTopOffset),transform:"scale("+state.zoom+")"}),data.name||data.range||data.clock?this.headerSelector.removeClass("hidden"):this.headerSelector.addClass("hidden"),this.$box.css({left:bbox.x*state.zoom+state.pan.x,top:bbox.y*state.zoom+state.pan.y,width:bbox.width*state.zoom,height:bbox.height*state.zoom})},removeBox:function(){this.$box.find("select").select2("close"),this.$box.remove()}}),joint.shapes.ice.InputView=joint.shapes.ice.IOView,joint.shapes.ice.OutputView=joint.shapes.ice.IOView,joint.shapes.ice.Constant=joint.shapes.ice.Model.extend({defaults:joint.util.deepSupplement({type:"ice.Constant",size:{width:96,height:64}},joint.shapes.ice.Model.prototype.defaults)}),joint.shapes.ice.ConstantView=joint.shapes.ice.ModelView.extend({initialize:function(){_.bindAll(this,"updateBox"),joint.dia.ElementView.prototype.initialize.apply(this,arguments),this.$box=$(joint.util.template('      <div class="constant-block">        <div class="constant-content">          <div class="header">            <label></label>            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 8 9.78"><path d="M2.22 4.44h3.56V3.11q0-.73-.52-1.26-.52-.52-1.26-.52t-1.26.52q-.52.52-.52 1.26v1.33zM8 5.11v4q0 .28-.2.47-.19.2-.47.2H.67q-.28 0-.48-.2Q0 9.38 0 9.11v-4q0-.28.2-.47.19-.2.47-.2h.22V3.11q0-1.28.92-2.2Q2.72 0 4 0q1.28 0 2.2.92.91.91.91 2.2v1.32h.22q.28 0 .48.2.19.2.19.47z"/></svg>          </div>          <input class="constant-input"></input>        </div>      </div>      ')()),this.inputSelector=this.$box.find(".constant-input"),this.contentSelector=this.$box.find(".constant-content"),this.headerSelector=this.$box.find(".header"),this.model.on("change",this.updateBox,this),this.model.on("remove",this.removeBox,this),this.listenTo(this.model,"process:ports",this.update),joint.dia.ElementView.prototype.initialize.apply(this,arguments),this.inputSelector.on("mousedown click",function(event){event.stopPropagation()}),this.updateBox(),this.updating=!1;var self=this;this.inputSelector.on("input",function(event){if(!self.updating){var target=$(event.target),data=JSON.parse(JSON.stringify(self.model.get("data")));data.value=target.val(),self.model.set("data",data)}}),this.inputSelector.on("paste",function(event){event.originalEvent.clipboardData.getData("text").startsWith('{"icestudio":')&&event.preventDefault()}),this.apply()},apply:function(){this.applyName(),this.applyLocal(),this.applyValue()},applyName:function(){var name=this.model.get("data").name;this.$box.find("label").text(name)},applyLocal:function(){this.model.get("data").local?this.$box.find("svg").removeClass("hidden"):this.$box.find("svg").addClass("hidden")},applyValue:function(){this.updating=!0,this.model.get("disabled")&&this.inputSelector.css({"pointer-events":"none"});var value=this.model.get("data").value;this.inputSelector.val(value),this.updating=!1},update:function(){this.renderPorts(),joint.dia.ElementView.prototype.update.apply(this,arguments)},updateBox:function(){var bbox=this.model.getBBox(),data=this.model.get("data"),state=this.model.get("state"),width=1.5*state.zoom;this.$(".port-wire").css("stroke-width",width);var topOffset=data.name||data.local?0:24;this.contentSelector.css({left:Math.round(bbox.width/2*(state.zoom-1)),top:Math.round((bbox.height+topOffset)/2*(state.zoom-1)+topOffset),width:Math.round(bbox.width),height:Math.round(bbox.height-topOffset),transform:"scale("+state.zoom+")"}),data.name||data.local?this.headerSelector.removeClass("hidden"):this.headerSelector.addClass("hidden"),this.$box.css({left:bbox.x*state.zoom+state.pan.x,top:bbox.y*state.zoom+state.pan.y,width:bbox.width*state.zoom,height:bbox.height*state.zoom})}}),joint.shapes.ice.Memory=joint.shapes.ice.Model.extend({defaults:joint.util.deepSupplement({type:"ice.Memory",size:{width:96,height:104}},joint.shapes.ice.Model.prototype.defaults)}),joint.shapes.ice.MemoryView=joint.shapes.ice.ModelView.extend({initialize:function(){_.bindAll(this,"updateBox"),joint.dia.ElementView.prototype.initialize.apply(this,arguments);var id=sha1(this.model.get("id")).toString().substring(0,6),editorLabel="editor"+id;this.$box=$(joint.util.template('      <div class="memory-block">        <div class="memory-content">          <div class="header">            <label></label>            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 8 9.78"><path d="M2.22 4.44h3.56V3.11q0-.73-.52-1.26-.52-.52-1.26-.52t-1.26.52q-.52.52-.52 1.26v1.33zM8 5.11v4q0 .28-.2.47-.19.2-.47.2H.67q-.28 0-.48-.2Q0 9.38 0 9.11v-4q0-.28.2-.47.19-.2.47-.2h.22V3.11q0-1.28.92-2.2Q2.72 0 4 0q1.28 0 2.2.92.91.91.91 2.2v1.32h.22q.28 0 .48.2.19.2.19.47z"/></svg>          </div>        </div>        <div class="memory-editor" id="'+editorLabel+'"></div>        <script>          var '+editorLabel+' = ace.edit("'+editorLabel+'");          '+editorLabel+'.setTheme("ace/theme/chrome");          '+editorLabel+".setHighlightActiveLine(false);          "+editorLabel+".setHighlightGutterLine(false);          "+editorLabel+'.setOption("firstLineNumber", 0);          '+editorLabel+".setAutoScrollEditorIntoView(true);          "+editorLabel+".renderer.setShowGutter(true);          "+editorLabel+".renderer.$cursorLayer.element.style.opacity = 0;          "+editorLabel+'.renderer.$gutter.style.background = "#F0F0F0";          '+editorLabel+'.session.setMode("ace/mode/verilog");        <\/script>        <div class="resizer"/></div>      </div>      ')()),this.editorSelector=this.$box.find(".memory-editor"),this.contentSelector=this.$box.find(".memory-content"),this.headerSelector=this.$box.find(".header"),this.model.on("change",this.updateBox,this),this.model.on("remove",this.removeBox,this),this.listenTo(this.model,"process:ports",this.update),joint.dia.ElementView.prototype.initialize.apply(this,arguments),this.editorSelector.on("mousedown click",function(event){event.stopPropagation()}),this.updateBox(),this.updating=!1,this.prevZoom=0,this.deltas=[],this.counter=0,this.timer=null;var self=this;this.editor=ace.edit(this.editorSelector[0]),this.updateScrollStatus(!1),this.editor.$blockScrolling=1/0,this.editor.commands.removeCommand("undo"),this.editor.commands.removeCommand("redo"),this.editor.commands.removeCommand("touppercase"),this.editor.session.on("change",function(delta){self.updating||(Date.now()-self.counter<200&&clearTimeout(self.timer),self.deltas=self.deltas.concat([delta]),self.timer=setTimeout(function(){var deltas=JSON.parse(JSON.stringify(self.deltas));self.model.set("deltas",deltas),self.deltas=[],self.model.attributes.data.list=self.editor.session.getValue()},200),self.counter=Date.now())}),this.editor.on("focus",function(){self.updateScrollStatus(!0),$(document).trigger("disableSelected"),self.editor.setHighlightActiveLine(!0),self.editor.setHighlightGutterLine(!0),self.editor.renderer.$cursorLayer.element.style.opacity=1}),this.editor.on("blur",function(){self.updateScrollStatus(!1);var selection=self.editor.session.selection;selection&&selection.clearSelection(),self.editor.setHighlightActiveLine(!1),self.editor.setHighlightGutterLine(!1),self.editor.renderer.$cursorLayer.element.style.opacity=0}),this.editor.on("paste",function(e){e.text.startsWith('{"icestudio":')&&(e.text="")}),this.editor.on("mousewheel",function(event){document.activeElement.parentNode.id===self.editorSelector.attr("id")?event.stopPropagation():event.preventDefault()}),this.setupResizer(),this.apply({ini:!0})},apply:function(opt){this.applyName(),this.applyLocal(),this.applyValue(opt),this.applyFormat(),this.editor&&this.editor.resize()},applyName:function(){var name=this.model.get("data").name;this.$box.find("label").text(name)},applyLocal:function(){this.model.get("data").local?this.$box.find("svg").removeClass("hidden"):this.$box.find("svg").addClass("hidden")},applyValue:function(opt){this.updating=!0;var data=this.model.get("data"),deltas=this.model.get("deltas");switch(opt=opt||{},opt.attribute){case"deltas":if(deltas){var changes=[{group:"doc",deltas:deltas}];opt.undo?this.editor.session.undoChanges(changes,!1):this.editor.session.redoChanges(changes,!1)}}opt.ini?this.editor.session.setValue(data.list):this.model.attributes.data.list=this.editor.session.getValue(),setTimeout(function(self){self.updating=!1},10,this)},applyFormat:function(){this.updating=!0;var self=this,data=this.model.get("data"),radix=data.format;this.editor.session.gutterRenderer={getWidth:function(session,lastLineNumber,config){return lastLineNumber.toString().length*config.characterWidth},getText:function(session,row){for(var text=row.toString(radix).toUpperCase(),config=self.editor.renderer.layerConfig,size=config.lastRow.toString(radix).length;text.length<size;)text="0"+text;return(16===radix?"0x":"")+text}},this.editor.renderer.setShowGutter(!1),this.editor.renderer.setShowGutter(!0),this.updating=!1},update:function(){this.renderPorts(),this.editor.setReadOnly(this.model.get("disabled")),joint.dia.ElementView.prototype.update.apply(this,arguments)},updateBox:function(){var bbox=this.model.getBBox(),data=this.model.get("data"),state=this.model.get("state");if(this.editor){if(this.prevZoom!==state.zoom){this.prevZoom=state.zoom,this.editorSelector.css({top:24*state.zoom,margin:7*state.zoom,"border-radius":5*state.zoom,"border-width":state.zoom+.5}),this.$box.find(".ace_text-layer").css("padding","0px "+Math.round(4*state.zoom)+"px");var rule=getCSSRule(".ace_folding-enabled > .ace_gutter-cell");rule&&(rule.style.paddingLeft=Math.round(19*state.zoom)+"px",rule.style.paddingRight=Math.round(13*state.zoom)+"px"),this.editor.setFontSize(Math.round(aceFontSize*state.zoom)),this.editor.renderer.$cursorLayer.$padding=Math.round(4*state.zoom)}this.editor.resize()}var width=1.5*state.zoom;this.$(".port-wire").css("stroke-width",width);var topOffset=data.name||data.local?0:24;this.contentSelector.css({left:Math.round(bbox.width/2*(state.zoom-1)),top:Math.round((bbox.height+topOffset)/2*(state.zoom-1)+topOffset),width:Math.round(bbox.width),height:Math.round(bbox.height-topOffset),transform:"scale("+state.zoom+")"}),data.name||data.local?this.headerSelector.removeClass("hidden"):this.headerSelector.addClass("hidden"),this.$box.css({left:bbox.x*state.zoom+state.pan.x,top:bbox.y*state.zoom+state.pan.y,width:bbox.width*state.zoom,height:bbox.height*state.zoom})}}),joint.shapes.ice.Code=joint.shapes.ice.Model.extend({defaults:joint.util.deepSupplement({type:"ice.Code",size:{width:384,height:256}},joint.shapes.ice.Model.prototype.defaults)}),joint.shapes.ice.CodeView=joint.shapes.ice.ModelView.extend({initialize:function(){_.bindAll(this,"updateBox"),joint.dia.ElementView.prototype.initialize.apply(this,arguments);var id=sha1(this.model.get("id")).toString().substring(0,6),editorLabel="editor"+id;this.$box=$(joint.util.template('      <div class="code-block">        <div class="code-content"></div>        <div class="code-editor" id="'+editorLabel+'"></div>        <script>          var '+editorLabel+' = ace.edit("'+editorLabel+'");          '+editorLabel+'.setTheme("ace/theme/chrome");          '+editorLabel+".setHighlightActiveLine(false);          "+editorLabel+".setHighlightGutterLine(false);          "+editorLabel+".setAutoScrollEditorIntoView(true);          "+editorLabel+".renderer.setShowGutter(true);          "+editorLabel+".renderer.$cursorLayer.element.style.opacity = 0;          "+editorLabel+'.session.setMode("ace/mode/verilog");        <\/script>        <div class="resizer"/></div>      </div>      ')()),this.editorSelector=this.$box.find(".code-editor"),this.contentSelector=this.$box.find(".code-content"),this.model.on("change",this.updateBox,this),this.model.on("remove",this.removeBox,this),this.listenTo(this.model,"process:ports",this.update),joint.dia.ElementView.prototype.initialize.apply(this,arguments),this.editorSelector.on("mousedown click",function(event){event.stopPropagation()}),this.updateBox(),this.updating=!1,this.prevZoom=0,this.deltas=[],this.counter=0,this.timer=null;var self=this;this.editor=ace.edit(this.editorSelector[0]),this.updateScrollStatus(!1),this.editor.$blockScrolling=1/0,this.editor.commands.removeCommand("undo"),this.editor.commands.removeCommand("redo"),this.editor.commands.removeCommand("touppercase"),this.editor.session.on("change",function(delta){self.updating||(Date.now()-self.counter<200&&clearTimeout(self.timer),self.deltas=self.deltas.concat([delta]),self.timer=setTimeout(function(){var deltas=JSON.parse(JSON.stringify(self.deltas));self.model.set("deltas",deltas),self.deltas=[],self.model.attributes.data.code=self.editor.session.getValue()},200),self.counter=Date.now())}),this.editor.on("focus",function(){self.updateScrollStatus(!0),$(document).trigger("disableSelected"),self.editor.setHighlightActiveLine(!0),self.editor.setHighlightGutterLine(!0),self.editor.renderer.$cursorLayer.element.style.opacity=1}),this.editor.on("blur",function(){self.updateScrollStatus(!1);var selection=self.editor.session.selection;selection&&selection.clearSelection(),self.editor.setHighlightActiveLine(!1),self.editor.setHighlightGutterLine(!1),self.editor.renderer.$cursorLayer.element.style.opacity=0}),this.editor.on("paste",function(e){e.text.startsWith('{"icestudio":')&&(e.text="")}),this.editor.on("mousewheel",function(event){document.activeElement.parentNode.id===self.editorSelector.attr("id")?event.stopPropagation():event.preventDefault()}),this.setupResizer(),this.apply({ini:!0})},applyValue:function(opt){this.updating=!0;var data=this.model.get("data"),deltas=this.model.get("deltas");switch(opt=opt||{},opt.attribute){case"deltas":if(deltas){var changes=[{group:"doc",deltas:deltas}];opt.undo?this.editor.session.undoChanges(changes,!1):this.editor.session.redoChanges(changes,!1)}}opt.ini?this.editor.session.setValue(data.code):this.model.attributes.data.code=this.editor.session.getValue(),setTimeout(function(self){self.updating=!1},10,this)},apply:function(opt){this.applyValue(opt),this.editor&&this.editor.resize()},setAnnotation:function(codeError){this.editor.gotoLine(codeError.line);var annotations=this.editor.session.getAnnotations();annotations.push({row:codeError.line-1,column:0,text:codeError.msg,type:codeError.type}),this.editor.session.setAnnotations(annotations);var self=this,state=this.model.get("state"),annotationSize=Math.round(15*state.zoom)+"px";setTimeout(function(){self.$box.find(".ace_error").css("background-size",annotationSize+" "+annotationSize),self.$box.find(".ace_warning").css("background-size",annotationSize+" "+annotationSize),self.$box.find(".ace_info").css("background-size",annotationSize+" "+annotationSize)},0)},clearAnnotations:function(){this.editor.session.clearAnnotations()},update:function(){this.renderPorts(),this.editor.setReadOnly(this.model.get("disabled")),joint.dia.ElementView.prototype.update.apply(this,arguments)},updateBox:function(){var i,port,bbox=this.model.getBBox(),data=this.model.get("data"),state=this.model.get("state"),rules=this.model.get("rules"),leftPorts=this.model.get("leftPorts"),rightPorts=this.model.get("rightPorts"),modelId=this.model.id;if(this.editor){if(this.prevZoom!==state.zoom){this.prevZoom=state.zoom,this.editorSelector.css({margin:7*state.zoom,"border-radius":5*state.zoom,"border-width":state.zoom+.5});var annotationSize=Math.round(15*state.zoom)+"px";this.$box.find(".ace_error").css("background-size",annotationSize+" "+annotationSize),this.$box.find(".ace_warning").css("background-size",annotationSize+" "+annotationSize),this.$box.find(".ace_info").css("background-size",annotationSize+" "+annotationSize),this.$box.find(".ace_text-layer").css("padding","0px "+Math.round(4*state.zoom)+"px");var rule=getCSSRule(".ace_folding-enabled > .ace_gutter-cell");rule&&(rule.style.paddingLeft=Math.round(19*state.zoom)+"px",rule.style.paddingRight=Math.round(13*state.zoom)+"px"),this.editor.setFontSize(Math.round(aceFontSize*state.zoom)),this.editor.renderer.$cursorLayer.$padding=Math.round(4*state.zoom)}this.editor.resize()}var width=1.5*state.zoom;this.$(".port-wire").css("stroke-width",width);for(i in leftPorts)port=leftPorts[i],port.size>1&&this.$("#port-wire-"+modelId+"-"+port.id).css("stroke-width",3*width);for(i in rightPorts)port=rightPorts[i],port.size>1&&this.$("#port-wire-"+modelId+"-"+port.id).css("stroke-width",3*width);if(data&&data.ports&&data.ports.in)for(i in data.ports.in){port=data.ports.in[i];var portDefault=this.$("#port-default-"+modelId+"-"+port.name);rules&&port.default&&port.default.apply?(portDefault.css("display","inline"),portDefault.find("path").css("stroke-width",width),portDefault.find("rect").css("stroke-width",state.zoom)):portDefault.css("display","none")}this.contentSelector.css({left:Math.round(bbox.width/2*(state.zoom-1)),top:Math.round(bbox.height/2*(state.zoom-1)),width:Math.round(bbox.width),height:Math.round(bbox.height),transform:"scale("+state.zoom+")"}),this.$box.css({left:bbox.x*state.zoom+state.pan.x,top:bbox.y*state.zoom+state.pan.y,width:bbox.width*state.zoom,height:bbox.height*state.zoom})}}),joint.shapes.ice.Info=joint.shapes.ice.Model.extend({defaults:joint.util.deepSupplement({type:"ice.Info",size:{width:400,height:256}},joint.shapes.ice.Model.prototype.defaults)}),joint.shapes.ice.InfoView=joint.shapes.ice.ModelView.extend({initialize:function(){_.bindAll(this,"updateBox"),joint.dia.ElementView.prototype.initialize.apply(this,arguments);var id=sha1(this.model.get("id")).toString().substring(0,6),editorLabel="editor"+id,readonly=this.model.get("data").readonly;this.$box=$(joint.util.template('      <div class="info-block">        <div class="info-render markdown-body'+(readonly?"":" hidden")+'"></div>        <div class="info-content'+(readonly?" hidden":"")+'"></div>        <div class="info-editor'+(readonly?" hidden":"")+'" id="'+editorLabel+'"></div>        <script>          var '+editorLabel+' = ace.edit("'+editorLabel+'");          '+editorLabel+'.setTheme("ace/theme/chrome");          '+editorLabel+".setHighlightActiveLine(false);          "+editorLabel+".setShowPrintMargin(false);          "+editorLabel+".setAutoScrollEditorIntoView(true);          "+editorLabel+".renderer.setShowGutter(false);          "+editorLabel+".renderer.$cursorLayer.element.style.opacity = 0;          "+editorLabel+'.session.setMode("ace/mode/markdown");        <\/script>        <div class="resizer"/></div>      </div>      ')()),this.renderSelector=this.$box.find(".info-render"),this.editorSelector=this.$box.find(".info-editor"),this.contentSelector=this.$box.find(".info-content"),this.model.on("change",this.updateBox,this),this.model.on("remove",this.removeBox,this),this.editorSelector.on("mousedown click",function(event){event.stopPropagation()}),this.updateBox(),this.updating=!1,this.deltas=[],this.counter=0,this.timer=null;var self=this;this.editor=ace.edit(this.editorSelector[0]),this.updateScrollStatus(!1),this.editor.$blockScrolling=1/0,this.editor.commands.removeCommand("undo"),this.editor.commands.removeCommand("redo"),this.editor.commands.removeCommand("touppercase"),this.editor.session.on("change",function(delta){self.updating||(Date.now()-self.counter<200&&clearTimeout(self.timer),self.deltas=self.deltas.concat([delta]),self.timer=setTimeout(function(){var deltas=JSON.parse(JSON.stringify(self.deltas));self.model.set("deltas",deltas),self.deltas=[],self.model.attributes.data.info=self.editor.session.getValue()},200),self.counter=Date.now())}),this.editor.on("focus",function(){self.updateScrollStatus(!0),$(document).trigger("disableSelected"),self.editor.setHighlightActiveLine(!0),self.editor.renderer.$cursorLayer.element.style.opacity=1}),this.editor.on("blur",function(){self.updateScrollStatus(!1);var selection=self.editor.session.selection;selection&&selection.clearSelection(),self.editor.setHighlightActiveLine(!1),self.editor.renderer.$cursorLayer.element.style.opacity=0}),this.editor.on("paste",function(e){e.text.startsWith('{"icestudio":')&&(e.text="")}),this.editor.on("mousewheel",function(event){document.activeElement.parentNode.id===self.editorSelector.attr("id")?event.stopPropagation():event.preventDefault()}),this.setupResizer(),this.apply({ini:!0})},applyValue:function(opt){this.updating=!0;var data=this.model.get("data"),deltas=this.model.get("deltas");switch(opt=opt||{},opt.attribute){case"deltas":if(deltas){var changes=[{group:"doc",deltas:deltas}];opt.undo?this.editor.session.undoChanges(changes,!1):this.editor.session.redoChanges(changes,!1)}}opt.ini?this.editor.session.setValue(data.info):this.model.attributes.data.info=this.editor.session.getValue(),setTimeout(function(self){self.updating=!1},10,this)},applyReadonly:function(){if(this.model.get("data").readonly){this.$box.addClass("info-block-readonly"),this.renderSelector.removeClass("hidden"),this.editorSelector.addClass("hidden"),this.contentSelector.addClass("hidden"),this.disableResizer();var selection=this.editor.session.selection;selection&&selection.clearSelection(),this.applyText()}else this.$box.removeClass("info-block-readonly"),this.renderSelector.addClass("hidden"),this.editorSelector.removeClass("hidden"),this.contentSelector.removeClass("hidden"),this.enableResizer()},applyText:function(){function replaceCheckboxItem(element){listIterator(element);var child=$(element).children().first()[0];child&&"p"===child.localName&&listIterator(child)}function listIterator(element){var $el=$(element),label=$el.clone().children().remove("il, ul").end().html(),detached=$el.children("il, ul");/^\[\s\]/.test(label)?$el.html(renderItemCheckbox(label,"")).append(detached):/^\[x\]/.test(label)&&$el.html(renderItemCheckbox(label,"checked")).append(detached)}function renderItemCheckbox(label,checked){return label=label.substring(3),'<input type="checkbox" '+checked+"/>"+label}var data=this.model.get("data"),markdown=data.text||data.info||"";markdown=markdown.replace(/(:.*:)/g,function(match){return emoji.emojify(match,null,function(code,name){return' <object data="https://github.global.ssl.fastly.net/images/icons/emoji/'+name+'.png" type="image/png" width="20" height="20">'+code+"</object>"})}),this.renderSelector.html(marked(markdown)),this.renderSelector.find("li").each(function(index,element){replaceCheckboxItem(element)}),this.renderSelector.find("a").each(function(index,element){element.onclick=function(event){event.preventDefault(),openurl.open(element.href)}})},apply:function(opt){this.applyValue(opt),this.applyReadonly(),this.updateBox(),this.editor&&this.editor.resize()},render:function(){return joint.dia.ElementView.prototype.render.apply(this,arguments),this.paper.$el.append(this.$box),this.updateBox(),this},update:function(){this.editor.setReadOnly(this.model.get("disabled")),joint.dia.ElementView.prototype.update.apply(this,arguments)},updateBox:function(){var bbox=this.model.getBBox(),state=this.model.get("state");this.model.get("data").readonly?this.renderSelector.css({left:Math.round(bbox.width/2*(state.zoom-1)),top:Math.round(bbox.height/2*(state.zoom-1)),width:Math.round(bbox.width),height:Math.round(bbox.height),transform:"scale("+state.zoom+")","font-size":aceFontSize+"px"}):this.editor&&(this.editorSelector.css({margin:7*state.zoom,"border-radius":5*state.zoom,"border-width":state.zoom+.5}),this.$box.find(".ace_text-layer").css("padding","0px "+Math.round(4*state.zoom)+"px"),this.editor.setFontSize(Math.round(aceFontSize*state.zoom)),this.editor.renderer.$cursorLayer.$padding=Math.round(4*state.zoom),this.editor.resize()),this.contentSelector.css({left:Math.round(bbox.width/2*(state.zoom-1)),top:Math.round(bbox.height/2*(state.zoom-1)),width:Math.round(bbox.width),height:Math.round(bbox.height),transform:"scale("+state.zoom+")"}),this.$box.css({left:bbox.x*state.zoom+state.pan.x,top:bbox.y*state.zoom+state.pan.y,width:bbox.width*state.zoom,height:bbox.height*state.zoom})},removeBox:function(){delete this.model.attributes.data.delta,this.$box.remove()}}),joint.shapes.ice.Wire=joint.dia.Link.extend({markup:['<path class="connection" d="M 0 0 0 0"/>','<path class="connection-wrap" d="M 0 0 0 0"/>','<path class="marker-source" d="M 0 0 0 0"/>','<path class="marker-target" d="M 0 0 0 0"/>','<g class="labels"/>','<g class="marker-vertices"/>','<g class="marker-bifurcations"/>','<g class="marker-arrowheads"/>','<g class="link-tools"/>'].join(""),labelMarkup:['<g class="label hidden">','<rect x="-8" y="-6" width="16" height="12" rx="2" ry="2" fill="white" stroke="#777"/>','<text fill="#555"/>',"</g>"].join(""),bifurcationMarkup:['<g class="marker-bifurcation-group" transform="translate(<%= x %>, <%= y %>)">','<circle class="marker-bifurcation" idx="<%= idx %>" r="<%= r %>" fill="#777"/>',"</g>"].join(""),arrowheadMarkup:['<g class="marker-arrowhead-group marker-arrowhead-group-<%= end %>">','<circle class="marker-arrowhead" end="<%= end %>" r="8"/>',"</g>"].join(""),toolMarkup:['<g class="link-tool">','<g class="tool-remove" event="remove">','<circle r="8" />','<path transform="scale(.6) translate(-16, -16)" d="M24.778,21.419 19.276,15.917 24.777,10.415 21.949,7.585 16.447,13.087 10.945,7.585 8.117,10.415 13.618,15.917 8.116,21.419 10.946,24.248 16.447,18.746 21.948,24.248z" />',"<title>Remove link</title>","</g>","</g>"].join(""),vertexMarkup:['<g class="marker-vertex-group" transform="translate(<%= x %>, <%= y %>)">','<circle class="marker-vertex" idx="<%= idx %>" r="8" />','<path class="marker-vertex-remove-area" idx="<%= idx %>" transform="scale(.8) translate(5, -33)" d="M16,5.333c-7.732,0-14,4.701-14,10.5c0,1.982,0.741,3.833,2.016,5.414L2,25.667l5.613-1.441c2.339,1.317,5.237,2.107,8.387,2.107c7.732,0,14-4.701,14-10.5C30,10.034,23.732,5.333,16,5.333z"/>','<path class="marker-vertex-remove" idx="<%= idx %>" transform="scale(.6) translate(11.5, -39)" d="M24.778,21.419 19.276,15.917 24.777,10.415 21.949,7.585 16.447,13.087 10.945,7.585 8.117,10.415 13.618,15.917 8.116,21.419 10.946,24.248 16.447,18.746 21.948,24.248z">',"<title>Remove vertex</title>","</path>","</g>"].join(""),defaults:joint.util.deepSupplement({type:"ice.Wire",labels:[{position:.5,attrs:{text:{text:"",y:"4px","font-weight":"bold","font-size":"11px","text-anchor":"middle"}}}],attrs:{".connection":{"stroke-width":1.5,stroke:"#777"}},router:{name:"ice"},connector:{name:"ice"}},joint.dia.Link.prototype.defaults)}),joint.shapes.ice.WireView=joint.dia.LinkView.extend({options:{shortLinkLength:64,longLinkLength:160,linkToolsOffset:40},initialize:function(){joint.dia.LinkView.prototype.initialize.apply(this,arguments);var self=this;setTimeout(function(){var size=self.model.get("size");if(!size){var i,port,portName=self.model.get("source").port,rightPorts=self.sourceView.model.get("rightPorts");for(i in rightPorts)if(port=rightPorts[i],portName===port.id){size=port.size,self.model.attributes.size=size;break}}self.updateWireProperties(size),self.updateBifurcations()},0)},apply:function(){},render:function(){return joint.dia.LinkView.prototype.render.apply(this,arguments),this},remove:function(){return joint.dia.LinkView.prototype.remove.apply(this,arguments),this.updateBifurcations(),this},update:function(){return joint.dia.LinkView.prototype.update.apply(this,arguments),this.updateBifurcations(),this},renderLabels:function(){if(!this._V.labels)return this;this._labelCache={};var $labels=$(this._V.labels.node).empty(),labels=this.model.get("labels")||[];if(!labels.length)return this;var labelTemplate=joint.util.template(this.model.get("labelMarkup")||this.model.labelMarkup),labelNodeInstance=V(labelTemplate());return _.each(labels,function(label,idx){var labelNode=labelNodeInstance.clone().node;V(labelNode).attr("label-idx",idx),this._labelCache[idx]=V(labelNode);var $text=$(labelNode).find("text"),textAttributes=_.extend({"text-anchor":"middle","font-size":13},joint.util.getByPath(label,"attrs/text","/"));$text.attr(_.omit(textAttributes,"text")),label.attrs.text.text&&$(labelNode).removeClass("hidden"),_.isUndefined(textAttributes.text)||V($text[0]).text(textAttributes.text+"",{annotations:textAttributes.annotations}),$labels.append(labelNode)},this),this},updateToolsPosition:function(){if(!this._V.linkTools)return this;var scale="",offset=this.options.linkToolsOffset,connectionLength=this.getConnectionLength();if(!_.isNaN(connectionLength)){connectionLength<this.options.shortLinkLength&&(scale="scale(.5)",offset/=2);var toolPosition=this.getPointAtLength(connectionLength-offset);this._toolCache.attr("transform","translate("+toolPosition.x+", "+toolPosition.y+") "+scale)}return this},updateWireProperties:function(size){size>1?(this.$(".connection").css("stroke-width",4.5),this.model.label(0,{attrs:{text:{text:size}}}),this.model.bifurcationMarkup=this.model.bifurcationMarkup.replace(/<%= r %>/g,6)):this.model.bifurcationMarkup=this.model.bifurcationMarkup.replace(/<%= r %>/g,3)},updateConnection:function(opt){opt=opt||{};var route=this.route=this.findRoute(this.model.get("vertices")||[],opt);this._findConnectionPoints(route);var pathData=this.getPathData(route);this._V.connection.attr("d",pathData.full),this._V.connectionWrap&&this._V.connectionWrap.attr("d",pathData.wrap),
this._translateAndAutoOrientArrows(this._V.markerSource,this._V.markerTarget)},updateBifurcations:function(){function findBifurcations(wireA,wireB,markersA){var vA=v(wireA),vB=v(wireB);if(vA.length>2)for(var i=1;i<vA.length-1;i++)if(vA[i-1].x!==vA[i+1].x&&vA[i-1].y!==vA[i+1].y)for(var j=0;j<vB.length-1;j++)if(evalIntersection(vA[i],[vB[j],vB[j+1]])){var point=vA[i];contains(point,points)||(points.push(point),markersA.append(V(markupTemplate(point)).node))}}function contains(point,points){var found=!1;return _.each(points,function(p){if(p.x===point.x&&p.y===point.y)return void(found=!0)}),found}function v(wire){var v=[];return v.push(wire.sourcePoint),v=v.concat(wire.route),v.push({x:wire.targetPoint.x+9,y:wire.targetPoint.y}),v}function evalIntersection(point,segment){return segment[0].x===segment[1].x?point.x===segment[0].x&&point.y>Math.min(segment[0].y,segment[1].y)&&point.y<Math.max(segment[0].y,segment[1].y):point.y===segment[0].y&&point.x>Math.min(segment[0].x,segment[1].x)&&point.x<Math.max(segment[0].x,segment[1].x)}if(this._V.markerBifurcations){var self=this,currentWire=this.model,allWires=this.paper.model.getLinks(),portWires=[];_.each(allWires,function(wire){var wireSource=wire.get("source"),cwireSource=currentWire.get("source");if(wireSource.id===cwireSource.id&&wireSource.port===cwireSource.port){var wireView=self.paper.findViewByModel(wire),markerBifurcations=$(wireView._V.markerBifurcations.node).empty();portWires.push({id:wire.get("id"),view:wireView,markers:markerBifurcations})}});var points=[];if(portWires.length>0){var markupTemplate=joint.util.template(this.model.get("bifurcationMarkup")||this.model.bifurcationMarkup);_.each(portWires,function(wireA){_.each(portWires,function(wireB){wireA.id!==wireB.id&&findBifurcations(wireA.view,wireB.view,wireA.markers)})})}}return this}}),angular.module("icestudio").service("blocks",function(joint,utils,common,gettextCatalog){function newBasic(type,callback){switch(type){case"basic.input":newBasicInput(callback);break;case"basic.output":newBasicOutput(callback);break;case"basic.constant":newBasicConstant(callback);break;case"basic.memory":newBasicMemory(callback);break;case"basic.code":newBasicCode(callback);break;case"basic.info":newBasicInfo(callback)}}function newBasicInput(callback){var blockInstance={id:null,data:{},type:"basic.input",position:{x:0,y:0}},formSpecs=[{type:"text",title:gettextCatalog.getString("Enter the input blocks"),value:""},{type:"checkbox",label:gettextCatalog.getString("FPGA pin"),value:!0},{type:"checkbox",label:gettextCatalog.getString("Show clock"),value:!1}];utils.renderForm(formSpecs,function(evt,values){var labels=values[0].replace(/\s*,\s*/g,",").split(","),virtual=!values[1],clock=values[2];resultAlert&&resultAlert.dismiss(!1);var portInfo,portInfos=[];for(var l in labels){if(!(portInfo=utils.parsePortLabel(labels[l],common.PATTERN_GLOBAL_PORT_LABEL)))return evt.cancel=!0,void(resultAlert=alertify.warning(gettextCatalog.getString("Wrong block name {{name}}",{name:labels[l]})));evt.cancel=!1,portInfos.push(portInfo)}var cells=[];for(var p in portInfos){if(portInfo=portInfos[p],portInfo.rangestr&&clock)return evt.cancel=!0,void(resultAlert=alertify.warning(gettextCatalog.getString("Clock not allowed for data buses")));var pins=getPins(portInfo);blockInstance.data={name:portInfo.name,range:portInfo.rangestr,pins:pins,virtual:virtual,clock:clock},cells.push(loadBasic(blockInstance)),blockInstance.position.y+=(virtual?10:6+4*pins.length)*gridsize}callback&&callback(cells)})}function newBasicOutput(callback){var blockInstance={id:null,data:{},type:"basic.output",position:{x:0,y:0}},formSpecs=[{type:"text",title:gettextCatalog.getString("Enter the output blocks"),value:""},{type:"checkbox",label:gettextCatalog.getString("FPGA pin"),value:!0}];utils.renderForm(formSpecs,function(evt,values){var labels=values[0].replace(/\s*,\s*/g,",").split(","),virtual=!values[1];resultAlert&&resultAlert.dismiss(!1);var portInfo,portInfos=[];for(var l in labels){if(!(portInfo=utils.parsePortLabel(labels[l],common.PATTERN_GLOBAL_PORT_LABEL)))return evt.cancel=!0,void(resultAlert=alertify.warning(gettextCatalog.getString("Wrong block name {{name}}",{name:labels[l]})));evt.cancel=!1,portInfos.push(portInfo)}var cells=[];for(var p in portInfos){portInfo=portInfos[p];var pins=getPins(portInfo);blockInstance.data={name:portInfo.name,range:portInfo.rangestr,pins:pins,virtual:virtual},cells.push(loadBasic(blockInstance)),blockInstance.position.y+=(virtual?10:6+4*pins.length)*gridsize}callback&&callback(cells)})}function getPins(portInfo){var pins=[];if(portInfo.range)for(var r in portInfo.range)pins.push({index:portInfo.range[r].toString(),name:"",value:""});else pins.push({index:"0",name:"",value:""});return pins}function newBasicConstant(callback){var blockInstance={id:null,data:{},type:"basic.constant",position:{x:0,y:0}},formSpecs=[{type:"text",title:gettextCatalog.getString("Enter the constant blocks"),value:""},{type:"checkbox",label:gettextCatalog.getString("Local parameter"),value:!1}];utils.renderForm(formSpecs,function(evt,values){var labels=values[0].replace(/\s*,\s*/g,",").split(","),local=values[1];resultAlert&&resultAlert.dismiss(!1);var paramInfo,paramInfos=[];for(var l in labels){if(!(paramInfo=utils.parseParamLabel(labels[l],common.PATTERN_GLOBAL_PARAM_LABEL)))return evt.cancel=!0,void(resultAlert=alertify.warning(gettextCatalog.getString("Wrong block name {{name}}",{name:labels[l]})));evt.cancel=!1,paramInfos.push(paramInfo)}var cells=[];for(var p in paramInfos)paramInfo=paramInfos[p],blockInstance.data={name:paramInfo.name,value:"",local:local},cells.push(loadBasicConstant(blockInstance)),blockInstance.position.x+=15*gridsize;callback&&callback(cells)})}function newBasicMemory(callback){var blockInstance={id:null,data:{},type:"basic.memory",position:{x:0,y:0},size:{width:96,height:104}},formSpecs=[{type:"text",title:gettextCatalog.getString("Enter the memory blocks"),value:""},{type:"combobox",label:gettextCatalog.getString("Address format"),value:10,options:[{value:2,label:gettextCatalog.getString("Binary")},{value:10,label:gettextCatalog.getString("Decimal")},{value:16,label:gettextCatalog.getString("Hexadecimal")}]},{type:"checkbox",label:gettextCatalog.getString("Local parameter"),value:!1}];utils.renderForm(formSpecs,function(evt,values){var labels=values[0].replace(/\s*,\s*/g,",").split(","),local=values[2],format=parseInt(values[1]);resultAlert&&resultAlert.dismiss(!1);var paramInfo,paramInfos=[];for(var l in labels){if(!(paramInfo=utils.parseParamLabel(labels[l],common.PATTERN_GLOBAL_PARAM_LABEL)))return evt.cancel=!0,void(resultAlert=alertify.warning(gettextCatalog.getString("Wrong block name {{name}}",{name:labels[l]})));evt.cancel=!1,paramInfos.push(paramInfo)}var cells=[];for(var p in paramInfos)paramInfo=paramInfos[p],blockInstance.data={name:paramInfo.name,list:"",local:local,format:format},cells.push(loadBasicMemory(blockInstance)),blockInstance.position.x+=15*gridsize;callback&&callback(cells)})}function newBasicCode(callback,block){var blockInstance={id:null,data:{code:"",params:[],ports:{in:[],out:[]}},type:"basic.code",position:{x:0,y:0},size:{width:192,height:128}},defaultValues=["","",""];if(block){blockInstance=block;var index,port;if(block.data.ports){var inPorts=[];for(index in block.data.ports.in)port=block.data.ports.in[index],inPorts.push(port.name+(port.range||""));defaultValues[0]=inPorts.join(" , ");var outPorts=[];for(index in block.data.ports.out)port=block.data.ports.out[index],outPorts.push(port.name+(port.range||""));defaultValues[1]=outPorts.join(" , ")}if(block.data.params){var params=[];for(index in block.data.params)params.push(block.data.params[index].name);defaultValues[2]=params.join(" , ")}}var formSpecs=[{type:"text",title:gettextCatalog.getString("Enter the input ports"),value:defaultValues[0]},{type:"text",title:gettextCatalog.getString("Enter the output ports"),value:defaultValues[1]},{type:"text",title:gettextCatalog.getString("Enter the parameters"),value:defaultValues[2]}];utils.renderForm(formSpecs,function(evt,values){var inPorts=values[0].replace(/\s*,\s*/g,",").split(","),outPorts=values[1].replace(/\s*,\s*/g,",").split(","),params=values[2].replace(/\s*,\s*/g,",").split(","),allNames=[];resultAlert&&resultAlert.dismiss(!1);var i,inPortInfo,inPortInfos=[];for(i in inPorts)if(inPorts[i]){if(!(inPortInfo=utils.parsePortLabel(inPorts[i],common.PATTERN_PORT_LABEL))||!inPortInfo.name)return evt.cancel=!0,void(resultAlert=alertify.warning(gettextCatalog.getString("Wrong port name {{name}}",{name:inPorts[i]})));evt.cancel=!1,inPortInfos.push(inPortInfo)}var o,outPortInfo,outPortInfos=[];for(o in outPorts)if(outPorts[o]){if(!(outPortInfo=utils.parsePortLabel(outPorts[o],common.PATTERN_PORT_LABEL))||!outPortInfo.name)return evt.cancel=!0,void(resultAlert=alertify.warning(gettextCatalog.getString("Wrong port name {{name}}",{name:outPorts[o]})));evt.cancel=!1,outPortInfos.push(outPortInfo)}var p,paramInfo,paramInfos=[];for(p in params)if(params[p]){if(!(paramInfo=utils.parseParamLabel(params[p],common.PATTERN_PARAM_LABEL)))return evt.cancel=!0,void(resultAlert=alertify.warning(gettextCatalog.getString("Wrong parameter name {{name}}",{name:params[p]})));evt.cancel=!1,paramInfos.push(paramInfo)}var pins;blockInstance.data.ports.in=[];for(i in inPortInfos)inPortInfos[i]&&(pins=getPins(inPortInfos[i]),blockInstance.data.ports.in.push({name:inPortInfos[i].name,range:inPortInfos[i].rangestr,size:pins.length>1?pins.length:void 0}),allNames.push(inPortInfos[i].name));blockInstance.data.ports.out=[];for(o in outPortInfos)outPortInfos[o]&&(pins=getPins(outPortInfos[o]),blockInstance.data.ports.out.push({name:outPortInfos[o].name,range:outPortInfos[o].rangestr,size:pins.length>1?pins.length:void 0}),allNames.push(outPortInfos[o].name));blockInstance.data.params=[];for(p in paramInfos)paramInfos[p]&&(blockInstance.data.params.push({name:paramInfos[p].name}),allNames.push(paramInfos[p].name));allNames.length===$.unique(allNames).length?(evt.cancel=!1,callback&&callback([loadBasicCode(blockInstance)])):(evt.cancel=!0,resultAlert=alertify.warning(gettextCatalog.getString("Duplicated block attributes")))})}function newBasicInfo(callback){var blockInstance={id:null,data:{info:"",readonly:!1},type:"basic.info",position:{x:0,y:0},size:{width:192,height:128}};callback&&callback([loadBasicInfo(blockInstance)])}function newGeneric(type,block,callback){var blockInstance={id:null,type:type,position:{x:0,y:0}};resultAlert&&resultAlert.dismiss(!1),block&&block.design&&block.design.graph&&block.design.graph.blocks&&block.design.graph.wires?callback&&callback(loadGeneric(blockInstance,block)):resultAlert=alertify.error(gettextCatalog.getString("Wrong block format: {{type}}",{type:type}),30)}function loadBasic(instance,disabled){switch(instance.type){case"basic.input":return loadBasicInput(instance,disabled);case"basic.output":return loadBasicOutput(instance,disabled);case"basic.constant":return loadBasicConstant(instance,disabled);case"basic.memory":return loadBasicMemory(instance,disabled);case"basic.code":return loadBasicCode(instance,disabled);case"basic.info":return loadBasicInfo(instance,disabled)}}function loadBasicInput(instance,disabled){var data=instance.data,rightPorts=[{id:"out",name:"",label:"",size:data.pins?data.pins.length:data.size||1}];return new joint.shapes.ice.Input({id:instance.id,blockType:instance.type,data:instance.data,position:instance.position,disabled:disabled,rightPorts:rightPorts,choices:common.pinoutInputHTML})}function loadBasicOutput(instance,disabled){var data=instance.data,leftPorts=[{id:"in",name:"",label:"",size:data.pins?data.pins.length:data.size||1}];return new joint.shapes.ice.Output({id:instance.id,blockType:instance.type,data:instance.data,position:instance.position,disabled:disabled,leftPorts:leftPorts,choices:common.pinoutOutputHTML})}function loadBasicConstant(instance,disabled){var bottomPorts=[{id:"constant-out",name:"",label:""}];return new joint.shapes.ice.Constant({id:instance.id,blockType:instance.type,data:instance.data,position:instance.position,disabled:disabled,bottomPorts:bottomPorts})}function loadBasicMemory(instance,disabled){var bottomPorts=[{id:"memory-out",name:"",label:""}];return new joint.shapes.ice.Memory({id:instance.id,blockType:instance.type,data:instance.data,position:instance.position,size:instance.size,disabled:disabled,bottomPorts:bottomPorts})}function loadBasicCode(instance,disabled){var port,leftPorts=[],rightPorts=[],topPorts=[];for(var i in instance.data.ports.in)port=instance.data.ports.in[i],port.range||(port.default=utils.hasInputRule(port.name)),leftPorts.push({id:port.name,name:port.name,label:port.name+(port.range||""),size:port.size||1});for(var o in instance.data.ports.out)port=instance.data.ports.out[o],rightPorts.push({id:port.name,name:port.name,label:port.name+(port.range||""),size:port.size||1});for(var p in instance.data.params)port=instance.data.params[p],topPorts.push({id:port.name,name:port.name,label:port.name});return new joint.shapes.ice.Code({id:instance.id,blockType:instance.type,data:instance.data,position:instance.position,size:instance.size,disabled:disabled,leftPorts:leftPorts,rightPorts:rightPorts,topPorts:topPorts})}function loadBasicInfo(instance,disabled){return instance.data.info&&instance.data.readonly&&(instance.data.text=gettextCatalog.getString(instance.data.info)),new joint.shapes.ice.Info({id:instance.id,blockType:instance.type,data:instance.data,position:instance.position,size:instance.size,disabled:disabled})}function loadGeneric(instance,block,disabled){var i,leftPorts=[],rightPorts=[],topPorts=[],bottomPorts=[];instance.data={ports:{in:[]}};for(i in block.design.graph.blocks){var item=block.design.graph.blocks[i];"basic.input"===item.type?(item.data.range||instance.data.ports.in.push({name:item.id,default:utils.hasInputRule((item.data.clock?"clk":"")||item.data.name)}),leftPorts.push({id:item.id,name:item.data.name,label:item.data.name+(item.data.range||""),size:item.data.pins?item.data.pins.length:item.data.size||1,clock:item.data.clock})):"basic.output"===item.type?rightPorts.push({id:item.id,name:item.data.name,label:item.data.name+(item.data.range||""),size:item.data.pins?item.data.pins.length:item.data.size||1}):"basic.constant"!==item.type&&"basic.memory"!==item.type||item.data.local||topPorts.push({id:item.id,name:item.data.name,label:item.data.name})}var size=instance.size;if(!size){var numPortsHeight=Math.max(leftPorts.length,rightPorts.length),numPortsWidth=Math.max(topPorts.length,bottomPorts.length);size={width:Math.max(4*gridsize*numPortsWidth,12*gridsize),height:Math.max(4*gridsize*numPortsHeight,8*gridsize)}}var blockLabel=block.package.name,blockImage="";return block.package.image&&(block.package.image.startsWith("%3Csvg")?blockImage=block.package.image:block.package.image.startsWith("<svg")&&(blockImage=encodeURI(block.package.image))),new joint.shapes.ice.Generic({id:instance.id,blockType:instance.type,data:instance.data,config:block.design.config,pullup:block.design.pullup,image:blockImage,label:blockLabel,tooltip:gettextCatalog.getString(block.package.description),position:instance.position,size:size,disabled:disabled,leftPorts:leftPorts,rightPorts:rightPorts,topPorts:topPorts})}function loadWire(instance,source,target){for(var sourceSelector,targetSelector,leftPorts=target.get("leftPorts"),rightPorts=source.get("rightPorts"),_out=0;_out<rightPorts.length;_out++)if(rightPorts[_out]===instance.source.port){sourceSelector=_out;break}for(var _in=0;_in<leftPorts.length;_in++)if(leftPorts[_in]===instance.target.port){targetSelector=_in;break}return new joint.shapes.ice.Wire({source:{id:source.id,selector:sourceSelector,port:instance.source.port},target:{id:target.id,selector:targetSelector,port:instance.target.port},vertices:instance.vertices})}function editBasic(type,cellView,callback){switch(type){case"basic.input":editBasicInput(cellView,callback);break;case"basic.output":editBasicOutput(cellView,callback);break;case"basic.constant":editBasicConstant(cellView);break;case"basic.memory":editBasicMemory(cellView);break;case"basic.code":editBasicCode(cellView,callback);break;case"basic.info":editBasicInfo(cellView)}}function editBasicInput(cellView,callback){var graph=cellView.paper.model,block=cellView.model.attributes,formSpecs=[{type:"text",title:gettextCatalog.getString("Update the block name"),value:block.data.name+(block.data.range||"")},{type:"checkbox",label:gettextCatalog.getString("FPGA pin"),value:!block.data.virtual},{type:"checkbox",label:gettextCatalog.getString("Show clock"),value:block.data.clock}];utils.renderForm(formSpecs,function(evt,values){var oldSize,newSize,offset=0,label=values[0],virtual=!values[1],clock=values[2];resultAlert&&resultAlert.dismiss(!1);var portInfo=utils.parsePortLabel(label,common.PATTERN_GLOBAL_PORT_LABEL);if(portInfo){if(evt.cancel=!1,portInfo.rangestr&&clock)return evt.cancel=!0,void(resultAlert=alertify.warning(gettextCatalog.getString("Clock not allowed for data buses")));if((block.data.range||"")!==(portInfo.rangestr||"")){var pins=getPins(portInfo);oldSize=block.data.virtual?1:block.data.pins?block.data.pins.length:1,newSize=virtual?1:pins?pins.length:1,offset=16*(oldSize-newSize);var blockInstance={id:null,data:{name:portInfo.name,range:portInfo.rangestr,pins:pins,virtual:virtual,clock:clock},type:block.blockType,position:{x:block.position.x,y:block.position.y+offset}};callback&&(graph.startBatch("change"),callback(loadBasic(blockInstance)),cellView.model.remove(),graph.stopBatch("change"),resultAlert=alertify.success(gettextCatalog.getString("Block updated")))}else if(block.data.name!==portInfo.name||block.data.virtual!==virtual||block.data.clock!==clock){var size=block.data.pins?block.data.pins.length:1;oldSize=block.data.virtual?1:size,newSize=virtual?1:size,offset=16*(oldSize-newSize),graph.startBatch("change");var data=utils.clone(block.data);data.name=portInfo.name,data.virtual=virtual,data.clock=clock,cellView.model.set("data",data,{translateBy:cellView.model.id,tx:0,ty:-offset}),cellView.model.translate(0,offset),graph.stopBatch("change"),cellView.apply(),resultAlert=alertify.success(gettextCatalog.getString("Block updated"))}}else evt.cancel=!0,resultAlert=alertify.warning(gettextCatalog.getString("Wrong block name {{name}}",{name:label}))})}function editBasicOutput(cellView,callback){var graph=cellView.paper.model,block=cellView.model.attributes,formSpecs=[{type:"text",title:gettextCatalog.getString("Update the block name"),value:block.data.name+(block.data.range||"")},{type:"checkbox",label:gettextCatalog.getString("FPGA pin"),value:!block.data.virtual}];utils.renderForm(formSpecs,function(evt,values){var oldSize,newSize,offset=0,label=values[0],virtual=!values[1];resultAlert&&resultAlert.dismiss(!1);var portInfo=utils.parsePortLabel(label,common.PATTERN_GLOBAL_PORT_LABEL);if(portInfo){if(evt.cancel=!1,(block.data.range||"")!==(portInfo.rangestr||"")){var pins=getPins(portInfo);oldSize=block.data.virtual?1:block.data.pins?block.data.pins.length:1,newSize=virtual?1:pins?pins.length:1,offset=16*(oldSize-newSize);var blockInstance={id:null,data:{name:portInfo.name,range:portInfo.rangestr,pins:pins,virtual:virtual},type:block.blockType,position:{x:block.position.x,y:block.position.y+offset}};callback&&(graph.startBatch("change"),callback(loadBasic(blockInstance)),cellView.model.remove(),graph.stopBatch("change"),resultAlert=alertify.success(gettextCatalog.getString("Block updated")))}else if(block.data.name!==portInfo.name||block.data.virtual!==virtual){var size=block.data.pins?block.data.pins.length:1;oldSize=block.data.virtual?1:size,newSize=virtual?1:size,offset=16*(oldSize-newSize),graph.startBatch("change");var data=utils.clone(block.data);data.name=portInfo.name,data.virtual=virtual,cellView.model.set("data",data,{translateBy:cellView.model.id,tx:0,ty:-offset}),cellView.model.translate(0,offset),graph.stopBatch("change"),cellView.apply(),resultAlert=alertify.success(gettextCatalog.getString("Block updated"))}}else evt.cancel=!0,resultAlert=alertify.warning(gettextCatalog.getString("Wrong block name {{name}}",{name:label}))})}function editBasicConstant(cellView){var block=cellView.model.attributes,formSpecs=[{type:"text",title:gettextCatalog.getString("Update the block name"),value:block.data.name},{type:"checkbox",label:gettextCatalog.getString("Local parameter"),value:block.data.local}];utils.renderForm(formSpecs,function(evt,values){var label=values[0],local=values[1];resultAlert&&resultAlert.dismiss(!1);var paramInfo=utils.parseParamLabel(label,common.PATTERN_GLOBAL_PARAM_LABEL);if(!paramInfo)return evt.cancel=!0,void(resultAlert=alertify.warning(gettextCatalog.getString("Wrong block name {{name}}",{name:label})));var name=paramInfo.name;if(evt.cancel=!1,block.data.name!==name||block.data.local!==local){var data=utils.clone(block.data);data.name=name,data.local=local,cellView.model.set("data",data),cellView.apply(),resultAlert=alertify.success(gettextCatalog.getString("Block updated"))}})}function editBasicMemory(cellView){var block=cellView.model.attributes,formSpecs=[{type:"text",title:gettextCatalog.getString("Update the block name"),value:block.data.name},{type:"combobox",label:gettextCatalog.getString("Address format"),value:block.data.format,options:[{value:2,label:gettextCatalog.getString("Binary")},{value:10,label:gettextCatalog.getString("Decimal")},{value:16,label:gettextCatalog.getString("Hexadecimal")}]},{type:"checkbox",label:gettextCatalog.getString("Local parameter"),value:block.data.local}];utils.renderForm(formSpecs,function(evt,values){var label=values[0],local=values[2],format=parseInt(values[1]);resultAlert&&resultAlert.dismiss(!1);var paramInfo=utils.parseParamLabel(label,common.PATTERN_GLOBAL_PARAM_LABEL);if(!paramInfo)return evt.cancel=!0,void(resultAlert=alertify.warning(gettextCatalog.getString("Wrong block name {{name}}",{name:label})));var name=paramInfo.name;if(evt.cancel=!1,block.data.name!==name||block.data.local!==local||block.data.format!==format){var data=utils.clone(block.data);data.name=name,data.local=local,data.format=format,cellView.model.set("data",data),cellView.apply(),resultAlert=alertify.success(gettextCatalog.getString("Block updated"))}})}function editBasicCode(cellView,callback){var graph=cellView.paper.model,block=cellView.model.attributes,blockInstance={id:block.id,data:utils.clone(block.data),type:"basic.code",position:block.position,size:block.size};resultAlert&&resultAlert.dismiss(!1),newBasicCode(function(cells){if(callback){var cell=cells[0];if(cell){var connectedWires=graph.getConnectedLinks(cellView.model);graph.startBatch("change"),cellView.model.remove(),callback(cell);for(var w in connectedWires){var wire=connectedWires[w],size=wire.get("size"),source=wire.get("source"),target=wire.get("target");(source.id===cell.id&&containsPort(source.port,size,cell.get("rightPorts"))||target.id===cell.id&&containsPort(target.port,size,cell.get("leftPorts"))&&"constant-out"!==source.port&&"memory-out"!==source.port||target.id===cell.id&&containsPort(target.port,size,cell.get("topPorts"))&&("constant-out"===source.port||"memory-out"===source.port))&&graph.addCell(wire)}graph.stopBatch("change"),resultAlert=alertify.success(gettextCatalog.getString("Block updated"))}}},blockInstance)}function containsPort(port,size,ports){var found=!1;for(var i in ports)if(port===ports[i].name&&size===ports[i].size){found=!0;break}return found}function editBasicInfo(cellView){var block=cellView.model.attributes,data=utils.clone(block.data);data.readonly=!data.readonly,data.info&&data.readonly&&(data.text=gettextCatalog.getString(data.info)),cellView.model.set("data",data),cellView.apply()}var gridsize=8,resultAlert=null;this.newBasic=newBasic,this.newGeneric=newGeneric,this.loadBasic=loadBasic,this.loadGeneric=loadGeneric,this.loadWire=loadWire,this.editBasic=editBasic}),angular.module("icestudio").service("boards",function(utils,common,nodeFs,nodePath){function readJSONFile(filepath,filename){var ret={};try{var data=nodeFs.readFileSync(nodePath.join(filepath,filename));ret=JSON.parse(data)}catch(err){}return ret}function generateHTMLOptions(pinout,type){var code="<option></option>";for(var i in pinout)pinout[i].type!==type&&"inout"!==pinout[i].type||(code+='<option value="'+pinout[i].value+'">'+pinout[i].name+"</option>");return code}this.loadBoards=function(){var boards=[],path=nodePath.join("resources","boards"),menu=nodeFs.readFileSync(nodePath.join(path,"menu.json"));JSON.parse(menu).forEach(function(section){section.boards.forEach(function(name){var contentPath=nodePath.join(path,name);if(nodeFs.statSync(contentPath).isDirectory()){var info=readJSONFile(contentPath,"info.json"),pinout=readJSONFile(contentPath,"pinout.json"),rules=readJSONFile(contentPath,"rules.json");boards.push({name:name,info:info,pinout:pinout,rules:rules,type:section.type})}})}),common.boards=boards},this.selectBoard=function(name){name=name||"icezum";var i,selectedBoard=null;for(i in common.boards)if(common.boards[i].name===name){selectedBoard=common.boards[i];break}if(null===selectedBoard)for(i in common.boards)if("icezum"===common.boards[i].name){selectedBoard=common.boards[i];break}return common.selectedBoard=selectedBoard,common.pinoutInputHTML=generateHTMLOptions(common.selectedBoard.pinout,"input"),common.pinoutOutputHTML=generateHTMLOptions(common.selectedBoard.pinout,"output"),utils.rootScopeSafeApply(),common.selectedBoard},this.boardLabel=function(name){for(var i in common.boards)if(common.boards[i].name===name)return common.boards[i].info.label;return name}}),angular.module("icestudio").service("common",function(nodePath,nodeTmp){this.VERSION="1.2",this.hasChangesSinceBuild=!1,this.allDependencies={},this.boards=[],this.selectedBoard=null,this.pinoutInputHTML="",this.pinoutOutputHTML="",this.defaultCollection=null,this.internalCollections=[],this.externalCollections=[],this.selectedCollection=null,this.FPGAResources={ffs:"-",luts:"-",pios:"-",plbs:"-",brams:"-"},this.commandOutput="",this.APIO_PIP_VCS="git+https://github.com/FPGAwars/apio.git@%BRANCH%#egg=apio",this.LINUX=Boolean(process.platform.indexOf("linux")>-1),this.WIN32=Boolean(process.platform.indexOf("win32")>-1),this.DARWIN=Boolean(process.platform.indexOf("darwin")>-1),this.LOCALE_DIR=nodePath.join("resources","locale"),this.SAMPLE_DIR=nodePath.join("resources","sample"),this.DEFAULT_COLLECTION_DIR=nodePath.resolve(nodePath.join("resources","collection")),this.BASE_DIR=process.env.HOME||process.env.USERPROFILE,this.ICESTUDIO_DIR=function(_dir,self){if(self.WIN32)for(var i in _dir)if(_dir[i].charCodeAt(0)>127){const _dirFormat=nodePath.parse(_dir);return nodePath.format({root:_dirFormat.root,dir:_dirFormat.root,base:".icestudio",name:".icestudio"})}return _dir}(nodePath.join(this.BASE_DIR,".icestudio"),this),this.INTERNAL_COLLECTIONS_DIR=nodePath.join(this.ICESTUDIO_DIR,"collections"),this.APIO_HOME_DIR=nodePath.join(this.ICESTUDIO_DIR,"apio"),this.PROFILE_PATH=nodePath.join(this.ICESTUDIO_DIR,"profile.json"),this.CACHE_DIR=nodePath.join(this.ICESTUDIO_DIR,".cache"),this.OLD_BUILD_DIR=nodePath.join(this.ICESTUDIO_DIR,".build"),this.VENV="virtualenv-15.2.0",this.VENV_DIR=nodePath.join(this.CACHE_DIR,this.VENV),this.VENV_ZIP=nodePath.join("resources","virtualenv",this.VENV+".zip"),this.APP_DIR=nodePath.dirname(process.execPath),this.TOOLCHAIN_DIR=nodePath.join(this.APP_DIR,"toolchain"),this.DEFAULT_PYTHON_PACKAGES="default-python-packages",this.DEFAULT_PYTHON_PACKAGES_DIR=nodePath.join(this.CACHE_DIR,this.DEFAULT_PYTHON_PACKAGES),this.DEFAULT_PYTHON_PACKAGES_ZIP=nodePath.join(this.TOOLCHAIN_DIR,this.DEFAULT_PYTHON_PACKAGES+".zip"),this.DEFAULT_APIO="default-apio",this.DEFAULT_APIO_DIR=nodePath.join(this.CACHE_DIR,this.DEFAULT_APIO),this.DEFAULT_APIO_ZIP=nodePath.join(this.TOOLCHAIN_DIR,this.DEFAULT_APIO+".zip"),this.DEFAULT_APIO_PACKAGES="default-apio-packages",this.DEFAULT_APIO_PACKAGES_ZIP=nodePath.join(this.TOOLCHAIN_DIR,this.DEFAULT_APIO_PACKAGES+".zip"),this.ENV_DIR=nodePath.join(this.ICESTUDIO_DIR,"venv"),this.ENV_BIN_DIR=nodePath.join(this.ENV_DIR,this.WIN32?"Scripts":"bin"),this.ENV_PIP=nodePath.join(this.ENV_BIN_DIR,"pip"),this.ENV_APIO=nodePath.join(this.ENV_BIN_DIR,this.WIN32?"apio.exe":"apio"),this.APIO_CMD=(this.WIN32?"set":"export")+" APIO_HOME_DIR="+this.APIO_HOME_DIR+(this.WIN32?"& ":"; ")+'"'+this.ENV_APIO+'"',this.BUILD_DIR_OBJ=new nodeTmp.dirSync({prefix:"icestudio-",unsafeCleanup:!0}),this.BUILD_DIR=this.BUILD_DIR_OBJ.name,this.PATTERN_PORT_LABEL=/^([A-Za-z_][A-Za-z_$0-9]*)?(\[([0-9]+):([0-9]+)\])?$/,this.PATTERN_PARAM_LABEL=/^([A-Za-z_][A-Za-z_$0-9]*)?$/,this.PATTERN_GLOBAL_PORT_LABEL=/^([^\[\]]+)?(\[([0-9]+):([0-9]+)\])?$/,this.PATTERN_GLOBAL_PARAM_LABEL=/^([^\[\]]+)?$/,this.showToolchain=function(){return this.selectedBoard&&"GPIO"!==this.selectedBoard.info.interface||!1},this.showDrivers=function(){return this.selectedBoard&&("FTDI"===this.selectedBoard.info.interface||"Serial"===this.selectedBoard.info.interface)||!1}}),angular.module("icestudio").service("compiler",function(common,utils,nodeSha1,_package){function header(comment,opt){var header="",date=new Date;return opt=opt||{},!1!==opt.header&&(header+=comment+" Code generated by Icestudio "+_package.version+"\n",!1!==opt.datetime&&(header+=comment+" "+date.toUTCString()+"\n"),header+="\n"),header}function module(data){var code="";if(data&&data.name&&data.ports){code+="\nmodule "+data.name;var params=[];for(var p in data.params)data.params[p]instanceof Object&&params.push(" parameter "+data.params[p].name+" = "+(data.params[p].value?data.params[p].value:"0"));params.length>0&&(code+=" #(\n",code+=params.join(",\n"),code+="\n)");var ports=[];for(var i in data.ports.in){var _in=data.ports.in[i];ports.push(" input "+(_in.range?_in.range+" ":"")+_in.name)}for(var o in data.ports.out){var _out=data.ports.out[o];ports.push(" output "+(_out.range?_out.range+" ":"")+_out.name)}if(ports.length>0&&(code+=" (\n",code+=ports.join(",\n"),code+="\n)"),0===params.length&&0===ports.length&&(code+="\n"),code+=";\n",data.content){var content=data.content.split("\n");content.forEach(function(element,index,array){array[index]=" "+element}),code+=content.join("\n")}code+="\nendmodule\n"}return code}function getParams(project){var params=[],graph=project.design.graph;for(var i in graph.blocks){var block=graph.blocks[i];if("basic.constant"===block.type)params.push({name:utils.digestId(block.id),value:block.data.value});else if("basic.memory"===block.type){var name=utils.digestId(block.id);params.push({name:name,value:'"'+name+'.list"'})}}return params}function getPorts(project){var ports={in:[],out:[]},graph=project.design.graph;for(var i in graph.blocks){var block=graph.blocks[i];"basic.input"===block.type?ports.in.push({name:utils.digestId(block.id),range:block.data.range?block.data.range:""}):"basic.output"===block.type&&ports.out.push({name:utils.digestId(block.id),range:block.data.range?block.data.range:""})}return ports}function getContent(name,project){var i,j,w,content=[],graph=project.design.graph,connections={localparam:[],wire:[],assign:[]};for(w in graph.wires){var wire=graph.wires[w];if("constant-out"===wire.source.port||"memory-out"===wire.source.port){var constantBlock=findBlock(wire.source.block,graph),paramValue=utils.digestId(constantBlock.id);paramValue&&connections.localparam.push("localparam p"+w+" = "+paramValue+";")}else{var range=wire.size?" [0:"+(wire.size-1)+"] ":" ";connections.wire.push("wire"+range+"w"+w+";")}for(i in graph.blocks){var block=graph.blocks[i];"basic.input"===block.type?wire.source.block===block.id&&connections.assign.push("assign w"+w+" = "+utils.digestId(block.id)+";"):"basic.output"===block.type&&wire.target.block===block.id&&("constant-out"===wire.source.port||"memory-out"===wire.source.port||connections.assign.push("assign "+utils.digestId(block.id)+" = w"+w+";"))}}content=content.concat(connections.localparam),
content=content.concat(connections.wire),content=content.concat(connections.assign);var numWires=graph.wires.length;for(i=1;i<numWires;i++)for(j=0;j<i;j++){var wi=graph.wires[i],wj=graph.wires[j];wi.source.block===wj.source.block&&wi.source.port===wj.source.port&&"constant-out"!==wi.source.port&&"memory-out"!==wi.source.port&&content.push("assign w"+i+" = w"+j+";")}return content=content.concat(getInstances(name,project.design.graph)),content.join("\n")}function getInstances(name,graph){function connectPort(portName,portsNames,ports,block){if(portName&&("basic.code"!==block.type&&(portName=utils.digestId(portName)),-1===portsNames.indexOf(portName))){portsNames.push(portName);var port="";port+=" ."+portName,port+="(w"+w+")",ports.push(port)}}var w,wire,instances=[],blocks=graph.blocks;for(var b in blocks){var block=blocks[b];if("basic.input"!==block.type&&"basic.output"!==block.type&&"basic.constant"!==block.type&&"basic.memory"!==block.type&&"basic.info"!==block.type){var instance;instance="basic.code"===block.type?name+"_"+utils.digestId(block.id):utils.digestId(block.type);var params=[];for(w in graph.wires)if(wire=graph.wires[w],block.id===wire.target.block&&("constant-out"===wire.source.port||"memory-out"===wire.source.port)){var paramName=wire.target.port;"basic.code"!==block.type&&(paramName=utils.digestId(paramName));var param="";param+=" ."+paramName,param+="(p"+w+")",params.push(param)}params.length>0&&(instance+=" #(\n"+params.join(",\n")+"\n)"),instance+=" "+utils.digestId(block.id);var ports=[],portsNames=[];for(w in graph.wires)wire=graph.wires[w],block.id===wire.source.block&&connectPort(wire.source.port,portsNames,ports,block),block.id===wire.target.block&&"constant-out"!==wire.source.port&&"memory-out"!==wire.source.port&&connectPort(wire.target.port,portsNames,ports,block);instance+=" (\n"+ports.join(",\n")+"\n);",instance&&instances.push(instance)}}return instances}function findBlock(id,graph){for(var b in graph.blocks)if(graph.blocks[b].id===id)return graph.blocks[b];return null}function getInitPorts(project){var i,j,initPorts=[],blocks=project.design.graph.blocks;for(i in blocks){var block=blocks[i];if(block&&("basic.code"===block.type||!block.type.startsWith("basic.")))for(j in block.data.ports.in){var inPort=block.data.ports.in[j];inPort.default&&inPort.default.apply&&initPorts.push({block:block.id,port:inPort.name,name:inPort.default.port,pin:inPort.default.pin})}}return initPorts}function getInitPins(project){var i,initPins=[],usedPins=[],blocks=project.design.graph.blocks;for(i in blocks){var block=blocks[i];if("basic.output"===block.type)for(var p in block.data.pins)usedPins.push(block.data.virtual?"":block.data.pins[p].value)}var allInitPins=common.selectedBoard.rules.output;for(i in allInitPins)-1===usedPins.indexOf(allInitPins[i].pin)&&initPins.push(allInitPins[i]);return initPins}function verilogCompiler(name,project,opt){var i,data,block,code="";if(opt=opt||{},project&&project.design&&project.design.graph){var blocks=project.design.graph.blocks,dependencies=project.dependencies;if(name){if("main"===name&&opt.boardRules){var initPorts=opt.initPorts||getInitPorts(project);for(i in initPorts){var initPort=initPorts[i],found=!1,source={block:initPort.name,port:"out"};for(i in blocks)if(block=blocks[i],"basic.input"===block.type&&!block.data.range&&!block.data.virtual&&initPort.pin===block.data.pins[0].value){found=!0,source.block=block.id;break}found||project.design.graph.blocks.push({id:initPort.name,type:"basic.input",data:{name:initPort.name,pins:[{index:"0",value:initPort.pin}],virtual:!1}}),project.design.graph.wires.push({source:{block:source.block,port:source.port},target:{block:initPort.block,port:initPort.port}})}}var params=getParams(project),ports=getPorts(project),content=getContent(name,project);if("main"===name&&opt.boardRules){var initPins=opt.initPins||getInitPins(project),n=initPins.length;if(n>0){ports.out.push({name:"vinit",range:"[0:"+(n-1)+"]"});var value=n.toString()+"'b";for(i in initPins)value+=initPins[i].bit;content+="\nassign vinit = "+value+";"}}data={name:name,params:params,ports:ports,content:content},code+=module(data)}for(var d in dependencies)code+=verilogCompiler(utils.digestId(d),dependencies[d]);for(i in blocks)(block=blocks[i])&&"basic.code"===block.type&&(data={name:name+"_"+utils.digestId(block.id),params:block.data.params,ports:block.data.ports,content:block.data.code},code+=module(data))}return code}function pcfCompiler(project,opt){var i,j,block,pin,value,code="",blocks=project.design.graph.blocks;opt=opt||{};for(i in blocks)if(block=blocks[i],"basic.input"===block.type||"basic.output"===block.type)if(block.data.pins.length>1)for(var p in block.data.pins)pin=block.data.pins[p],value=block.data.virtual?"":pin.value,code+="set_io ",code+=utils.digestId(block.id),code+="["+pin.index+"] ",code+=value,code+="\n";else block.data.pins.length>0&&(pin=block.data.pins[0],value=block.data.virtual?"":pin.value,code+="set_io ",code+=utils.digestId(block.id),code+=" ",code+=value,code+="\n");if(opt.boardRules){var used=[],initPorts=opt.initPorts||getInitPorts(project);for(i in initPorts){var initPort=initPorts[i];if(-1!==used.indexOf(initPort.pin))break;used.push(initPort.pin);var found=!1;for(j in blocks)if(block=blocks[j],"basic.input"===block.type&&!block.data.range&&!block.data.virtual&&initPort.pin===block.data.pins[0].value){found=!0,used.push(initPort.pin);break}found||(code+="set_io v",code+=initPorts[i].name,code+=" ",code+=initPorts[i].pin,code+="\n")}var initPins=opt.initPins||getInitPins(project);if(initPins.length>1)for(i in initPins)code+="set_io vinit["+i+"] ",code+=initPins[i].pin,code+="\n";else initPins.length>0&&(code+="set_io vinit ",code+=initPins[0].pin,code+="\n")}return code}function listCompiler(project){var i,listFiles=[];if(project&&project.design&&project.design.graph){var blocks=project.design.graph.blocks,dependencies=project.dependencies;for(i in blocks){var block=blocks[i];"basic.memory"===block.type&&listFiles.push({name:utils.digestId(block.id)+".list",content:block.data.list})}for(i in dependencies){var dependency=dependencies[i];listFiles=listFiles.concat(listCompiler(dependency))}}return listFiles}function testbenchCompiler(project){var i,o,p,code="";code+="// Testbench template\n\n",code+="`default_nettype none\n",code+='`define DUMPSTR(x) `"x.vcd`"\n',code+="`timescale 10 ns / 1 ns\n\n";var ports={in:[],out:[]},content="\n";content+="// Simulation time: 100ns (10 * 10ns)\n",content+="parameter DURATION = 10;\n";var _params=[],params=mainParams(project);if(params.length>0){content+="\n// TODO: edit the module parameters here\n",content+="// e.g. localparam constant_value = 1;\n";for(p in params)content+="localparam "+params[p].name+" = "+params[p].value+";\n",_params.push(" ."+params[p].id+"("+params[p].name+")")}var io=mainIO(project),input=io.input,output=io.output;content+="\n// Input/Output\n";var _ports=[];for(i in input)content+="reg "+(input[i].range?input[i].range+" ":"")+input[i].name+";\n",_ports.push(" ."+input[i].id+"("+input[i].name+")");for(o in output)content+="wire "+(output[o].range?output[o].range+" ":"")+output[o].name+";\n",_ports.push(" ."+output[o].id+"("+output[o].name+")");content+="\n// Module instance\n",content+="main",_params.length>0&&(content+=" #(\n",content+=_params.join(",\n"),content+="\n)"),content+=" MAIN",_ports.length>0&&(content+=" (\n",content+=_ports.join(",\n"),content+="\n)"),content+=";\n";var hasClk=!1;for(i in input)if("clk"===input[i].name.toLowerCase()){hasClk=!0;break}hasClk&&(content+="\n// Clock signal\n",content+="always #0.5 clk = ~clk;\n"),content+="\ninitial begin\n",content+=" // File were to store the simulation results\n",content+=" $dumpfile(`DUMPSTR(`VCD_OUTPUT));\n",content+=" $dumpvars(0, main_tb);\n\n",content+=" // TODO: initialize the registers here\n",content+=" // e.g. value = 1;\n",content+=" // e.g. #2 value = 0;\n";for(i in input)content+=" "+input[i].name+" = 0;\n";return content+="\n",content+=' #(DURATION) $display("End of simulation");\n',content+=" $finish;\n",content+="end\n",code+=module({name:"main_tb",ports:ports,content:content})}function gtkwaveCompiler(project){var code="",io=mainIO(project),input=io.input,output=io.output;for(var i in input)code+="main_tb."+input[i].name+(input[i].range?input[i].range:"")+"\n";for(var o in output)code+="main_tb."+output[o].name+(output[o].range?output[o].range:"")+"\n";return code}function mainIO(project){var input=[],output=[],inputUnnamed=0,outputUnnamed=0,graph=project.design.graph;for(var i in graph.blocks){var block=graph.blocks[i];"basic.input"===block.type?block.data.name?input.push({id:utils.digestId(block.id),name:block.data.name.replace(/ /g,"_"),range:block.data.range}):(input.push({id:utils.digestId(block.id),name:inputUnnamed.toString()}),inputUnnamed+=1):"basic.output"===block.type&&(block.data.name?output.push({id:utils.digestId(block.id),name:block.data.name.replace(/ /g,"_"),range:block.data.range}):(output.push({id:utils.digestId(block.id),name:outputUnnamed.toString()}),outputUnnamed+=1))}return{input:input,output:output}}function mainParams(project){var params=[],paramsUnnamed=0,graph=project.design.graph;for(var i in graph.blocks){var block=graph.blocks[i];"basic.constant"===block.type&&(block.data.local||(block.data.name?params.push({id:utils.digestId(block.id),name:"constant_"+block.data.name.replace(/ /g,"_"),value:block.data.value}):(params.push({id:utils.digestId(block.id),name:"constant_"+paramsUnnamed.toString(),value:block.data.value}),paramsUnnamed+=1)))}return params}this.generate=function(target,project,opt){var content="",files=[];switch(target){case"verilog":content+=header("//",opt),content+="`default_nettype none\n",content+=verilogCompiler("main",project,opt),files.push({name:"main.v",content:content});break;case"pcf":content+=header("#",opt),content+=pcfCompiler(project,opt),files.push({name:"main.pcf",content:content});break;case"list":files=listCompiler(project);break;case"testbench":content+=header("//",opt),content+=testbenchCompiler(project),files.push({name:"main_tb.v",content:content});break;case"gtkwave":content+=header("[*]",opt),content+=gtkwaveCompiler(project),files.push({name:"main_tb.gtkw",content:content})}return files},this.getInitPorts=getInitPorts,this.getInitPins=getInitPins}),angular.module("icestudio").service("drivers",function(gettextCatalog,profile,common,gui,utils,nodePath,nodeSudo,nodeChildProcess,$rootScope){function enableDriversFTDI(){common.WIN32?enableWindowsDriversFTDI():common.DARWIN?enableDarwinDriversFTDI():enableLinuxDriversFTDI()}function disableDriversFTDI(){common.WIN32?disableWindowsDriversFTDI():common.DARWIN?disableDarwinDriversFTDI():disableLinuxDriversFTDI()}function enableDriversSerial(){common.WIN32?enableWindowsDriversSerial():common.DARWIN?enableDarwinDriversSerial():enableLinuxDriversSerial()}function disableDriversSerial(){common.WIN32?disableWindowsDriversSerial():common.DARWIN?disableDarwinDriversSerial():disableLinuxDriversSerial()}function enableLinuxDriversFTDI(){var rules="";rules+='ATTRS{idVendor}==\\"0403\\", ATTRS{idProduct}==\\"6010\\", ',rules+='MODE=\\"0660\\", GROUP=\\"plugdev\\", TAG+=\\"uaccess\\"\n',rules+='ATTRS{idVendor}==\\"0403\\", ATTRS{idProduct}==\\"6014\\", ',rules+='MODE=\\"0660\\", GROUP=\\"plugdev\\", TAG+=\\"uaccess\\"',configureLinuxDrivers(["echo '"+rules+"' > /etc/udev/rules.d/80-fpga-ftdi.rules"].concat(reloadRules()),function(){alertify.success(gettextCatalog.getString("Drivers enabled"))})}function disableLinuxDriversFTDI(){configureLinuxDrivers(["rm -f /etc/udev/rules.d/80-icestick.rules","rm -f /etc/udev/rules.d/80-fpga-ftdi.rules"].concat(reloadRules()),function(){alertify.warning(gettextCatalog.getString("Drivers disabled"))})}function enableLinuxDriversSerial(){var rules="";rules+="# Disable ModemManager for BlackIce\n",rules+='ATTRS{idVendor}==\\"0483\\", ATTRS{idProduct}==\\"5740\\", ENV{ID_MM_DEVICE_IGNORE}=\\"1\\"\n',rules+="# Disable ModemManager for TinyFPGA B2\n",rules+='ATTRS{idVendor}==\\"1209\\", ATTRS{idProduct}==\\"2100\\", ENV{ID_MM_DEVICE_IGNORE}=\\"1\\"',rules+="# Disable ModemManager for TinyFPGA BX\n",rules+='ATTRS{idVendor}==\\"1d50\\", ATTRS{idProduct}==\\"6130\\", ENV{ID_MM_DEVICE_IGNORE}=\\"1\\"',configureLinuxDrivers(["echo '"+rules+"' > /etc/udev/rules.d/80-fpga-serial.rules"].concat(reloadRules()),function(){alertify.success(gettextCatalog.getString("Drivers enabled"))})}function disableLinuxDriversSerial(){configureLinuxDrivers(["rm -f /etc/udev/rules.d/80-fpga-serial.rules"].concat(reloadRules()),function(){alertify.warning(gettextCatalog.getString("Drivers disabled"))})}function reloadRules(){return["udevadm control --reload-rules","udevadm trigger","service udev restart"]}function configureLinuxDrivers(commands,callback){var command='sh -c "'+commands.join("; ")+'"';utils.beginBlockingTask(),nodeSudo.exec(command,{name:"Icestudio"},function(error){utils.endBlockingTask(),error||(callback&&callback(),setTimeout(function(){alertify.message(gettextCatalog.getString("<b>Unplug</b> and <b>reconnect</b> the board"),5)},1e3))})}function enableDarwinDriversFTDI(){enableDarwinDrivers(["libftdi","libffi"],"macosFTDIDrivers")}function disableDarwinDriversFTDI(){disableDarwinDrivers("macosFTDIDrivers")}function enableDarwinDriversSerial(){enableDarwinDrivers(["libusb","libffi"])}function disableDarwinDriversSerial(){disableDarwinDrivers()}function enableDarwinDrivers(brewPackages,profileSetting){var brewCommands=["/usr/local/bin/brew update"];for(var i in brewPackages)brewCommands=brewCommands.concat(brewInstall(brewPackages[i]));utils.beginBlockingTask(),nodeChildProcess.exec(brewCommands.join("; "),function(error,stdout,stderr){error?-1!==stderr.indexOf("brew: command not found")||-1!==stderr.indexOf("brew: No such file or directory")?alertify.warning(gettextCatalog.getString("{{app}} is required.",{app:"<b>Homebrew</b>"})+"<br><u>"+gettextCatalog.getString("Click here to install it")+"</u>",30).callback=function(isClicked){isClicked&&gui.Shell.openExternal("https://brew.sh")}:-1!==stderr.indexOf("Error: Failed to download")?alertify.error(gettextCatalog.getString("Internet connection required"),30):alertify.error(stderr,30):(profileSetting&&profile.set(profileSetting,!0),alertify.success(gettextCatalog.getString("Drivers enabled"))),utils.endBlockingTask()})}function disableDarwinDrivers(profileSetting){profileSetting&&profile.set(profileSetting,!1),alertify.warning(gettextCatalog.getString("Drivers disabled"))}function brewInstall(brewPackage){return["/usr/local/bin/brew install --force "+brewPackage,"/usr/local/bin/brew unlink "+brewPackage,"/usr/local/bin/brew link --force "+brewPackage]}function preUploadDarwin(callback){if(profile.get("macosFTDIDrivers")){var driverA="com.FTDI.driver.FTDIUSBSerialDriver",driverB="com.apple.driver.AppleUSBFTDI";checkDriverDarwin(driverA)?(driverC=driverA,processDriverDarwin(driverA,!1,callback)):checkDriverDarwin(driverB)?(driverC=driverB,processDriverDarwin(driverB,!1,callback)):(driverC="",callback&&callback())}else callback&&callback()}function postUploadDarwin(){profile.get("macosFTDIDrivers")&&processDriverDarwin(driverC,!0)}function checkDriverDarwin(driver){return nodeChildProcess.execSync("kextstat").toString().indexOf(driver)>-1}function processDriverDarwin(driver,load,callback){if(driver){var command=(load?"kextload":"kextunload")+" -b "+driver;nodeSudo.exec(command,{name:"Icestudio"},function(){callback&&callback()})}else callback&&callback()}function enableWindowsDriversFTDI(){var message=gettextCatalog.getString("<h4>FTDI driver installation instructions</h4><ol><li>Connect the FPGA board to the USB and wait until Windows finishes the default installation of the driver</li><li>When the OK button is clicked, the FTDI driver installer will be launched in a new window</li><li>In the installer, replace the <b>(Interface 0)</b> driver of the board by <b>libusbK</b></li><li>Unplug and reconnect the board</li></ol>")+gettextCatalog.getString("It is recommended to use <b>USB 2.0</b> ports");alertify.confirm(message,function(){enableWindowsDrivers("ftdi")})}function disableWindowsDriversFTDI(){var message=gettextCatalog.getString("<h4>FTDI driver uninstallation instructions</h4><ol><li>Find the FPGA USB Device</li><li>Select the board interface and uninstall the driver</li></ol>");alertify.confirm(message,function(){disableWindowsDrivers("ftdi")})}function enableWindowsDriversSerial(){var message=gettextCatalog.getString("<h4>Serial driver installation instructions</h4><ol><li>Connect the FPGA board to the USB and wait until Windows finishes the default installation of the driver</li><li>When the OK button is clicked, the Serial driver installer will be launched in a new window</li><li>In the installer, follow the steps to install the driver</li><li>Unplug and reconnect the board</li></ol>");alertify.confirm(message,function(){enableWindowsDrivers("serial")})}function disableWindowsDriversSerial(){var message=gettextCatalog.getString("<h4>Serial driver uninstallation instructions</h4><ol><li>Find the FPGA USB Device</li><li>Select the board interface and uninstall the driver</li></ol>");alertify.confirm(message,function(){disableWindowsDrivers("serial")})}function enableWindowsDrivers(type){var option="--"+type+"-enable";utils.beginBlockingTask(),nodeSudo.exec([common.APIO_CMD,"drivers",option].join(" "),{name:"Icestudio"},function(error,stdout,stderr){utils.endBlockingTask(),stderr?alertify.error(gettextCatalog.getString("Toolchain not installed")+".<br>"+gettextCatalog.getString("Click here to install it"),30).callback=function(isClicked){isClicked&&$rootScope.$broadcast("installToolchain")}:error||alertify.message(gettextCatalog.getString("<b>Unplug</b> and <b>reconnect</b> the board"),5)})}function disableWindowsDrivers(type){var option="--"+type+"-disable";utils.beginBlockingTask(),nodeChildProcess.exec([common.APIO_CMD,"drivers",option].join(" "),function(error,stdout,stderr){utils.endBlockingTask(),stderr&&(alertify.error(gettextCatalog.getString("Toolchain not installed")+".<br>"+gettextCatalog.getString("Click here to install it"),30).callback=function(isClicked){isClicked&&$rootScope.$broadcast("installToolchain")})})}this.enable=function(){switch(common.selectedBoard.info.interface){case"FTDI":enableDriversFTDI();break;case"Serial":enableDriversSerial();break;default:console.warn("No valid selected board interface")}},this.disable=function(){switch(common.selectedBoard.info.interface){case"FTDI":disableDriversFTDI();break;case"Serial":disableDriversSerial();break;default:console.warn("No valid selected board interface")}},this.preUpload=function(callback){common.DARWIN?preUploadDarwin(callback):callback&&callback()},this.postUpload=function(){common.DARWIN&&postUploadDarwin()};var driverC=""}),angular.module("icestudio").service("graph",function($rootScope,joint,boards,blocks,profile,utils,common,gettextCatalog,nodeDebounce,window){function updateWiresOnObstacles(){var cells=graph.getCells();_.each(cells,function(cell){cell.isLink()&&paper.findViewByModel(cell).update()})}function resetBlocks(){var data,connectedLinks,cells=graph.getCells();_.each(cells,function(cell){if(!cell.isLink()){var type=cell.get("blockType");if("basic.input"===type||"basic.output"===type){var view=paper.findViewByModel(cell.id);cell.set("choices","basic.input"===type?common.pinoutInputHTML:common.pinoutOutputHTML),view.clearValues(),view.applyChoices()}else if("basic.code"===type)data=utils.clone(cell.get("data")),connectedLinks=graph.getConnectedLinks(cell),data&&data.ports&&data.ports.in&&_.each(data.ports.in,function(port){var connected=!1;_.each(connectedLinks,function(connectedLink){if(connectedLink.get("target").port===port.name)return connected=!0,!1}),port.default=utils.hasInputRule(port.name,!connected),cell.set("data",data),paper.findViewByModel(cell.id).updateBox()});else if(-1===type.indexOf("basic.")){var block=common.allDependencies[type];data={ports:{in:[]}},connectedLinks=graph.getConnectedLinks(cell),block.design.graph.blocks&&_.each(block.design.graph.blocks,function(item){if("basic.input"===item.type&&!item.data.range){var connected=!1;_.each(connectedLinks,function(connectedLink){if(connectedLink.get("target").port===item.id)return connected=!0,!1}),data.ports.in.push({name:item.id,default:utils.hasInputRule((item.data.clock?"clk":"")||item.data.name,!connected)})}cell.set("data",data),paper.findViewByModel(cell.id).updateBox()})}}})}function hasSelection(){return selection&&selection.length>0}function disableSelected(){hasSelection()&&selectionView.cancelSelection()}function performStep(offset){selection&&allowStep&&(allowStep=!1,Date.now()-stepCounter<stepGroupingInterval?clearTimeout(stepTimer):graph.startBatch("change"),step(offset),stepTimer=setTimeout(function(){graph.stopBatch("change")},stepGroupingInterval),stepCounter=Date.now(),setTimeout(function(){allowStep=!0},allosStepInterval))}function step(offset){var processedWires={};selection.each(function(cell){cell.translate(offset.x,offset.y),selectionView.updateBox(cell);var connectedWires=graph.getConnectedLinks(cell);_.each(connectedWires,function(wire){if(!processedWires[wire.id]){var vertices=wire.get("vertices");if(vertices&&vertices.length){var newVertices=[];_.each(vertices,function(vertex){newVertices.push({x:vertex.x+offset.x,y:vertex.y+offset.y})}),wire.set("vertices",newVertices)}processedWires[wire.id]=!0}})})}function graphToCells(_graph,opt){var cell,cells=[],blocksMap={};opt=opt||{};var isMigrated=!1;return _.each(_graph.blocks,function(blockInstance){if(-1!==blockInstance.type.indexOf("basic.")){if(opt.reset&&("basic.input"===blockInstance.type||"basic.output"===blockInstance.type)){var pins=blockInstance.data.pins,replaced=!1;for(var i in pins){if(replaced=!1,void 0!==opt.originalPinout)for(var opin=0;opin<opt.originalPinout.length;opin++)String(opt.originalPinout[opin].name)===String(pins[i].name)&&(pins[i].name=opt.originalPinout[opin].name,pins[i].value=parseInt(opt.originalPinout[opin].value),opin=opt.originalPinout.length,replaced=!0,isMigrated=!0);!1===replaced&&(pins[i].name="",pins[i].value=0)}}cell=blocks.loadBasic(blockInstance,opt.disabled)}else blockInstance.type in common.allDependencies&&(cell=blocks.loadGeneric(blockInstance,common.allDependencies[blockInstance.type],opt.disabled));if(blocksMap[cell.id]=cell,opt.new){var oldId=cell.id;cell=cell.clone(),blocksMap[oldId]=cell}opt.offset&&cell.translate(opt.offset.x,opt.offset.y),updateCellAttributes(cell),cells.push(cell)}),isMigrated&&alertify.warning(gettextCatalog.getString("If you have blank IN/OUT pins, it's because there is no equivalent in this board")),_.each(_graph.wires,function(wireInstance){var source=blocksMap[wireInstance.source.block],target=blocksMap[wireInstance.target.block];if(opt.offset){var newVertices=[],vertices=wireInstance.vertices;vertices&&vertices.length&&_.each(vertices,function(vertex){newVertices.push({x:vertex.x+opt.offset.x,y:vertex.y+opt.offset.y})}),wireInstance.vertices=newVertices}cell=blocks.loadWire(wireInstance,source,target),opt.new&&(cell=cell.clone()),updateCellAttributes(cell),cells.push(cell)}),cells}function graphOrigin(graph){var origin={x:1/0,y:1/0};return _.each(graph.blocks,function(block){var position=block.position;position.x<origin.x&&(origin.x=position.x),position.y<origin.y&&(origin.y=position.y)}),origin}function updateCellAttributes(cell){cell.attributes.state=state,cell.attributes.rules=profile.get("boardRules")}function addCell(cell){if(cell&&(updateCellAttributes(cell),graph.addCell(cell),!cell.isLink())){var cellView=paper.findViewByModel(cell);cellView.$box.css("z-index")<z.index&&cellView.$box.css("z-index",++z.index)}}function addCells(cells){_.each(cells,function(cell){updateCellAttributes(cell)}),graph.addCells(cells),_.each(cells,function(cell){if(!cell.isLink()){var cellView=paper.findViewByModel(cell);cellView.$box.css("z-index")<z.index&&cellView.$box.css("z-index",++z.index)}})}var z={index:100},graph=null,paper=null,selection=null,selectionView=null,commandManager=null,mousePosition={x:0,y:0},state={pan:{x:0,y:0},zoom:1},self=this;this.breadcrumbs=[{name:"",type:""}],this.addingDraggableBlock=!1,this.getState=function(){return utils.clone(state)},this.setState=function(_state){_state||(_state={pan:{x:0,y:0},zoom:1}),this.panAndZoom.zoom(_state.zoom),this.panAndZoom.pan(_state.pan)},this.resetView=function(){this.setState(null)},this.fitContent=function(){if(this.isEmpty())this.resetView();else{var winWidth=window.get().width,winHeight=window.get().height,tbox={x:40,y:40,width:winWidth-80,height:winHeight-93-80},sbox=V(paper.viewport).bbox(!0,paper.svg);sbox={x:sbox.x*state.zoom,y:sbox.y*state.zoom,width:sbox.width*state.zoom,height:sbox.height*state.zoom};var scale;scale=tbox.width/sbox.width>tbox.height/sbox.height?tbox.height/sbox.height:tbox.width/sbox.width,state.zoom*scale>1&&(scale=1/state.zoom);var target={x:tbox.x+tbox.width/2,y:tbox.y+tbox.height/2},source={x:sbox.x+sbox.width/2,y:sbox.y+sbox.height/2};this.setState({pan:{x:target.x-source.x*scale,y:target.y-source.y*scale},zoom:state.zoom*scale}),$(".paper.joint-theme-default>svg").attr("height",winHeight),$(".paper.joint-theme-default>svg").attr("width",winWidth)}},this.resetBreadcrumbs=function(name){this.breadcrumbs=[{name:name,type:""}],utils.rootScopeSafeApply()},this.createPaper=function(element){function warning(message){paper.options.warningTimer||(paper.options.warningTimer=!0,alertify.warning(message,5),setTimeout(function(){paper.options.warningTimer=!1},4e3))}function updateCellBoxes(){var cells=graph.getCells();selectionView.options.state=state,_.each(cells,function(cell){if(!cell.isLink()){cell.attributes.state=state;var elementView=paper.findViewByModel(cell);elementView.updateBox(),selectionView.updateBox(elementView.model)}})}function checkInsideViewBox(view,x,y){var $box=$(view.$box[0]),position=$box.position();return g.rect(position.left,position.top,$box.width(),$box.height()).containsPoint({x:x*state.zoom+state.pan.x,y:y*state.zoom+state.pan.y})}function processReplaceBlock(upperBlock){debounceDisableReplacedBlock.flush(),replaceBlock(upperBlock,findLowerBlock(upperBlock))}function findLowerBlock(upperBlock){if("ice.Wire"!==upperBlock.get("type")&&"ice.Info"!==upperBlock.get("type")){var blocks=graph.findModelsUnderElement(upperBlock);if(0!==blocks.length){var lowerBlock=blocks[0];if("ice.Wire"!==lowerBlock.get("type")&&"ice.Info"!==lowerBlock.get("type")){if(-1!=={"ice.Generic":["ice.Generic","ice.Code","ice.Input","ice.Output"],"ice.Code":["ice.Generic","ice.Code","ice.Input","ice.Output"],"ice.Input":["ice.Generic","ice.Code"],"ice.Output":["ice.Generic","ice.Code"],"ice.Constant":["ice.Constant","ice.Memory"],"ice.Memory":["ice.Constant","ice.Memory"]}[lowerBlock.get("type")].indexOf(upperBlock.get("type")))return lowerBlock}}}}function replaceBlock(upperBlock,lowerBlock){function replaceWireConnection(wire,connectorType){var connector=wire.get(connectorType);connector.id===lowerBlock.get("id")&&portsMap[connector.port]&&wire.set(connectorType,{id:upperBlock.get("id"),port:portsMap[connector.port]})}if(lowerBlock){var portsMap=computeAllPortsMap(upperBlock,lowerBlock),wires=graph.getConnectedLinks(lowerBlock);_.each(wires,function(wire){replaceWireConnection(wire,"source"),replaceWireConnection(wire,"target")});var lowerBlockSize=lowerBlock.get("size"),upperBlockSize=upperBlock.get("size"),lowerBlockType=lowerBlock.get("type"),lowerBlockPosition=lowerBlock.get("position");"ice.Constant"===lowerBlockType||"ice.Memory"===lowerBlockType?upperBlock.set("position",{x:lowerBlockPosition.x+(lowerBlockSize.width-upperBlockSize.width)/2,y:lowerBlockPosition.y+lowerBlockSize.height-upperBlockSize.height}):"ice.Input"===lowerBlockType?upperBlock.set("position",{x:lowerBlockPosition.x+lowerBlockSize.width-upperBlockSize.width,y:lowerBlockPosition.y+(lowerBlockSize.height-upperBlockSize.height)/2}):"ice.Output"===lowerBlockType?upperBlock.set("position",{x:lowerBlockPosition.x,y:lowerBlockPosition.y+(lowerBlockSize.height-upperBlockSize.height)/2}):upperBlock.set("position",{x:lowerBlockPosition.x+(lowerBlockSize.width-upperBlockSize.width)/2,y:lowerBlockPosition.y+(lowerBlockSize.height-upperBlockSize.height)/2}),lowerBlock.remove(),prevLowerBlock=null}}function computeAllPortsMap(upperBlock,lowerBlock){var portsMap={};return _.merge(portsMap,computePortsMap(upperBlock,lowerBlock,"leftPorts")),_.merge(portsMap,computePortsMap(upperBlock,lowerBlock,"rightPorts")),_.merge(portsMap,computePortsMap(upperBlock,lowerBlock,"topPorts")),_.merge(portsMap,computePortsMap(upperBlock,lowerBlock,"bottomPorts")),portsMap}function computePortsMap(upperBlock,lowerBlock,portType){var portsMap={},usedUpperPorts=[],upperPorts=upperBlock.get(portType),lowerPorts=lowerBlock.get(portType);if(_.each(lowerPorts,function(lowerPort){var matchedPorts=_.filter(upperPorts,function(upperPort){return lowerPort.name===upperPort.name&&lowerPort.size===upperPort.size&&!_.includes(usedUpperPorts,upperPort)});matchedPorts&&matchedPorts.length>0&&(portsMap[lowerPort.id]=matchedPorts[0].id,usedUpperPorts=usedUpperPorts.concat(matchedPorts[0]))}),_.isEmpty(portsMap))for(var n=Math.min(upperPorts.length,lowerPorts.length),i=0;i<n;i++)lowerPorts[i].size===upperPorts[i].size&&(portsMap[lowerPorts[i].id]=upperPorts[i].id);return portsMap}function disableReplacedBlock(lowerBlock){if(prevLowerBlock){var prevLowerBlockView=paper.findViewByModel(prevLowerBlock);prevLowerBlockView.$box.removeClass("block-disabled"),prevLowerBlockView.$el.removeClass("block-disabled")}if(lowerBlock){var lowerBlockView=paper.findViewByModel(lowerBlock);lowerBlockView.$box.addClass("block-disabled"),lowerBlockView.$el.addClass("block-disabled")}prevLowerBlock=lowerBlock}function updatePortDefault(target,value){if(target){var i,port,block=graph.getCell(target.id);if(block){var data=block.get("data");if(data&&data.ports&&data.ports.in){for(i in data.ports.in)if(port=data.ports.in[i],port.name===target.port&&port.default){port.default.apply=value;break}paper.findViewByModel(block.id).updateBox()}}}}graph=new joint.dia.Graph,paper=new joint.dia.Paper({el:element,width:2e3,height:1e3,model:graph,gridSize:8,clickThreshold:6,snapLinks:{radius:16},linkPinning:!1,embeddingMode:!1,getState:this.getState,defaultLink:new joint.shapes.ice.Wire,validateMagnet:function(cellView,magnet){return"output"===magnet.getAttribute("type")},validateConnection:function(cellViewS,magnetS,cellViewT,magnetT,end,linkView){if(magnetS&&"output"===magnetS.getAttribute("type")&&magnetT&&"output"===magnetT.getAttribute("type"))return magnetS!==magnetT&&warning(gettextCatalog.getString("Invalid connection")),!1;if(magnetS&&"right"===magnetS.getAttribute("pos")&&magnetT&&"left"!==magnetT.getAttribute("pos"))return warning(gettextCatalog.getString("Invalid connection")),!1;if(magnetS&&"bottom"===magnetS.getAttribute("pos")&&magnetT&&"top"!==magnetT.getAttribute("pos"))return warning(gettextCatalog.getString("Invalid connection")),!1;var i,links=graph.getLinks();for(i in links){var link=links[i],linkIView=link.findView(paper);if(linkView!==linkIView){if(cellViewT.model.id===link.get("target").id&&magnetT.getAttribute("port")===link.get("target").port)return warning(gettextCatalog.getString("Invalid multiple input connections")),!1;if(cellViewT.model.get("pullup")&&cellViewS.model.id===link.get("source").id)return warning(gettextCatalog.getString("Invalid <i>Pull up</i> connection:<br>block already connected")),!1;if(linkIView.targetView.model.get("pullup")&&cellViewS.model.id===link.get("source").id)return warning(gettextCatalog.getString("Invalid block connection:<br><i>Pull up</i> already connected")),!1}}if(cellViewT.model.get("pullup")){var ret="basic.input"===cellViewS.model.get("blockType")
;return ret||warning(gettextCatalog.getString("Invalid <i>Pull up</i> connection:<br>only <i>Input</i> blocks allowed")),ret}var tsize,lsize=linkView.model.get("size"),portId=magnetT.getAttribute("port"),tLeftPorts=cellViewT.model.get("leftPorts");for(i in tLeftPorts){var port=tLeftPorts[i];if(portId===port.id){tsize=port.size;break}}return tsize=tsize||1,lsize=lsize||1,tsize!==lsize?(warning(gettextCatalog.getString("Invalid connection: {{a}} → {{b}}",{a:lsize,b:tsize})),!1):magnetS!==magnetT}}),commandManager=new joint.dia.CommandManager({paper:paper,graph:graph}),selection=new Backbone.Collection,selectionView=new joint.ui.SelectionView({paper:paper,graph:graph,model:selection,state:state}),paper.options.enabled=!0,paper.options.warningTimer=!1;var targetElement=element[0];this.panAndZoom=svgPanZoom(targetElement.childNodes[0],{fit:!1,center:!1,zoomEnabled:!0,panEnabled:!1,zoomScaleSensitivity:.3,dblClickZoomEnabled:!1,minZoom:.3,maxZoom:2.1,eventsListenerElement:targetElement,onZoom:function(scale){state.zoom=scale,"select2-search__field"===document.activeElement.className&&$("select").select2("close"),updateCellBoxes()},onPan:function(newPan){state.pan=newPan,graph.trigger("state",state),updateCellBoxes()}});var shiftPressed=!1;$(document).on("keydown",function(evt){utils.hasShift(evt)&&(shiftPressed=!0)}),$(document).on("keyup",function(evt){utils.hasShift(evt)||(shiftPressed=!1)}),$(document).on("disableSelected",function(){shiftPressed||disableSelected()}),$("body").mousemove(function(event){mousePosition={x:event.pageX,y:event.pageY}}),selectionView.on("selection-box:pointerdown",function(){hasSelection()&&selection.each(function(cell){var cellView=paper.findViewByModel(cell);cellView.model.isLink()||cellView.$box.css("z-index")<z.index&&cellView.$box.css("z-index",++z.index)})}),selectionView.on("selection-box:pointerclick",function(evt){if(self.addingDraggableBlock)self.addingDraggableBlock=!1,processReplaceBlock(selection.at(0)),disableSelected(),updateWiresOnObstacles(),graph.trigger("batch:stop");else if(shiftPressed){var cell=selection.get($(evt.target).data("model"));selection.reset(selection.without(cell)),selectionView.destroySelectionBox(cell)}}),paper.on("cell:pointerclick",function(cellView,evt,x,y){checkInsideViewBox(cellView,x,y)&&shiftPressed&&paper.options.enabled&&(cellView.model.isLink()||(document.activeElement.blur(),utils.hasLeftButton(evt)&&(selection.add(cellView.model),selectionView.createSelectionBox(cellView.model))))}),paper.on("cell:pointerdblclick",function(cellView,evt,x,y){if((!x||!y||checkInsideViewBox(cellView,x,y))&&(selectionView.cancelSelection(),!shiftPressed)){var type=cellView.model.get("blockType");if(-1!==type.indexOf("basic."))paper.options.enabled&&blocks.editBasic(type,cellView,addCell);else if(common.allDependencies[type]){z.index=1;var project=common.allDependencies[type],breadcrumbsLength=self.breadcrumbs.length;$rootScope.$broadcast("navigateProject",{update:1===breadcrumbsLength,project:project}),self.breadcrumbs.push({name:project.package.name||"#",type:type}),utils.rootScopeSafeApply()}}}),paper.on("blank:pointerdown",function(evt,x,y){document.activeElement.blur(),utils.hasLeftButton(evt)?utils.hasCtrl(evt)?self.isEmpty()||self.panAndZoom.enablePan():paper.options.enabled&&selectionView.startSelecting(evt,x,y):utils.hasRightButton(evt)&&(self.isEmpty()||self.panAndZoom.enablePan())}),paper.on("blank:pointerup",function(){self.panAndZoom.disablePan()}),paper.on("cell:mouseover",function(cellView,evt){utils.hasButtonPressed(evt)||cellView.model.isLink()||cellView.$box.css("z-index")<z.index&&cellView.$box.css("z-index",++z.index)}),paper.on("cell:pointerup",function(cellView){graph.trigger("batch:start"),processReplaceBlock(cellView.model),graph.trigger("batch:stop"),paper.options.enabled&&updateWiresOnObstacles()}),paper.on("cell:pointermove",function(cellView){debounceDisableReplacedBlock(cellView.model)}),selectionView.on("selection-box:pointermove",function(){self.addingDraggableBlock&&hasSelection()&&debounceDisableReplacedBlock(selection.at(0))});var prevLowerBlock=null,debounceDisableReplacedBlock=nodeDebounce(function(upperBlock){disableReplacedBlock(findLowerBlock(upperBlock))},100);graph.on("add change:source change:target",function(cell){if(cell.isLink()&&cell.get("source").id){var target=cell.get("target");target.id?(cell.attributes.lastTarget=target,updatePortDefault(target,!1)):(target=cell.get("lastTarget"),updatePortDefault(target,!0))}}),graph.on("remove",function(cell){if(cell.isLink()){var target=cell.get("target");target.id||(target=cell.get("lastTarget")),updatePortDefault(target,!0)}}),graph.trigger("state",state)},this.setBoardRules=function(rules){var cells=graph.getCells();profile.set("boardRules",rules),_.each(cells,function(cell){if(!cell.isLink()){cell.attributes.rules=rules;paper.findViewByModel(cell).updateBox()}})},this.undo=function(){this.addingDraggableBlock||(disableSelected(),commandManager.undo(),updateWiresOnObstacles())},this.redo=function(){this.addingDraggableBlock||(disableSelected(),commandManager.redo(),updateWiresOnObstacles())},this.clearAll=function(){graph.clear(),this.appEnable(!0),selectionView.cancelSelection()},this.appEnable=function(value){paper.options.enabled=value,value?(angular.element("#menu").removeClass("is-disabled"),angular.element(".paper").removeClass("looks-disabled"),angular.element(".board-container").removeClass("looks-disabled"),angular.element(".banner").addClass("hidden")):(angular.element("#menu").addClass("is-disabled"),angular.element(".paper").addClass("looks-disabled"),angular.element(".board-container").addClass("looks-disabled"),angular.element(".banner").removeClass("hidden"));var cells=graph.getCells();_.each(cells,function(cell){var cellView=paper.findViewByModel(cell.id);cellView.options.interactive=value,"ice.Generic"!==cell.get("type")?value?cellView.$el.removeClass("disable-graph"):cellView.$el.addClass("disable-graph"):"ice.Wire"!==cell.get("type")&&(value?cellView.$el.find(".port-body").removeClass("disable-graph"):cellView.$el.find(".port-body").addClass("disable-graph"))})},this.createBlock=function(type,block){blocks.newGeneric(type,block,function(cell){self.addDraggableCell(cell)})},this.createBasicBlock=function(type){blocks.newBasic(type,function(cells){self.addDraggableCells(cells)})},this.addDraggableCell=function(cell){this.addingDraggableBlock=!0;var menuHeight=$("#menu").height();cell.set("position",{x:8*Math.round(((mousePosition.x-state.pan.x)/state.zoom-cell.get("size").width/2)/8),y:8*Math.round(((mousePosition.y-state.pan.y-menuHeight)/state.zoom-cell.get("size").height/2)/8)}),graph.trigger("batch:start"),addCell(cell),disableSelected();var opt={transparent:!0,initooltip:!1};selection.add(cell),selectionView.createSelectionBox(cell,opt),selectionView.startAddingSelection({clientX:mousePosition.x,clientY:mousePosition.y})},this.addDraggableCells=function(cells){this.addingDraggableBlock=!0;var menuHeight=$("#menu").height();if(cells.length>0){var firstCell=cells[0],offset={x:8*Math.round(((mousePosition.x-state.pan.x)/state.zoom-firstCell.get("size").width/2)/8)-firstCell.get("position").x,y:8*Math.round(((mousePosition.y-state.pan.y-menuHeight)/state.zoom-firstCell.get("size").height/2)/8)-firstCell.get("position").y};_.each(cells,function(cell){var position=cell.get("position");cell.set("position",{x:position.x+offset.x,y:position.y+offset.y})}),graph.trigger("batch:start"),addCells(cells),disableSelected();var opt={transparent:!0};_.each(cells,function(cell){selection.add(cell),selectionView.createSelectionBox(cell,opt)}),selectionView.startAddingSelection({clientX:mousePosition.x,clientY:mousePosition.y})}},this.toJSON=function(){return graph.toJSON()},this.getCells=function(){return graph.getCells()},this.setCells=function(cells){graph.attributes.cells.models=cells},this.selectBoard=function(board,reset){graph.startBatch("change");var data={previous:common.selectedBoard,next:board};graph.trigger("board",{data:data});var newBoard=boards.selectBoard(board.name);return reset&&resetBlocks(),graph.stopBatch("change"),newBoard},this.setInfo=function(values,newValues,project){graph.startBatch("change");var data={previous:values,next:newValues};graph.trigger("info",{data:data}),project.set("package",{name:newValues[0],version:newValues[1],description:newValues[2],author:newValues[3],image:newValues[4]}),graph.stopBatch("change")},this.selectLanguage=function(language){graph.startBatch("change");var data={previous:profile.get("language"),next:language};return graph.trigger("lang",{data:data}),language=utils.setLocale(language),graph.stopBatch("change"),language},this.resetCommandStack=function(){commandManager.reset()},this.cutSelected=function(){hasSelection()&&(utils.copyToClipboard(selection,graph),this.removeSelected())},this.copySelected=function(){hasSelection()&&utils.copyToClipboard(selection,graph)},this.pasteSelected=function(){"A"!==document.activeElement.tagName&&"BODY"!==document.activeElement.tagName||utils.pasteFromClipboard(function(object){object.version===common.VERSION&&self.appendDesign(object.design,object.dependencies)})},this.selectAll=function(){disableSelected();var cells=graph.getCells();_.each(cells,function(cell){cell.isLink()||(selection.add(cell),selectionView.createSelectionBox(cell))})},this.removeSelected=function(){hasSelection()&&(graph.removeCells(selection.models),selectionView.cancelSelection(),updateWiresOnObstacles())};this.stepLeft=function(){performStep({x:-8,y:0})},this.stepUp=function(){performStep({x:0,y:-8})},this.stepRight=function(){performStep({x:8,y:0})},this.stepDown=function(){performStep({x:0,y:8})};var stepCounter=0,stepTimer=null,stepGroupingInterval=500,allowStep=!0,allosStepInterval=200;this.isEmpty=function(){return 0===graph.getCells().length},this.isEnabled=function(){return paper.options.enabled},this.loadDesign=function(design,opt,callback){if(design&&design.graph&&design.graph.blocks&&design.graph.wires)return opt=opt||{},$("body").addClass("waiting"),setTimeout(function(){commandManager.stopListening(),self.clearAll();var cells=graphToCells(design.graph,opt);graph.addCells(cells),self.setState(design.state),self.appEnable(!opt.disabled),opt.disabled||commandManager.listen(),callback&&callback(),$("body").removeClass("waiting")},20),!0},this.appendDesign=function(design,dependencies){if(design&&dependencies&&design.graph&&design.graph.blocks&&design.graph.wires){selectionView.cancelSelection();for(var type in dependencies)type in common.allDependencies||(common.allDependencies[type]=dependencies[type]);var origin=graphOrigin(design.graph),menuHeight=$("#menu").height(),opt={new:!0,disabled:!1,reset:design.board!==common.selectedBoard.name,offset:{x:8*Math.round(((mousePosition.x-state.pan.x)/state.zoom-origin.x)/8),y:8*Math.round(((mousePosition.y-state.pan.y-menuHeight)/state.zoom-origin.y)/8)}},cells=graphToCells(design.graph,opt);graph.addCells(cells),_.each(cells,function(cell){if(!cell.isLink()){var cellView=paper.findViewByModel(cell);cellView.$box.css("z-index")<z.index&&cellView.$box.css("z-index",++z.index),selection.add(cell),selectionView.createSelectionBox(cell)}})}},this.resetCodeErrors=function(){var cells=graph.getCells();return new Promise(function(resolve){_.each(cells,function(cell){var cellView;"ice.Code"===cell.get("type")?(cellView=paper.findViewByModel(cell),cellView.$box.find(".code-content").removeClass("highlight-error"),cellView.clearAnnotations()):"ice.Generic"===cell.get("type")?(cellView=paper.findViewByModel(cell),cellView.$box.removeClass("highlight-error")):"ice.Constant"===cell.get("type")&&(cellView=paper.findViewByModel(cell),cellView.$box.removeClass("highlight-error"))}),resolve()})},$(document).on("codeError",function(evt,codeError){var cells=graph.getCells();_.each(cells,function(cell){var blockId,cellView;"code"===codeError.blockType&&"ice.Code"===cell.get("type")||"constant"===codeError.blockType&&"ice.Constant"===cell.get("type")?blockId=utils.digestId(cell.id):"generic"===codeError.blockType&&"ice.Generic"===cell.get("type")&&(blockId=utils.digestId(cell.attributes.blockType)),codeError.blockId===blockId&&(cellView=paper.findViewByModel(cell),"error"===codeError.type&&("ice.Code"===cell.get("type")?cellView.$box.find(".code-content").addClass("highlight-error"):cellView.$box.addClass("highlight-error")),"ice.Code"===cell.get("type")&&cellView.setAnnotation(codeError))})})}),angular.module("icestudio").service("profile",function(utils,common,nodeFs){this.data={board:"",boardRules:!0,collection:"",externalCollections:"",language:"",remoteHostname:"",showFPGAResources:!1},common.DARWIN&&(this.data.macosFTDIDrivers=!1),this.load=function(callback){var self=this;utils.readFile(common.PROFILE_PATH).then(function(data){self.data={board:data.board||"",boardRules:!1!==data.boardRules,collection:data.collection||"",language:data.language||"",externalCollections:data.externalCollections||"",remoteHostname:data.remoteHostname||"",showFPGAResources:data.showFPGAResources||!1},common.DARWIN&&(self.data.macosFTDIDrivers=data.macosFTDIDrivers||!1),callback&&callback()}).catch(function(error){console.warn(error),callback&&callback()})},this.set=function(key,value){this.data.hasOwnProperty(key)&&(this.data[key]=value,this.save())},this.get=function(key){return this.data[key]},this.save=function(){nodeFs.existsSync(common.ICESTUDIO_DIR)||nodeFs.mkdirSync(common.ICESTUDIO_DIR),utils.saveFile(common.PROFILE_PATH,this.data).then(function(){}).catch(function(error){alertify.error(error,30)})}}),angular.module("icestudio").service("project",function($rootScope,graph,boards,compiler,profile,utils,common,gui,gettextCatalog,nodeFs,nodePath){function _default(){return{version:common.VERSION,package:{name:"",version:"",description:"",author:"",image:""},design:{board:"",graph:{blocks:[],wires:[]}},dependencies:{}}}function boardMigration(oldBoard,newBoard){var pboard=!1;switch(oldBoard.toLowerCase()){case"icezum alhambra":case"icezum":switch(newBoard.toLowerCase()){case"alhambra-ii":pboard="icezum"}}return pboard}function checkVersion(version){if(version>common.VERSION){var errorAlert=alertify.error(gettextCatalog.getString("Unsupported project format {{version}}",{version:version}),30);return alertify.message(gettextCatalog.getString("Click here to <b>download a newer version</b> of Icestudio"),30).callback=function(isClicked){isClicked&&(errorAlert.dismiss(!1),gui.Shell.openExternal("https://github.com/FPGAwars/icestudio/releases"))},!1}return!0}function _safeLoad(data,name){var project={};switch(data.version){case common.VERSION:case"1.1":project=data;break;case"1.0":project=convert10To12(data);break;default:project=convertTo10(data,name),project=convert10To12(project)}return project.version=common.VERSION,project}function convert10To12(data){var project=_default();project.package=data.package,project.design.board=data.design.board,project.design.graph=data.design.graph;var depsInfo=findSubDependencies10(data.design.deps);replaceType10(project,depsInfo);for(var d in depsInfo){var dep=depsInfo[d];replaceType10(dep.content,depsInfo),project.dependencies[dep.id]=dep.content}return project}function findSubDependencies10(deps){var depsInfo={};for(var key in deps){var block=utils.clone(deps[key]),subDepsInfo=findSubDependencies10(block.design.deps);for(var name in subDepsInfo)name in depsInfo||(depsInfo[name]=subDepsInfo[name]);block=pruneBlock(block),delete block.design.deps,block.package.name=block.package.name||key,block.package.description=block.package.description||key,key in depsInfo||(depsInfo[key]={id:utils.dependencyID(block),content:block})}return depsInfo}function replaceType10(project,depsInfo){for(var i in project.design.graph.blocks){var type=project.design.graph.blocks[i].type;-1===type.indexOf("basic.")&&(project.design.graph.blocks[i].type=depsInfo[type].id)}}function convertTo10(data,name){var project={version:"1.0",package:{name:name||"",version:"",description:name||"",author:"",image:""},design:{board:"",graph:{},deps:{}}};for(var b in data.graph.blocks){var block=data.graph.blocks[b];switch(block.type){case"basic.input":case"basic.output":block.data={name:block.data.label,pins:[{index:"0",name:block.data.pin?block.data.pin.name:"",value:block.data.pin?block.data.pin.value:"0"}],virtual:!1};break;case"basic.constant":block.data={name:block.data.label,value:block.data.value,local:!1};break;case"basic.code":var params=[];for(var p in block.data.params)params.push({name:block.data.params[p]});var inPorts=[];for(var i in block.data.ports.in)inPorts.push({name:block.data.ports.in[i]});var outPorts=[];for(var o in block.data.ports.out)outPorts.push({name:block.data.ports.out[o]});block.data={code:block.data.code,params:params,ports:{in:inPorts,out:outPorts}}}}project.design.board=data.board,project.design.graph=data.graph;for(var key in data.deps)project.design.deps[key]=convertTo10(data.deps[key],key);return project}function sortGraph(){var cells=graph.getCells();cells=_.sortBy(cells,function(cell){if("ice.Constant"===cell.get("type")||"ice.Memory"===cell.get("type"))return cell.get("position").x}),cells=_.sortBy(cells,function(cell){if("ice.Input"===cell.get("type")||"ice.Output"===cell.get("type"))return cell.get("position").y}),graph.setCells(cells)}function copyIncludedFiles(files,origPath,destPath,callback){var success=!0;async.eachSeries(files,function(filename,next){setTimeout(function(){if(origPath===destPath)return next();if(nodeFs.existsSync(nodePath.join(destPath,filename)))alertify.confirm(gettextCatalog.getString("File {{file}} already exists in the project path. Do you want to replace it?",{file:utils.bold(filename)}),function(){if(!(success=success&&doCopySync(origPath,destPath,filename)))return next();next()},function(){next()});else{if(!(success=success&&doCopySync(origPath,destPath,filename)))return next();next()}},0)},function(){return callback(success)})}function doCopySync(origPath,destPath,filename){var orig=nodePath.join(origPath,filename),dest=nodePath.join(destPath,filename),success=utils.copySync(orig,dest);return success?alertify.message(gettextCatalog.getString("File {{file}} imported",{file:utils.bold(filename)}),5):alertify.error(gettextCatalog.getString("Original file {{file}} does not exist",{file:utils.bold(filename)}),30),success}function pruneProject(project){function _prune(_project){delete _project.design.state;for(var i in _project.design.graph.blocks){var block=_project.design.graph.blocks[i];switch(block.type){case"basic.input":case"basic.output":case"basic.constant":case"basic.memory":break;case"basic.code":for(var j in block.data.ports.in)delete block.data.ports.in[j].default;break;case"basic.info":delete block.data.text;break;default:delete block.data}}}var _project=utils.clone(project);_prune(_project);for(var d in _project.dependencies)_prune(_project.dependencies[d]);return _project}function pruneBlock(block){delete block.version,delete block.design.board;var i,pins;for(i in block.design.graph.blocks)"basic.input"!==block.design.graph.blocks[i].type&&"basic.output"!==block.design.graph.blocks[i].type||(void 0===block.design.graph.blocks[i].data.size&&(pins=block.design.graph.blocks[i].data.pins,block.design.graph.blocks[i].data.size=pins&&pins.length>1?pins.length:void 0),delete block.design.graph.blocks[i].data.pins,delete block.design.graph.blocks[i].data.virtual);return block}this.name="",this.path="",this.filepath="",this.changed=!1;var project=_default();this.get=function(key){return key in project?project[key]:project},this.set=function(key,obj){key in project&&(project[key]=obj)},this.open=function(filepath,emptyPath){var self=this;this.path=emptyPath?"":filepath,this.filepath=filepath,utils.readFile(filepath).then(function(data){var name=utils.basename(filepath);self.load(name,data)}).catch(function(){alertify.error(gettextCatalog.getString("Invalid project format"),30)})},this.load=function(name,data){function _load(reset,originalBoard){common.allDependencies=project.dependencies;var opt={reset:reset||!1,disabled:!1};if(void 0!==originalBoard&&!1!==originalBoard)for(var i=0;i<common.boards.length;i++)String(common.boards[i].name)===String(originalBoard)&&(opt.originalPinout=common.boards[i].pinout);graph.loadDesign(project.design,opt,function(){graph.resetCommandStack(),graph.fitContent(),alertify.success(gettextCatalog.getString("Project {{name}} loaded",{name:utils.bold(name)})),common.hasChangesSinceBuild=!0})?(profile.set("board",boards.selectBoard(project.design.board).name),self.updateTitle(name)):alertify.error(gettextCatalog.getString("Wrong project format: {{name}}",{name:utils.bold(name)}),30),setTimeout(function(){alertify.set("confirm","labels",{ok:gettextCatalog.getString("OK"),cancel:gettextCatalog.getString("Cancel")})},100)}var self=this;if(checkVersion(data.version))if(project=_safeLoad(data,name),project.design.board!==common.selectedBoard.name){var projectBoard=boards.boardLabel(project.design.board);alertify.set("confirm","labels",{ok:gettextCatalog.getString("Load"),cancel:gettextCatalog.getString("Convert")}),alertify.confirm(gettextCatalog.getString("This project is designed for the {{name}} board.",{name:utils.bold(projectBoard)})+"<br>"+gettextCatalog.getString("You can load it as it is or convert it for the {{name}} board.",{name:utils.bold(common.selectedBoard.info.label)}),function(){_load()},function(){project.design.board=common.selectedBoard.name,_load(!0,boardMigration(projectBoard,common.selectedBoard.name))})}else _load()},this.save=function(filepath,callback){function doSaveProject(){utils.saveFile(filepath,pruneProject(project)).then(function(){callback&&callback(),alertify.success(gettextCatalog.getString("Project {{name}} saved",{name:utils.bold(name)}))}).catch(function(error){alertify.error(error,30)})}var name=utils.basename(filepath);if(this.updateTitle(name),sortGraph(),this.update(),this.filepath!==filepath){var origPath=utils.dirname(this.filepath),destPath=utils.dirname(filepath),code=compiler.generate("verilog",project)[0].content,listFiles=compiler.generate("list",project),internalFiles=listFiles.map(function(res){return res.name}),files=utils.findIncludedFiles(code);files=_.difference(files,internalFiles),files.length>0?filepath&&copyIncludedFiles(files,origPath,destPath,function(success){success&&doSaveProject()}):doSaveProject()}else doSaveProject();this.path=filepath,this.filepath=filepath},this.addBlockFile=function(filepath,notification){var self=this;utils.readFile(filepath).then(function(data){function doImportBlock(){self.addBlock(block),notification&&alertify.success(gettextCatalog.getString("Block {{name}} imported",{name:utils.bold(block.package.name)}))}if(checkVersion(data.version)){var name=utils.basename(filepath),block=_safeLoad(data,name);if(block){var origPath=utils.dirname(filepath),destPath=utils.dirname(self.path),code=compiler.generate("verilog",block)[0].content,listFiles=compiler.generate("list",block),internalFiles=listFiles.map(function(res){return res.name}),files=utils.findIncludedFiles(code);files=_.difference(files,internalFiles),files.length>0?self.path?copyIncludedFiles(files,origPath,destPath,function(success){success&&doImportBlock()}):alertify.confirm(gettextCatalog.getString("This import operation requires a project path. You need to save the current project. Do you want to continue?"),function(){$rootScope.$emit("saveProjectAs",function(){setTimeout(function(){copyIncludedFiles(files,origPath,destPath,function(success){success&&doImportBlock()})},500)})}):doImportBlock()}}}).catch(function(){alertify.error(gettextCatalog.getString("Invalid project format"),30)})},this.update=function(opt,callback){var graphData=graph.toJSON(),p=utils.cellsToProject(graphData.cells,opt);project.design.board=p.design.board,project.design.graph=p.design.graph,project.dependencies=p.dependencies;var state=graph.getState();project.design.state={pan:{x:parseFloat(state.pan.x.toFixed(4)),y:parseFloat(state.pan.y.toFixed(4))},zoom:parseFloat(state.zoom.toFixed(4))},callback&&callback()},this.updateTitle=function(name){name&&(this.name=name,graph.resetBreadcrumbs(name));var title=(this.changed?"*":"")+this.name+" ─ Icestudio";utils.updateWindowTitle(title)},this.compile=function(target){this.update();var opt={boardRules:profile.get("boardRules")};return compiler.generate(target,project,opt)},this.addBasicBlock=function(type){graph.createBasicBlock(type)},this.addBlock=function(block){if(block){block=_safeLoad(block),block=pruneBlock(block);var type=utils.dependencyID(block);utils.mergeDependencies(type,block),graph.createBlock(type,block)}},this.removeSelected=function(){graph.removeSelected()},this.clear=function(){project=_default(),graph.clearAll(),graph.resetBreadcrumbs(),graph.resetCommandStack()}}),angular.module("icestudio").service("collections",function(utils,common,profile,gettextCatalog,nodePath){function loadCollections(paths){var collections=[];return paths.forEach(function(path){collections.push(getCollection(nodePath.basename(path),path,utils.getFilesRecursive(path,MAX_LEVEL_SEARCH)))}),collections}function getCollection(name,path,children){var collection={name:name,path:path,content:{blocks:[],examples:[],package:{},readme:""}};for(var i in children){var child=children[i];switch(child.name){case"blocks":child.children&&(collection.content.blocks=child.children);break;case"examples":child.children&&(collection.content.examples=child.children);break;case"package":if(!child.children)try{collection.content.package=require(child.path)}catch(e){}break;case"README":child.children||(collection.content.readme=child.path)}}return collection}function sortCollections(collections){for(var i in collections){var collection=collections[i];collection.content&&(sortContent(collection.content.blocks),sortContent(collection.content.examples))}}function sortContent(items){if(items){items.sort(byName);for(var i in items)sortContent(items[i].children)}}function byName(a,b){return a=gettextCatalog.getString(a.name),b=gettextCatalog.getString(b.name),a>b?1:a<b?-1:0}const MAX_LEVEL_SEARCH=20;this.loadAllCollections=function(){this.loadDefaultCollection(),this.loadInternalCollections(),this.loadExternalCollections()},this.loadDefaultCollection=function(){common.defaultCollection=getCollection("",common.DEFAULT_COLLECTION_DIR,utils.getFilesRecursive(common.DEFAULT_COLLECTION_DIR,MAX_LEVEL_SEARCH))},this.loadInternalCollections=function(){var internalCollections=utils.findCollections(common.INTERNAL_COLLECTIONS_DIR);common.internalCollections=loadCollections(internalCollections)},this.loadExternalCollections=function(){var externalCollectionsPath=profile.get("externalCollections");if(externalCollectionsPath!==common.INTERNAL_COLLECTIONS_DIR){var externalCollections=utils.findCollections(externalCollectionsPath);common.externalCollections=loadCollections(externalCollections)}},this.selectCollection=function(path){var selectedCollection=null,collections=common.internalCollections.concat(common.externalCollections);for(var i in collections)if(collections[i].path===path){selectedCollection=collections[i];break}return null===selectedCollection&&(selectedCollection=common.defaultCollection),common.selectedCollection=selectedCollection,selectedCollection.path},this.sort=function(){sortCollections([common.defaultCollection]),sortCollections(common.internalCollections),sortCollections(common.externalCollection)}}),angular.module("icestudio").filter("shortcut",function(shortcuts){return function(action){return shortcuts.label(action)}}).service("shortcuts",function(common){this.method=function(action,method){action in shortcuts&&(shortcuts[action].method=method)},this.execute=function(event,opt){var action="",method=null,system=common.DARWIN?"mac":"linux",ret={preventDefault:!1};for(action in shortcuts){var options=shortcuts[action].opt||{},command=shortcuts[action][system];if(event.keyCode===command.key&&event.altKey===(command.alt||!1)&&event.ctrlKey===(command.ctrl||!1)&&event.metaKey===(command.meta||!1)&&event.shiftKey===(command.shift||!1)&&(!opt.prompt||options.prompt)&&(!opt.disabled||options.disabled)){method=shortcuts[action].method,ret.preventDefault=options.preventDefault||!1;break}}return method&&method(),ret},this.label=function(action){var label="";return action in shortcuts&&(label=common.DARWIN?shortcuts[action].mac.label:shortcuts[action].linux.label),label};var shortcuts={newProject:{linux:{label:"Ctrl+N",ctrl:!0,key:78},mac:{label:"⌘+N",meta:!0,key:78}},openProject:{linux:{label:"Ctrl+O",ctrl:!0,key:79},mac:{label:"⌘+O",meta:!0,key:79}},saveProject:{linux:{label:"Ctrl+S",ctrl:!0,key:83},mac:{label:"⌘+S",meta:!0,key:83},opt:{prompt:!0}},saveProjectAs:{linux:{label:"Ctrl+Shift+S",ctrl:!0,shift:!0,key:83},mac:{label:"Shift+⌘+S",meta:!0,shift:!0,key:83},opt:{prompt:!0}},quit:{linux:{label:"Ctrl+Q",ctrl:!0,key:81},mac:{label:"⌘+Q",meta:!0,key:81}},undoGraph:{linux:{label:"Ctrl+Z",ctrl:!0,key:90},mac:{label:"⌘+Z",meta:!0,key:90},opt:{preventDefault:!0}},redoGraph:{linux:{label:"Ctrl+Y",ctrl:!0,key:89},mac:{label:"⌘+Y",meta:!0,key:89},opt:{preventDefault:!0}},redoGraph2:{linux:{label:"Ctrl+Shift+Z",ctrl:!0,shift:!0,key:90},mac:{label:"Shift+⌘+Z",meta:!0,shift:!0,key:90},opt:{preventDefault:!0}},cutSelected:{linux:{label:"Ctrl+X",ctrl:!0,key:88},mac:{label:"⌘+X",meta:!0,key:88}},copySelected:{linux:{label:"Ctrl+C",ctrl:!0,key:67},mac:{label:"⌘+C",meta:!0,key:67}},pasteSelected:{linux:{label:"Ctrl+V",ctrl:!0,key:86},mac:{label:"⌘+V",meta:!0,key:86}},selectAll:{linux:{label:"Ctrl+A",ctrl:!0,key:65},mac:{label:"⌘+A",meta:!0,key:65}},fitContent:{linux:{label:"Ctrl+1",ctrl:!0,key:49},mac:{label:"⌘+1",meta:!0,key:49},opt:{disabled:!0}},verifyCode:{linux:{label:"Ctrl+R",ctrl:!0,key:82},mac:{label:"⌘+R",meta:!0,key:82}},buildCode:{linux:{label:"Ctrl+B",ctrl:!0,key:66},mac:{label:"⌘+B",meta:!0,key:66}},uploadCode:{linux:{label:"Ctrl+U",ctrl:!0,key:85},mac:{label:"⌘+U",meta:!0,key:85}},stepUp:{linux:{label:"Arrow up",key:38},mac:{label:"Arrow up",key:38}},stepDown:{linux:{label:"Arrow down",key:40},mac:{label:"Arrow down",key:40}},stepLeft:{linux:{label:"Arrow left",key:37},mac:{label:"Arrow left",key:37}},stepRight:{linux:{label:"Arrow right",key:39},mac:{label:"Arrow right",key:39}},removeSelected:{linux:{label:"Supr",key:46},mac:{label:"Fn+Delete",key:46}},back:{linux:{label:"Back",key:8},mac:{label:"Delete",key:8},opt:{disabled:!0}},takeSnapshot:{linux:{label:"Ctrl+P",ctrl:!0,key:80},mac:{label:"⌘+P",meta:!0,key:80},opt:{prompt:!0,disabled:!0,preventDefault:!0}}}}),angular.module("icestudio").service("tools",function(project,compiler,profile,collections,drivers,graph,utils,common,gettextCatalog,gettext,nodeGettext,nodeFs,nodeFse,nodePath,nodeChildProcess,nodeSSHexec,nodeRSync,nodeAdmZip,_package,$rootScope){function apioRun(commands,startMessage,endMessage){return new Promise(function(resolve){var sourceCode="";taskRunning||(taskRunning=!0,infoAlert&&infoAlert.dismiss(!1),resultAlert&&resultAlert.dismiss(!1),graph.resetCodeErrors().then(function(){return checkToolchainInstalled()}).then(function(){return utils.beginBlockingTask(),startMessage&&(startAlert=alertify.message(startMessage,1e5)),generateCode()}).then(function(output){return sourceCode=output.code,syncResources(output.code,output.internalResources)}).then(function(){var hostname=profile.get("remoteHostname"),command=commands[0];return"build"!==command&&"upload"!==command||profile.get("showFPGAResources")&&(commands=commands.concat("--verbose-arachne")),hostname?executeRemote(commands,hostname):executeLocal(commands)}).then(function(result){return processResult(result,sourceCode)}).then(function(){endMessage&&(resultAlert=alertify.success(gettextCatalog.getString(endMessage))),utils.endBlockingTask(),restoreTask(),resolve()}).catch(function(){utils.endBlockingTask(),restoreTask()}))})}function restoreTask(){setTimeout(function(){startAlert&&startAlert.dismiss(!1),taskRunning=!1
},1e3)}function checkToolchainInstalled(){return new Promise(function(resolve,reject){toolchain.installed?resolve():(toolchainNotInstalledAlert(gettextCatalog.getString("Toolchain not installed")),reject())})}function generateCode(){return new Promise(function(resolve){project.update();var opt={datetime:!1,boardRules:profile.get("boardRules")};opt.boardRules&&(opt.initPorts=compiler.getInitPorts(project.get()),opt.initPins=compiler.getInitPins(project.get()));var verilogFile=compiler.generate("verilog",project.get(),opt)[0];nodeFs.writeFileSync(nodePath.join(common.BUILD_DIR,verilogFile.name),verilogFile.content,"utf8");var pcfFile=compiler.generate("pcf",project.get(),opt)[0];nodeFs.writeFileSync(nodePath.join(common.BUILD_DIR,pcfFile.name),pcfFile.content,"utf8");var listFiles=compiler.generate("list",project.get());for(var i in listFiles){var listFile=listFiles[i];nodeFs.writeFileSync(nodePath.join(common.BUILD_DIR,listFile.name),listFile.content,"utf8")}resolve({code:verilogFile.content,internalResources:listFiles.map(function(res){return res.name})})})}function syncResources(code,internalResources){return new Promise(function(resolve,reject){removeFiles(resources),resources=[],resources=resources.concat(findIncludedFiles(code)),resources=resources.concat(findInlineFiles(code)),resources=_.uniq(resources),resources=_.difference(resources,internalResources),syncFiles(resources,reject),resolve()})}function removeFiles(files){_.each(files,function(file){var filepath=nodePath.join(common.BUILD_DIR,file);nodeFse.removeSync(filepath)})}function findIncludedFiles(code){return findFiles(/[\n|\s]\/\/\s*@include\s+([^\s]*\.(v|vh|list))(\n|\s)/g,code)}function findInlineFiles(code){return findFiles(/[\n|\s][^\/]?\"(.*\.list?)\"/g,code)}function findFiles(pattern,code){for(var match,files=[];match=pattern.exec(code);)files.push(match[1]);return files}function syncFiles(files,reject){_.each(files,function(file){var destPath=nodePath.join(common.BUILD_DIR,file),origPath=nodePath.join(utils.dirname(project.filepath),file);utils.copySync(origPath,destPath)||(resultAlert=alertify.error(gettextCatalog.getString("File {{file}} does not exist",{file:file}),30),reject())})}function checkToolchain(callback){var apio=utils.getApioExecutable();nodeChildProcess.exec([apio,"--version"].join(" "),function(error,stdout){error?(toolchain.apio="",toolchain.installed=!1,toolchainNotInstalledAlert(gettextCatalog.getString("Toolchain not installed")),callback&&callback()):(toolchain.apio=stdout.match(/apio,\sversion\s(.+)/i)[1],toolchain.installed=toolchain.apio>=_package.apio.min&&toolchain.apio<_package.apio.max,toolchain.installed?nodeChildProcess.exec([apio,"clean","-p",common.SAMPLE_DIR].join(" "),function(error){toolchain.installed=!error,error&&(toolchain.apio="",toolchainNotInstalledAlert(gettextCatalog.getString("Toolchain not installed"))),callback&&callback()}):(toolchainNotInstalledAlert(gettextCatalog.getString("Toolchain version does not match")),callback&&callback()))})}function toolchainNotInstalledAlert(message){resultAlert&&resultAlert.dismiss(!1),resultAlert=alertify.warning(message+".<br>"+gettextCatalog.getString("Click here to install it"),1e5),resultAlert.callback=function(isClicked){isClicked&&$rootScope.$broadcast("installToolchain")}}function executeRemote(commands,hostname){return new Promise(function(resolve){startAlert.setContent(gettextCatalog.getString("Synchronize remote files ...")),nodeRSync({src:common.BUILD_DIR+"/",dest:hostname+":.build/",ssh:!0,recursive:!0,delete:!0,include:["*.v","*.pcf","*.list"],exclude:[".sconsign.dblite","*.out","*.blif","*.asc","*.bin"]},function(error,stdout,stderr){error?resolve({error:error,stdout:stdout,stderr:stderr}):(startAlert.setContent(gettextCatalog.getString("Execute remote {{label}} ...",{label:""})),nodeSSHexec(["apio"].concat(commands).concat(["--project-dir",".build"]).join(" "),hostname,function(error,stdout,stderr){resolve({error:error,stdout:stdout,stderr:stderr})}))})})}function executeLocal(commands){return new Promise(function(resolve){function _executeLocal(){var apio=utils.getApioExecutable(),command=[apio].concat(commands).concat(["-p",utils.coverPath(common.BUILD_DIR)]).join(" ");nodeChildProcess.exec(command,{maxBuffer:512e4},function(error,stdout,stderr){"upload"===commands[0]&&drivers.postUpload(),common.commandOutput=command+"\n\n"+stdout+stderr,$(document).trigger("commandOutputChanged",[common.commandOutput]),resolve({error:error,stdout:stdout,stderr:stderr})})}"upload"===commands[0]?drivers.preUpload(function(){_executeLocal()}):_executeLocal()})}function processResult(result,code){result=result||{};var _error=result.error,stdout=result.stdout,stderr=result.stderr;return new Promise(function(resolve,reject){if(_error||stderr)if(reject(),stdout){var boardName=common.selectedBoard.name,boardLabel=common.selectedBoard.info.label;if(-1!==stdout.indexOf("Error: board "+boardName+" not connected")||-1!==stdout.indexOf("USBError")||-1!==stdout.indexOf("Activate bootloader")){var errorMessage=gettextCatalog.getString("Board {{name}} not connected",{name:utils.bold(boardLabel)});-1!==stdout.indexOf("Activate bootloader")&&common.selectedBoard.name.startsWith("TinyFPGA-B")&&(errorMessage+="</br>("+gettextCatalog.getString("Bootloader not active")+")"),resultAlert=alertify.error(errorMessage,30)}else if(-1!==stdout.indexOf("Error: board "+boardName+" not available"))resultAlert=alertify.error(gettextCatalog.getString("Board {{name}} not available",{name:utils.bold(boardLabel)}),30),setupDriversAlert();else if(-1!==stdout.indexOf("Error: unknown board"))resultAlert=alertify.error(gettextCatalog.getString("Unknown board"),30);else if(-1!==stdout.indexOf("[upload] Error")){switch(common.selectedBoard.name){case"TinyFPGA-B2":case"TinyFPGA-BX":var match=stdout.match(/Bootloader\snot\sactive/g);match&&3===match.length?resultAlert=alertify.error(gettextCatalog.getString("Bootloader not active"),30):-1!==stdout.indexOf("Device or resource busy")?(resultAlert=alertify.error(gettextCatalog.getString("Board {{name}} not available",{name:utils.bold(boardLabel)}),30),setupDriversAlert()):resultAlert=-1!==stdout.indexOf("device disconnected or multiple access on port")?alertify.error(gettextCatalog.getString("Board {{name}} disconnected",{name:utils.bold(boardLabel)}),30):alertify.error(gettextCatalog.getString(stdout),30);break;default:resultAlert=alertify.error(gettextCatalog.getString(stdout),30)}console.warn(stdout)}else if(-1!==stdout.indexOf("Library not loaded:")&&-1!==stdout.indexOf("libffi"))resultAlert=alertify.error(gettextCatalog.getString("Configuration not completed"),30),setupDriversAlert();else if(-1!==stdout.indexOf("set_io: too few arguments")||-1!==stdout.indexOf("fatal error: unknown pin"))resultAlert=alertify.error(gettextCatalog.getString("FPGA I/O ports not defined"),30);else if(-1!==stdout.indexOf("fatal error: duplicate pin constraints"))resultAlert=alertify.error(gettextCatalog.getString("Duplicated FPGA I/O ports"),30);else{var re,matchError,codeErrors=[];for(re=/main.v:([0-9]+):\s(error|warning):\s(.*?)[\r|\n]/g;matchError=re.exec(stdout);)codeErrors.push({line:parseInt(matchError[1]),msg:matchError[3].replace(/\sin\smain\..*$/,""),type:matchError[2]});for(re=/main.v:([0-9]+):\ssyntax\serror[\r|\n]/g;matchError=re.exec(stdout);)codeErrors.push({line:parseInt(matchError[1]),msg:"Syntax error",type:"error"});re=/(ERROR|Warning):\s(.*?)\smain\.v:([0-9]+)(.*?)[\r|\n]/g;for(var msg="",line=-1,type=!1,preContent=!1,postContent=!1;matchError=re.exec(stdout);)msg="",line=parseInt(matchError[3]),type=matchError[1].toLowerCase(),preContent=matchError[2],postContent=matchError[4],"Parser error in line"===preContent?(postContent=postContent.substring(2),postContent.startsWith("syntax error")&&(postContent="Syntax error"),msg=postContent):preContent.endsWith(" in line ")?msg=preContent.replace(/\sin\sline\s$/," ")+postContent:(preContent=preContent.replace(/\sat\s$/,""),preContent=preContent.replace(/\sin\s$/,""),msg=preContent),codeErrors.push({line:line,msg:msg,type:type});for(re=/\smain\.v:([0-9]+):\s(.*?)(ERROR):\s(.*?)[\r|\n]/g;matchError=re.exec(stdout);)msg="",line=parseInt(matchError[1]),type=matchError[3].toLowerCase(),preContent=matchError[4],msg=preContent.indexOf("unexpected TOK_")>=0?"Syntax error arround this line":preContent,codeErrors.push({line:line,msg:msg,type:type});var modules=mapCodeModules(code),hasErrors=!1,hasWarnings=!1;for(var i in codeErrors){var codeError=normalizeCodeError(codeErrors[i],modules);codeError&&($(document).trigger("codeError",[codeError]),hasErrors=hasErrors||"error"===codeError.type,hasWarnings=hasWarnings||"warning"===codeError.type)}if(hasErrors)resultAlert=alertify.error(gettextCatalog.getString("Errors detected in the design"),5);else{hasWarnings&&(resultAlert=alertify.warning(gettextCatalog.getString("Warnings detected in the design"),5));var stdoutError=stdout.split("\n").filter(function(line){return line=line.toLowerCase(),-1!==line.indexOf("error: ")||-1!==line.indexOf("not installed")||-1!==line.indexOf("already declared")});if(stdoutError.length>0){var error="";re=/hardware\.blif:([0-9]+):\sfatal\serror:\s(.*)/g,(matchError=re.exec(stdoutError[0]))&&(error=matchError[2]),resultAlert=alertify.error(error,30)}else resultAlert=alertify.error(stdout,30)}}}else stderr&&(resultAlert=-1!==stderr.indexOf("Could not resolve hostname")||-1!==stderr.indexOf("Connection refused")?alertify.error(gettextCatalog.getString("Wrong remote hostname {{name}}",{name:profile.get("remoteHostname")}),30):-1!==stderr.indexOf("No route to host")?alertify.error(gettextCatalog.getString("Remote host {{name}} not connected",{name:profile.get("remoteHostname")}),30):alertify.error(stderr,30));else resolve(),stdout&&(common.FPGAResources.ffs=findValue(/DFF\s+([0-9]+)\s/g,stdout,common.FPGAResources.ffs),common.FPGAResources.luts=findValue(/LCs\s+([0-9]+)\s/g,stdout,common.FPGAResources.luts),common.FPGAResources.pios=findValue(/PIOs\s+([0-9]+)\s/g,stdout,common.FPGAResources.pios),common.FPGAResources.plbs=findValue(/PLBs\s+([0-9]+)\s/g,stdout,common.FPGAResources.plbs),common.FPGAResources.brams=findValue(/BRAMs\s+([0-9]+)\s/g,stdout,common.FPGAResources.brams),utils.rootScopeSafeApply())})}function findValue(pattern,output,previousValue){var match=pattern.exec(output);return match&&match[1]?match[1]:previousValue}function mapCodeModules(code){var match,codelines=code.split("\n"),module={params:[]},modules=[];for(var i in codelines){var codeline=codelines[i];module.name||!(match=/^module\s(.*?)[\s|;]/.exec(codeline))?module.begin||!(match=/^\sparameter\s(.*?)\s/.exec(codeline))?module.begin||!(match=/;$/.exec(codeline))?module.end||(match=/^endmodule$/.exec(codeline))&&(module.end=parseInt(i)+1,modules.push(module),module={params:[]}):module.begin=parseInt(i)+1:module.params.push({name:match[1],line:parseInt(i)+1}):module.name=match[1]}return modules}function normalizeCodeError(codeError,modules){var newCodeError;for(var i in modules){var module=modules[i];if(codeError.line<=module.end){newCodeError={type:codeError.type,msg:codeError.msg};var re=/Failed\sto\sdetect\swidth\sfor\sparameter\s\\(.*?)\sat/g,matchConstant=re.exec(newCodeError.msg);if(codeError.line>module.begin&&!matchConstant){module.name.startsWith("main_")?(newCodeError.blockId=module.name.split("_")[1],newCodeError.blockType="code",newCodeError.line=codeError.line-module.begin-(codeError.line===module.end?1:0)):(newCodeError.blockId=module.name.split("_")[0],newCodeError.blockType="generic");break}if("main"===module.name)for(var j in module.params){var param=module.params[j];if(codeError.line===param.line||matchConstant&&param.name===matchConstant[1]){newCodeError.blockId=param.name,newCodeError.blockType="constant";break}}else newCodeError.blockId=module.name,newCodeError.blockType="generic";break}}return newCodeError}function installDefaultToolchain(){installationStatus();var content=["<div>",'  <p id="progress-message">'+gettextCatalog.getString("Installing toolchain")+"</p>","  </br>",'  <div class="progress">','    <div id="progress-bar" class="progress-bar progress-bar-info progress-bar-striped active" role="progressbar"','    aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width:0%">',"    </div>","  </div>","</div>"].join("\n");toolchainAlert=alertify.alert(content,function(){setTimeout(function(){initProgress(),$(toolchainAlert.__internal.buttons[0].element).removeClass("hidden")},200)}),$(toolchainAlert.__internal.buttons[0].element).addClass("hidden"),toolchain.installed=!1,async.series([ensurePythonIsAvailable,extractVirtualenv,createVirtualenv,extractDefaultApio,installDefaultApio,extractDefaultApioPackages,installationCompleted])}function installOnlineToolchain(){installationStatus();var content=["<div>",'  <p id="progress-message">'+gettextCatalog.getString("Installing toolchain")+"</p>","  </br>",'  <div class="progress">','    <div id="progress-bar" class="progress-bar progress-bar-info progress-bar-striped active" role="progressbar"','    aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width:0%">',"    </div>","  </div>","</div>"].join("\n");toolchainAlert=alertify.alert(content,function(){setTimeout(function(){initProgress(),$(toolchainAlert.__internal.buttons[0].element).removeClass("hidden")},200)}),$(toolchainAlert.__internal.buttons[0].element).addClass("hidden"),toolchain.installed=!1,async.series([checkInternetConnection,ensurePythonIsAvailable,extractVirtualenv,createVirtualenv,installOnlineApio,apioInstallSystem,apioInstallIcestorm,apioInstallIverilog,apioInstallDrivers,apioInstallScons,installationCompleted])}function checkInternetConnection(callback){updateProgress(gettextCatalog.getString("Check Internet connection..."),0),utils.isOnline(callback,function(){closeToolchainAlert(),restoreStatus(),resultAlert=alertify.error(gettextCatalog.getString("Internet connection required"),30),callback(!0)})}function ensurePythonIsAvailable(callback){updateProgress(gettextCatalog.getString("Check Python..."),0),utils.getPythonExecutable()?callback():(closeToolchainAlert(),restoreStatus(),resultAlert=alertify.error(gettextCatalog.getString("Python 2.7 is required"),30),callback(!0))}function extractVirtualenv(callback){updateProgress(gettextCatalog.getString("Extract virtualenv files..."),5),utils.extractVirtualenv(callback)}function createVirtualenv(callback){updateProgress(gettextCatalog.getString("Create virtualenv..."),10),utils.createVirtualenv(callback)}function extractDefaultApio(callback){updateProgress(gettextCatalog.getString("Extract default apio files..."),30),utils.extractDefaultApio(callback)}function installDefaultApio(callback){updateProgress(gettextCatalog.getString("Install default apio..."),50),utils.installDefaultApio(callback)}function extractDefaultApioPackages(callback){updateProgress(gettextCatalog.getString("Extract default apio packages..."),70),utils.extractDefaultApioPackages(callback)}function installOnlineApio(callback){var extraPackages=_package.apio.extras||[];updateProgress("pip install -U "+utils.getApioInstallable()+"["+extraPackages.toString()+"]",30),utils.installOnlineApio(callback)}function apioInstallSystem(callback){updateProgress("apio install system",40),utils.apioInstall("system",callback)}function apioInstallIcestorm(callback){updateProgress("apio install icestorm",50),utils.apioInstall("icestorm",callback)}function apioInstallIverilog(callback){updateProgress("apio install iverilog",70),utils.apioInstall("iverilog",callback)}function apioInstallDrivers(callback){common.WIN32?(updateProgress("apio install drivers",80),utils.apioInstall("drivers",callback)):callback()}function apioInstallScons(callback){updateProgress("apio install scons",90),utils.apioInstall("scons",callback)}function installationCompleted(callback){checkToolchain(function(){toolchain.installed&&(closeToolchainAlert(),updateProgress(gettextCatalog.getString("Installation completed"),100),alertify.success(gettextCatalog.getString("Toolchain installed")),setupDriversAlert()),restoreStatus(),callback()})}function setupDriversAlert(){if(common.showDrivers()){var message=gettextCatalog.getString("Click here to <b>setup the drivers</b>");infoAlert||setTimeout(function(){infoAlert=alertify.message(message,30),infoAlert.callback=function(isClicked){infoAlert=null,isClicked&&(resultAlert&&resultAlert.dismiss(!1),$rootScope.$broadcast("enableDrivers"))}},1e3)}}function updateProgress(message,value){angular.element("#progress-message").text(message);var bar=angular.element("#progress-bar");100===value&&bar.removeClass("progress-bar-striped active"),bar.text(value+"%"),bar.attr("aria-valuenow",value),bar.css("width",value+"%")}function initProgress(){angular.element("#progress-bar").addClass("notransition progress-bar-info progress-bar-striped active").removeClass("progress-bar-danger").text("0%").attr("aria-valuenow",0).css("width","0%").removeClass("notransition")}function closeToolchainAlert(){toolchainAlert.callback(),toolchainAlert.close()}function installationStatus(){utils.disableKeyEvents(),utils.disableClickEvents(),$("body").addClass("waiting")}function restoreStatus(){utils.enableKeyEvents(),utils.enableClickEvents(),$("body").removeClass("waiting")}function getCollections(zipData){var data="",_collections={};return zipData.getEntries().forEach(function(zipEntry){data=zipEntry.entryName.match(/^([^\/]+)\/$/),data&&(_collections[data[1]]={origName:data[1],blocks:[],examples:[],locale:[],package:""}),addCollectionItem("blocks","ice",_collections,zipEntry),addCollectionItem("blocks","v",_collections,zipEntry),addCollectionItem("blocks","vh",_collections,zipEntry),addCollectionItem("blocks","list",_collections,zipEntry),addCollectionItem("examples","ice",_collections,zipEntry),addCollectionItem("examples","v",_collections,zipEntry),addCollectionItem("examples","vh",_collections,zipEntry),addCollectionItem("examples","list",_collections,zipEntry),addCollectionItem("locale","po",_collections,zipEntry),data=zipEntry.entryName.match(/^([^\/]+)\/package\.json$/),data&&(_collections[data[1]].package=zipEntry.entryName),(data=zipEntry.entryName.match(/^([^\/]+)\/README\.md$/))&&(_collections[data[1]].readme=zipEntry.entryName)}),_collections}function addCollectionItem(key,ext,collections,zipEntry){var data=zipEntry.entryName.match(RegExp("^([^/]+)/"+key+"/.*."+ext+"$"));data&&collections[data[1]][key].push(zipEntry.entryName)}function installCollection(collection,zip){var i,dest="",pattern=RegExp("^"+collection.origName);for(i in collection.blocks)dest=collection.blocks[i].replace(pattern,collection.name),safeExtract(collection.blocks[i],dest,zip);for(i in collection.examples)dest=collection.examples[i].replace(pattern,collection.name),safeExtract(collection.examples[i],dest,zip);for(i in collection.locale){dest=collection.locale[i].replace(pattern,collection.name),safeExtract(collection.locale[i],dest,zip);var compiler=new nodeGettext.Compiler({format:"json"}),sourcePath=nodePath.join(common.INTERNAL_COLLECTIONS_DIR,dest),targetPath=nodePath.join(common.INTERNAL_COLLECTIONS_DIR,dest.replace(/\.po$/,".json")),content=nodeFs.readFileSync(sourcePath).toString(),json=compiler.convertPo([content]);nodeFs.writeFileSync(targetPath,json),gettextCatalog.loadRemote(targetPath)}collection.package&&(dest=collection.package.replace(pattern,collection.name),safeExtract(collection.package,dest,zip)),collection.readme&&(dest=collection.readme.replace(pattern,collection.name),safeExtract(collection.readme,dest,zip))}function safeExtract(entry,dest,zip){try{var newPath=nodePath.join(common.INTERNAL_COLLECTIONS_DIR,dest);zip.extractEntryTo(entry,utils.dirname(newPath),!1)}catch(e){}}var taskRunning=!1,resources=[],startAlert=null,infoAlert=null,resultAlert=null,toolchainAlert=null,toolchain={apio:"-",installed:!1,disabled:!1};this.toolchain=toolchain,nodeFse.removeSync(common.OLD_BUILD_DIR),this.verifyCode=function(startMessage,endMessage){return apioRun(["verify"],startMessage,endMessage)},this.buildCode=function(startMessage,endMessage){return apioRun(["build","--board",common.selectedBoard.name],startMessage,endMessage)},this.uploadCode=function(startMessage,endMessage){return apioRun(["upload","--board",common.selectedBoard.name],startMessage,endMessage)},this.checkToolchain=checkToolchain,$rootScope.$on("installToolchain",function(){this.installToolchain()}.bind(this)),this.installToolchain=function(){resultAlert&&resultAlert.dismiss(!1),utils.checkDefaultToolchain()?(utils.removeToolchain(),installDefaultToolchain()):alertify.confirm(gettextCatalog.getString("Default toolchain not found. Toolchain will be downloaded. This operation requires Internet connection. Do you want to continue?"),function(){utils.removeToolchain(),installOnlineToolchain()})},this.updateToolchain=function(){resultAlert&&resultAlert.dismiss(!1),alertify.confirm(gettextCatalog.getString("The toolchain will be updated. This operation requires Internet connection. Do you want to continue?"),function(){installOnlineToolchain()})},this.resetToolchain=function(){resultAlert&&resultAlert.dismiss(!1),utils.checkDefaultToolchain()?alertify.confirm(gettextCatalog.getString("The toolchain will be restored to default. Do you want to continue?"),function(){utils.removeToolchain(),installDefaultToolchain()}):alertify.alert(gettextCatalog.getString("Error: default toolchain not found in '{{dir}}'",{dir:common.TOOLCHAIN_DIR}))},this.removeToolchain=function(){resultAlert&&resultAlert.dismiss(!1),alertify.confirm(gettextCatalog.getString("The toolchain will be removed. Do you want to continue?"),function(){utils.removeToolchain(),toolchain.apio="",toolchain.installed=!1,alertify.success(gettextCatalog.getString("Toolchain removed"))})},$rootScope.$on("enableDrivers",function(){this.enableDrivers()}.bind(this)),this.enableDrivers=function(){checkToolchain(function(){toolchain.installed&&drivers.enable()})},this.disableDrivers=function(){checkToolchain(function(){toolchain.installed&&drivers.disable()})},this.addCollections=function(filepaths){async.eachSeries(filepaths,function(filepath,nextzip){var zipData=nodeAdmZip(filepath),_collections=getCollections(zipData);async.eachSeries(_collections,function(collection,next){setTimeout(function(){collection.package&&(collection.blocks||collection.examples)?alertify.prompt(gettextCatalog.getString("Edit the collection name"),collection.origName,function(evt,name){if(!name)return!1;collection.name=name;var destPath=nodePath.join(common.INTERNAL_COLLECTIONS_DIR,name);nodeFs.existsSync(destPath)?alertify.confirm(gettextCatalog.getString("The collection {{name}} already exists.",{name:utils.bold(name)})+"<br>"+gettextCatalog.getString("Do you want to replace it?"),function(){utils.deleteFolderRecursive(destPath),installCollection(collection,zipData),alertify.success(gettextCatalog.getString("Collection {{name}} replaced",{name:utils.bold(name)})),next(name)},function(){alertify.warning(gettextCatalog.getString("Collection {{name}} not replaced",{name:utils.bold(name)})),next(name)}):(installCollection(collection,zipData),alertify.success(gettextCatalog.getString("Collection {{name}} added",{name:utils.bold(name)})),next(name))}):alertify.warning(gettextCatalog.getString("Invalid collection {{name}}",{name:utils.bold(name)}))},0)},function(name){collections.loadInternalCollections(),common.selectedCollection.name===name&&collections.selectCollection(name),utils.rootScopeSafeApply(),nextzip()})})},this.removeCollection=function(collection){utils.deleteFolderRecursive(collection.path),collections.loadInternalCollections(),alertify.success(gettextCatalog.getString("Collection {{name}} removed",{name:utils.bold(collection.name)}))},this.removeAllCollections=function(){utils.removeCollections(),collections.loadInternalCollections(),alertify.success(gettextCatalog.getString("All collections removed"))}}),angular.module("icestudio").service("utils",function($rootScope,gettextCatalog,common,_package,window,nodeFs,nodeFse,nodePath,nodeChildProcess,nodeExtract,nodeZlib,nodeOnline,nodeGlob,nodeSha1,nodeCP,nodeGetOS,nodeLangInfo,SVGO){function isPython2(executable){const args=["-c","import sys; print '.'.join(str(v) for v in sys.version_info[:2])"];try{const result=nodeChildProcess.spawnSync(executable,args);return 0===result.status&&result.stdout.toString().startsWith("2.7")}catch(e){return!1}}function disableEvent(event){event.stopPropagation(),event.preventDefault()}function basename(filepath){var b=nodePath.basename(filepath);return b.substr(0,b.lastIndexOf("."))}function isJSON(content){try{return JSON.parse(content)}catch(e){return!1}}function isCollectionPath(path){var result=!1;try{var content=nodeFs.readdirSync(path);result=content&&contains(content,"package.json")&&isFile(nodePath.join(path,"package.json"))&&(contains(content,"blocks")&&isDirectory(nodePath.join(path,"blocks"))||contains(content,"examples")&&isDirectory(nodePath.join(path,"examples")))}catch(e){console.warn(e)}return result}function isFile(path){return nodeFs.lstatSync(path).isFile()}function isDirectory(path){return nodeFs.lstatSync(path).isDirectory()}function isSymbolicLink(path){return nodeFs.lstatSync(path).isSymbolicLink()}function contains(array,item){return-1!==array.indexOf(item)}function getFilesRecursive(folder,level){var fileTree=[],validator=/.*\.(ice|json|md)$/;try{var content=nodeFs.readdirSync(folder);level--,content.forEach(function(name){var path=nodePath.join(folder,name);isDirectory(path)?fileTree.push({name:name,path:path,children:level>=0?getFilesRecursive(path,level):[]}):validator.test(name)&&fileTree.push({name:basename(name),path:path})})}catch(e){console.warn(e)}return fileTree}function splitLocale(locale){var ret={},list=locale.split("_");return list.length>0&&(ret.lang=list[0]),list.length>1&&(ret.country=list[1]),ret}function getSupportedLanguages(){var supported=[];return nodeFs.readdirSync(common.LOCALE_DIR).forEach(function(element){var curPath=nodePath.join(common.LOCALE_DIR,element);nodeFs.lstatSync(curPath).isDirectory()&&supported.push(splitLocale(element))}),supported}function bestLocale(locale,supported){var i;if(locale.country)for(i=0;i<supported.length;i++)if(locale.lang===supported[i].lang&&locale.country===supported[i].country)return supported[i].lang+"_"+supported[i].country;for(i=0;i<supported.length;i++)if(locale.lang===supported[i].lang)return supported[i].lang+(supported[i].country?"_"+supported[i].country:"");return"en"}function coverPath(filepath){return'"'+filepath+'"'}function selectionToCells(selection,graph){var cells=[],blocksMap={};return selection.each(function(block){cells.push(block.attributes),blocksMap[block.id]=block;var processedWires={},connectedWires=graph.getConnectedLinks(block);_.each(connectedWires,function(wire){if(!processedWires[wire.id]){var source=blocksMap[wire.get("source").id],target=blocksMap[wire.get("target").id];source&&target&&(cells.push(wire.attributes),processedWires[wire.id]=!0)}})}),cells}var _pythonExecutableCached=null;this.getPythonExecutable=function(){if(!_pythonExecutableCached){const possibleExecutables=[];common.WIN32?(possibleExecutables.push("python.exe"),possibleExecutables.push("C:\\Python27\\python.exe")):(possibleExecutables.push("python2.7"),possibleExecutables.push("python"));for(var i in possibleExecutables){var executable=possibleExecutables[i];if(isPython2(executable)){_pythonExecutableCached=executable;break}}}return _pythonExecutableCached},this.extractZip=function(source,destination,callback){nodeExtract(source,{dir:destination},function(error){error?callback(!0):callback()})},this.extractVirtualenv=function(callback){this.extractZip(common.VENV_ZIP,common.CACHE_DIR,callback)},this.enableClickEvents=function(){document.removeEventListener("click",disableEvent,!0)},this.disableClickEvents=function(){document.addEventListener("click",disableEvent,!0)},this.enableKeyEvents=function(){document.removeEventListener("keyup",disableEvent,!0),document.removeEventListener("keydown",disableEvent,!0),document.removeEventListener("keypress",disableEvent,!0)},this.disableKeyEvents=function(){document.addEventListener("keyup",disableEvent,!0),document.addEventListener("keydown",disableEvent,!0),document.addEventListener("keypress",disableEvent,!0)},this.executeCommand=function(command,callback){nodeChildProcess.exec(command.join(" "),function(error,stdout,stderr){common.commandOutput=command.join(" ")+"\n\n"+stdout+stderr,$(document).trigger("commandOutputChanged",[common.commandOutput]),error?(this.enableKeyEvents(),this.enableClickEvents(),callback(!0),alertify.error(error.message,30)):callback()}.bind(this))},this.createVirtualenv=function(callback){if(nodeFs.existsSync(common.ICESTUDIO_DIR)||nodeFs.mkdirSync(common.ICESTUDIO_DIR),nodeFs.existsSync(common.ENV_DIR))callback();else{nodeFs.mkdirSync(common.ENV_DIR);var command=[this.getPythonExecutable(),coverPath(nodePath.join(common.VENV_DIR,"virtualenv.py")),coverPath(common.ENV_DIR)];common.WIN32&&command.push("--always-copy"),this.executeCommand(command,callback)}},this.checkDefaultToolchain=function(){try{return nodeFs.statSync(common.TOOLCHAIN_DIR).isDirectory()}catch(err){return!1}},this.installDefaultPythonPackagesDir=function(defaultDir,callback){var self=this;nodeGlob(nodePath.join(defaultDir,"*.*"),{},function(error,files){error||(files=files.map(function(item){return coverPath(item)}),self.executeCommand([coverPath(common.ENV_PIP),"install","-U","--no-deps"].concat(files),callback))})},this.extractDefaultPythonPackages=function(callback){this.extractZip(common.DEFAULT_PYTHON_PACKAGES_ZIP,common.DEFAULT_PYTHON_PACKAGES_DIR,callback)},this.installDefaultPythonPackages=function(callback){this.installDefaultPythonPackagesDir(common.DEFAULT_PYTHON_PACKAGES_DIR,callback)},this.extractDefaultApio=function(callback){this.extractZip(common.DEFAULT_APIO_ZIP,common.DEFAULT_APIO_DIR,callback)},this.installDefaultApio=function(callback){this.installDefaultPythonPackagesDir(common.DEFAULT_APIO_DIR,callback)},this.extractDefaultApioPackages=function(callback){this.extractZip(common.DEFAULT_APIO_PACKAGES_ZIP,common.APIO_HOME_DIR,callback)},this.isOnline=function(callback,error){nodeOnline({timeout:5e3},function(err,online){online?callback():(error(),callback(!0))})},this.installOnlinePythonPackages=function(callback){var pythonPackages=[];this.executeCommand([coverPath(common.ENV_PIP),"install","-U"]+pythonPackages,callback)},this.installOnlineApio=function(callback){var versionRange='">='+_package.apio.min+",<"+_package.apio.max+'"',extraPackages=_package.apio.extras||[],apio=this.getApioInstallable();this.executeCommand([coverPath(common.ENV_PIP),"install","-U",apio+"["+extraPackages.toString()+"]"+versionRange],callback)},this.getApioInstallable=function(){return _package.apio.branch?common.APIO_PIP_VCS.replace("%BRANCH%",_package.apio.branch):"apio"},this.apioInstall=function(pkg,callback){this.executeCommand([common.APIO_CMD,"install",pkg],callback)},this.toolchainDisabled=!1,this.getApioExecutable=function(){var candidateApio=process.env.ICESTUDIO_APIO?process.env.ICESTUDIO_APIO:_package.apio.external;return nodeFs.existsSync(candidateApio)?(this.toolchainDisabled||alertify.message("Using external apio: "+candidateApio,5),this.toolchainDisabled=!0,coverPath(candidateApio)):(this.toolchainDisabled=!1,common.APIO_CMD)},this.removeToolchain=function(){this.deleteFolderRecursive(common.ENV_DIR),this.deleteFolderRecursive(common.CACHE_DIR),this.deleteFolderRecursive(common.APIO_HOME_DIR)},this.removeCollections=function(){this.deleteFolderRecursive(common.INTERNAL_COLLECTIONS_DIR)},this.deleteFolderRecursive=function(path){nodeFs.existsSync(path)&&(nodeFs.readdirSync(path).forEach(function(file){var curPath=nodePath.join(path,file);nodeFs.lstatSync(curPath).isDirectory()?this.deleteFolderRecursive(curPath):nodeFs.unlinkSync(curPath)}.bind(this)),nodeFs.rmdirSync(path))},this.sep=nodePath.sep,
this.basename=basename,this.dirname=function(filepath){return nodePath.dirname(filepath)},this.readFile=function(filepath){return new Promise(function(resolve,reject){nodeFs.existsSync(common.PROFILE_PATH)?nodeFs.readFile(filepath,function(err,content){if(err)reject(err.toString());else{var data=isJSON(content);data?resolve(data):reject()}}):resolve({})})},this.saveFile=function(filepath,data){return new Promise(function(resolve,reject){var content=data;"string"!=typeof data&&(content=JSON.stringify(data,null,2)),nodeFs.writeFile(filepath,content,function(err){err?reject(err.toString()):resolve()})})},this.findCollections=function(folder){var collectionsPaths=[];try{folder&&(collectionsPaths=nodeFs.readdirSync(folder).map(function(name){return nodePath.join(folder,name)}).filter(function(path){return(isDirectory(path)||isSymbolicLink(path))&&isCollectionPath(path)}))}catch(e){console.warn(e)}return collectionsPaths},this.getFilesRecursive=getFilesRecursive,this.setLocale=function(locale,callback){locale=splitLocale(locale);var supported=getSupportedLanguages(),bestLang=bestLocale(locale,supported);gettextCatalog.setCurrentLanguage(bestLang),gettextCatalog.loadRemote(nodePath.join(common.LOCALE_DIR,bestLang,bestLang+".json"));var collections=[common.defaultCollection].concat(common.internalCollections).concat(common.externalCollections);for(var c in collections){var collection=collections[c],filepath=nodePath.join(collection.path,"locale",bestLang,bestLang+".json");nodeFs.existsSync(filepath)&&gettextCatalog.loadRemote(filepath)}return callback&&setTimeout(function(){callback()},50),bestLang},this.renderForm=function(specs,callback){var content=[];content.push("<div>");for(var i in specs){var spec=specs[i];switch(spec.type){case"text":content.push("              <p>"+spec.title+'</p>              <input class="ajs-input" type="text" id="form'+i+'"/>            ');break;case"checkbox":content.push('              <div class="checkbox">                <label><input type="checkbox" '+(spec.value?"checked":"")+' id="form'+i+'"/>'+spec.label+"</label>              </div>            ");break;case"combobox":var options=spec.options.map(function(option){var selected=spec.value===option.value?" selected":"";return'<option value="'+option.value+'"'+selected+">"+option.label+"</option>"}).join("");content.push('              <div class="form-group">                <label style="font-weight:normal">'+spec.label+'</label>                <select class="form-control" id="form'+i+'">                  '+options+"                </select>              </div>            ")}}content.push("</div>"),alertify.confirm(content.join("\n")).set("onok",function(evt){var values=[];if(callback){for(var i in specs){switch(specs[i].type){case"text":case"combobox":values.push($("#form"+i).val());break;case"checkbox":values.push($("#form"+i).prop("checked"))}}callback(evt,values)}}).set("oncancel",function(){}),setTimeout(function(){$("#form0").select();for(var i in specs){var spec=specs[i];switch(spec.type){case"text":case"combobox":$("#form"+i).val(spec.value);break;case"checkbox":$("#form"+i).prop("checked",spec.value)}}},50)},this.projectinfoprompt=function(values,callback){function registerOpen(){var chooserOpen=$("#input-open-svg");chooserOpen.unbind("change"),chooserOpen.change(function(){var filepath=$(this).val();nodeFs.readFile(filepath,"utf8",function(err,data){if(err)throw err;optimizeSVG(data,function(result){image=encodeURI(result.data),registerSave(),$("#preview-svg").attr("src","data:image/svg+xml,"+image)})}),$(this).val("")})}function optimizeSVG(data,callback){SVGO.optimize(data,callback)}function registerSave(){var label=$("#save-svg");if(image){label.removeClass("disabled"),label.attr("for","input-save-svg");var chooserSave=$("#input-save-svg");chooserSave.unbind("change"),chooserSave.change(function(){if(image){var filepath=$(this).val();filepath.endsWith(".svg")||(filepath+=".svg"),nodeFs.writeFile(filepath,decodeURI(image),function(err){if(err)throw err}),$(this).val("")}})}else label.addClass("disabled"),label.attr("for","")}function registerReset(){$("#reset-svg").click(function(){image="",registerSave(),$("#preview-svg").attr("src",blankImage)})}var i,content=[],messages=[gettextCatalog.getString("Name"),gettextCatalog.getString("Version"),gettextCatalog.getString("Description"),gettextCatalog.getString("Author")],n=messages.length,image=values[4],blankImage="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=";content.push("<div>");for(i in messages)content.push("  <p>"+messages[i]+"</p>"),content.push('  <input class="ajs-input" id="input'+i+'" type="text" value="'+values[i]+'">');for(content.push("  <p>"+gettextCatalog.getString("Image")+"</p>"),content.push('  <input id="input-open-svg" type="file" accept=".svg" class="hidden">'),content.push('  <input id="input-save-svg" type="file" accept=".svg" class="hidden" nwsaveas="image.svg">'),content.push("  <div>"),content.push('  <img id="preview-svg" class="ajs-input" src="'+(image?"data:image/svg+xml,"+image:blankImage)+'" height="68" style="pointer-events:none">'),content.push("  </div>"),content.push("  <div>"),content.push('    <label for="input-open-svg" class="btn">'+gettextCatalog.getString("Open SVG")+"</label>"),content.push('    <label id="save-svg" for="input-save-svg" class="btn">'+gettextCatalog.getString("Save SVG")+"</label>"),content.push('    <label id="reset-svg" class="btn">'+gettextCatalog.getString("Reset SVG")+"</label>"),content.push("  </div>"),content.push("</div>"),i=0;i<n;i++)$("#input"+i).val(values[i]);image?$("#preview-svg").attr("src","data:image/svg+xml,"+image):$("#preview-svg").attr("src",blankImage);var prevOnshow=alertify.confirm().get("onshow")||function(){};alertify.confirm().set("onshow",function(){prevOnshow(),registerOpen(),registerSave(),registerReset()}),alertify.confirm(content.join("\n")).set("onok",function(evt){for(var values=[],i=0;i<n;i++)values.push($("#input"+i).val());values.push(image),callback&&callback(evt,values),alertify.confirm().set("onshow",prevOnshow)}).set("oncancel",function(){alertify.confirm().set("onshow",prevOnshow)})},this.selectBoardPrompt=function(callback){this.disableKeyEvents(),$(".ajs-cancel").addClass("hidden");var formSpecs=[{type:"combobox",label:gettextCatalog.getString("Select your board"),value:"",options:common.boards.map(function(board){return{value:board.name,label:board.info.label}})}];this.renderForm(formSpecs,function(evt,values){var selectedBoard=values[0];selectedBoard?(evt.cancel=!1,callback&&callback(selectedBoard),this.enableKeyEvents(),setTimeout(function(){$(".ajs-cancel").removeClass("hidden")},200)):evt.cancel=!0}.bind(this))},this.copySync=function(orig,dest){var ret=!0;try{nodeFs.existsSync(orig)?nodeFse.copySync(orig,dest):ret=!1}catch(e){alertify.error(gettextCatalog.getString("Error: {{error}}",{error:e.toString()}),30),ret=!1}return ret},this.findIncludedFiles=function(code){var ret=[],patterns=[/[\n|\s]\/\/\s*@include\s+([^\s]*\.(v|vh))(\n|\s)/g,/[\n|\s][^\/]?\"(.*\.list?)\"/g];for(var p in patterns)for(var match;match=patterns[p].exec(code);){var file=match[1].replace(/ /g,"");-1===ret.indexOf(file)&&ret.push(file)}return ret},this.bold=function(text){return"<b>"+text+"</b>"},this.openDialog=function(inputID,ext,callback){var chooser=$(inputID);chooser.unbind("change"),chooser.change(function(){var filepath=$(this).val();callback&&callback(filepath),$(this).val("")}),chooser.trigger("click")},this.saveDialog=function(inputID,ext,callback){var chooser=$(inputID);chooser.unbind("change"),chooser.change(function(){var filepath=$(this).val();filepath.endsWith(ext)||(filepath+=ext),callback&&callback(filepath),$(this).val("")}),chooser.trigger("click")},this.updateWindowTitle=function(title){window.get().title=title},this.rootScopeSafeApply=function(){$rootScope.$$phase||$rootScope.$apply()},this.parsePortLabel=function(data,pattern){var match,ret={};if(pattern=pattern||common.PATTERN_PORT_LABEL,(match=pattern.exec(data))&&match[0]===match.input){if(ret.name=match[1]?match[1]:"",ret.rangestr=match[2],match[2]){if(match[3]>95||match[4]>95)return alertify.warning(gettextCatalog.getString("Maximum bus size: 96 bits"),5),null;match[3]>match[4]?ret.range=_.range(match[3],parseInt(match[4])-1,-1):ret.range=_.range(match[3],parseInt(match[4])+1,1)}return ret}return null},this.parseParamLabel=function(data,pattern){var match,ret={};return pattern=pattern||common.PATTERN_PARAM_LABEL,match=pattern.exec(data),match&&match[0]===match.input?(ret.name=match[1]?match[1]:"",ret):null},this.clone=function(data){return JSON.parse(JSON.stringify(data))},this.dependencyID=function(dependency){if(dependency.package&&dependency.design)return nodeSha1(JSON.stringify(dependency.package)+JSON.stringify(dependency.design))},this.newWindow=function(filepath,local){var gui=require("nw.gui"),params=!1;void 0!==filepath&&(params={filepath:filepath}),void 0!==local&&!0===local&&(!1===params&&(params={}),params.local="local");var url="index.html"+(!1===params?"":"?icestudio_argv="+encodeURI(JSON.stringify(params)));gui.Window.open(url,{"new-instance":!0,new_instance:!0,position:"center",toolbar:!1,width:900,height:600,show:!0})},this.coverPath=coverPath,this.mergeDependencies=function(type,block){if(!(type in common.allDependencies)){var deps=block.dependencies;for(var depType in deps)depType in common.allDependencies||(common.allDependencies[depType]=deps[depType]);delete block.dependencies,common.allDependencies[type]=block}},this.copyToClipboard=function(selection,graph){var cells=selectionToCells(selection,graph),clipboard={icestudio:this.cellsToProject(cells,graph)};nodeCP.copy(JSON.stringify(clipboard),function(){})},this.pasteFromClipboard=function(callback){nodeCP.paste(function(err,text){if(err){if(common.LINUX){var cmd="",message=gettextCatalog.getString("{{app}} is required.",{app:"<b>xclip</b>"});nodeGetOS(function(e,os){e||(-1!==os.dist.indexOf("Debian")||-1!==os.dist.indexOf("Ubuntu Linux")||-1!==os.dist.indexOf("Linux Mint")?cmd="sudo apt-get install xclip":os.dist.indexOf("Fedora")?cmd="sudo dnf install xclip":-1!==os.dist.indexOf("RHEL")||-1!==os.dist.indexOf("RHAS")||-1!==os.dist.indexOf("Centos")||-1!==os.dist.indexOf("Red Hat Linux")?cmd="sudo yum install xclip":-1!==os.dist.indexOf("Arch Linux")&&(cmd="sudo pacman install xclip"),cmd&&(message+=" "+gettextCatalog.getString("Please run: {{cmd}}",{cmd:"<br><b><code>"+cmd+"</code></b>"}))),alertify.warning(message,30)})}}else{var clipboard=JSON.parse(text);callback&&clipboard&&clipboard.icestudio&&callback(clipboard.icestudio)}})},this.cellsToProject=function(cells,opt){var blocks=[],wires=[],p={version:common.VERSION,design:{},dependencies:{}};opt=opt||{};for(var c=0;c<cells.length;c++){var cell=cells[c];if("ice.Generic"===cell.type||"ice.Input"===cell.type||"ice.Output"===cell.type||"ice.Code"===cell.type||"ice.Info"===cell.type||"ice.Constant"===cell.type||"ice.Memory"===cell.type){var block={};block.id=cell.id,block.type=cell.blockType,block.data=cell.data,block.position=cell.position,"ice.Generic"!==cell.type&&"ice.Code"!==cell.type&&"ice.Info"!==cell.type&&"ice.Memory"!==cell.type||(block.size=cell.size),blocks.push(block)}else if("ice.Wire"===cell.type){var wire={};wire.source={block:cell.source.id,port:cell.source.port},wire.target={block:cell.target.id,port:cell.target.port},wire.vertices=cell.vertices,wire.size=cell.size>1?cell.size:void 0,wires.push(wire)}}if(p.design.board=common.selectedBoard.name,p.design.graph={blocks:blocks,wires:wires},!1!==opt.deps){var types=this.findSubDependencies(p,common.allDependencies);for(var t in types)p.dependencies[types[t]]=common.allDependencies[types[t]]}return p},this.findSubDependencies=function(dependency){var subDependencies=[];if(dependency){var blocks=dependency.design.graph.blocks;for(var i in blocks){var type=blocks[i].type;if(-1===type.indexOf("basic.")){subDependencies.push(type);var newSubDependencies=this.findSubDependencies(common.allDependencies[type]);subDependencies=subDependencies.concat(newSubDependencies)}}return _.unique(subDependencies)}return subDependencies},this.hasInputRule=function(port,apply){apply=void 0===apply||apply;var _default,rules=common.selectedBoard.rules;if(rules){var allInitPorts=rules.input;if(allInitPorts)for(var i in allInitPorts)if(port===allInitPorts[i].port){_default=allInitPorts[i],_default.apply=apply;break}}return _.clone(_default)},this.hasLeftButton=function(evt){return 1===evt.which},this.hasMiddleButton=function(evt){return 2===evt.which},this.hasRightButton=function(evt){return 3===evt.which},this.hasButtonPressed=function(evt){return 0!==evt.which},this.hasShift=function(evt){return evt.shiftKey},this.hasCtrl=function(evt){return evt.ctrlKey},this.loadProfile=function(profile,callback){profile.load(function(){callback&&callback()})},this.loadLanguage=function(profile,callback){var lang=profile.get("language");lang?this.setLocale(lang,callback):nodeLangInfo(function(err,sysLang){err||profile.set("language",this.setLocale(sysLang,callback))}.bind(this))},this.digestId=function(id){return-1!==id.indexOf("-")&&(id=nodeSha1(id).toString()),"v"+id.substring(0,6)},this.beginBlockingTask=function(){angular.element("#menu").addClass("is-disabled"),$("body").addClass("waiting")},this.endBlockingTask=function(){angular.element("#menu").removeClass("is-disabled"),$("body").removeClass("waiting")}});